\documentclass[numbers=enddot,12pt,final,onecolumn,notitlepage]{scrartcl}%
\usepackage[headsepline,footsepline,manualmark]{scrlayer-scrpage}
\usepackage[all,cmtip]{xy}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{framed}
\usepackage{amsmath}
\usepackage{comment}
\usepackage{color}
\usepackage[breaklinks=true]{hyperref}
\usepackage[sc]{mathpazo}
\usepackage[T1]{fontenc}
\usepackage{amsthm}
\usepackage{needspace}
\usepackage{allrunes}
%TCIDATA{OutputFilter=latex2.dll}
%TCIDATA{Version=5.50.0.2960}
%TCIDATA{LastRevised=Monday, October 09, 2017 19:30:12}
%TCIDATA{SuppressPackageManagement}
%TCIDATA{<META NAME="GraphicsSave" CONTENT="32">}
%TCIDATA{<META NAME="SaveForMode" CONTENT="1">}
%TCIDATA{BibliographyScheme=Manual}
%BeginMSIPreambleData
\providecommand{\U}[1]{\protect\rule{.1in}{.1in}}
%EndMSIPreambleData
\theoremstyle{definition}
\newtheorem{theo}{Theorem}[section]
\newenvironment{theorem}[1][]
{\begin{theo}[#1]\begin{leftbar}}
{\end{leftbar}\end{theo}}
\newtheorem{lem}[theo]{Lemma}
\newenvironment{lemma}[1][]
{\begin{lem}[#1]\begin{leftbar}}
{\end{leftbar}\end{lem}}
\newtheorem{prop}[theo]{Proposition}
\newenvironment{proposition}[1][]
{\begin{prop}[#1]\begin{leftbar}}
{\end{leftbar}\end{prop}}
\newtheorem{defi}[theo]{Definition}
\newenvironment{definition}[1][]
{\begin{defi}[#1]\begin{leftbar}}
{\end{leftbar}\end{defi}}
\newtheorem{remk}[theo]{Remark}
\newenvironment{remark}[1][]
{\begin{remk}[#1]\begin{leftbar}}
{\end{leftbar}\end{remk}}
\newtheorem{coro}[theo]{Corollary}
\newenvironment{corollary}[1][]
{\begin{coro}[#1]\begin{leftbar}}
{\end{leftbar}\end{coro}}
\newtheorem{conv}[theo]{Convention}
\newenvironment{convention}[1][]
{\begin{conv}[#1]\begin{leftbar}}
{\end{leftbar}\end{conv}}
\newtheorem{quest}[theo]{Question}
\newenvironment{question}[1][]
{\begin{quest}[#1]\begin{leftbar}}
{\end{leftbar}\end{quest}}
\newtheorem{warn}[theo]{Warning}
\newenvironment{warning}[1][]
{\begin{warn}[#1]\begin{leftbar}}
{\end{leftbar}\end{warn}}
\newtheorem{conj}[theo]{Conjecture}
\newenvironment{conjecture}[1][]
{\begin{conj}[#1]\begin{leftbar}}
{\end{leftbar}\end{conj}}
\newtheorem{exmp}[theo]{Example}
\newenvironment{example}[1][]
{\begin{exmp}[#1]\begin{leftbar}}
{\end{leftbar}\end{exmp}}
\newenvironment{statement}{\begin{quote}}{\end{quote}}
\iffalse
\newenvironment{proof}[1][Proof]{\noindent\textbf{#1.} }{\ \rule{0.5em}{0.5em}}
\newenvironment{convention}[1][Convention]{\noindent\textbf{#1.} }{\ \rule{0.5em}{0.5em}}
\newenvironment{warning}[1][Warning]{\noindent\textbf{#1.} }{\ \rule{0.5em}{0.5em}}
\newenvironment{question}[1][Question]{\noindent\textbf{#1.} }{\ \rule{0.5em}{0.5em}}
\fi
\newenvironment{verlong}{}{}
\newenvironment{vershort}{}{}
\newenvironment{noncompile}{}{}
\excludecomment{verlong}
\includecomment{vershort}
\excludecomment{noncompile}
\newcommand{\id}{\operatorname{id}}
\newcommand{\ev}{\operatorname{ev}}
\newcommand{\Comp}{\operatorname{Comp}}
\newcommand{\QSym}{\operatorname{QSym}_{\mathbf{k}}}
\newcommand{\QSYM}{\operatorname{QSYM}_{\mathbf{k}}}
\newcommand{\Powser}{\mathbf{k}\left[\left[x_1,x_2,x_3,\ldots\right]\right]}
\newcommand{\bdd}{\operatorname{bdd}}
\newcommand{\Bdd}{\Powser_{\bdd}}
\newcommand{\bD}{\mathbf{D}}
\newcommand{\bk}{\mathbf{k}}
\newcommand{\Nplus}{\mathbb{N}_{+}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\tvi}{\left. \textarm{\tvimadur} \right.}
\newcommand{\bel}{\left. \textarm{\belgthor} \right.}
\newcommand{\are}{\ar@{-}}
\iffalse
\NOEXPAND{\tvi}{\left. \textarm{\tvimadur} \right.}
\NOEXPAND{\bel}{\left. \textarm{\belgthor} \right.}
\fi
\newcommand\arxiv[1]{\href{http://www.arxiv.org/abs/#1}{\texttt{arXiv:#1}}}
\let\sumnonlimits\sum
\let\prodnonlimits\prod
\renewcommand{\sum}{\sumnonlimits\limits}
\renewcommand{\prod}{\prodnonlimits\limits}
\setlength\textheight{22.5cm}
\setlength\textwidth{15cm}
\begin{document}

\title{Shuffle-compatible permutation statistics II: the exterior peak set}
\author{Darij Grinberg}
\date{\today}
\maketitle
\tableofcontents

\section*{***}

This draft is a continuation of
\href{http://lanl.arxiv.org/abs/1706.00750v1}{the preprint \textquotedblleft
Shuffle-compatible permutation statistics\textquotedblright\ by Ira M. Gessel
and Yan Zhuang (\cite{part1})}.

All of the following is a rough draft, and proofs are merely outlined.

\subsection*{Acknowledgments}

We thank Yan Zhuang and Ira Gessel for helpful conversations and a few
corrections. The SageMath computer algebra system \cite{SageMath} has been
used in finding some of the results below.

\section{Notations and definitions}

Let us first introduce the definitions and notations that we will use in the
rest of this paper. Many of these definitions appear in \cite{part1} already;
we have tried to deviate from the notations of \cite{part1} as little as possible.

\subsection{Permutations and other basic concepts}

\begin{definition}
We let $\mathbb{N}=\left\{  0,1,2,3,\ldots\right\}  $ and $\mathbb{P}=\left\{
1,2,3,\ldots\right\}  $. Both of these sets are understood to be equipped with
their standard total order.
\end{definition}

\begin{definition}
Let $n\in\mathbb{Z}$. We shall use the notation $\left[  n\right]  $ for the
totally ordered set $\left\{  1,2,\ldots,n\right\}  $ (with the usual order
relation inherited from $\mathbb{Z}$). Note that $\left[  n\right]
=\varnothing$ when $n\leq0$.
\end{definition}

\begin{definition}
\label{def.perm}Let $n\in\mathbb{N}$. An $n$\textit{-permutation} shall mean a
word with $n$ letters, which are distinct and belong to $\mathbb{P}$.
Equivalently, an $n$-permutation shall be regarded as an injective map
$\left[  n\right]  \rightarrow\mathbb{P}$ (the image of $i$ under this map
being the $i$-th letter of the word).
\end{definition}

For example, $\left(  3,6,4\right)  $ and $\left(  9,1,2\right)  $ are
$3$-permutations, but $\left(  2,1,2\right)  $ is not.

\begin{definition}
A \textit{permutation} is defined to be an $n$-permutation for some
$n\in\mathbb{N}$. If $\pi$ is an $n$-permutation for some $n\in\mathbb{N}$,
then the number $n$ is called the \textit{size} (or \textit{length}) of the
permutation $\pi$ and is denoted by $\left\vert \pi\right\vert $. A
permutation is said to be \textit{nonempty} if it is nonempty as a word (i.e.,
if its size is $>0$).
\end{definition}

Note that the meaning of \textquotedblleft permutation\textquotedblright\ we
have just defined is slightly unusual (most authors define a permutation to be
a bijection from a set to itself); we are following \cite{part1} in defining
permutations this way.

\begin{definition}
Let $n\in\mathbb{N}$. Two $n$-permutations $\alpha$ and $\beta$ are said to be
\textit{order-equivalent} if they have the following property: For every two
integers $i,j\in\left[  n\right]  $, we have $\alpha\left(  i\right)
<\alpha\left(  j\right)  $ if and only if $\beta\left(  i\right)
<\beta\left(  j\right)  $.
\end{definition}

\begin{definition}
\textbf{(a)} A \textit{permutation statistic} is a map $\operatorname*{st}$
from the set of all permutations to an arbitrary set that has the following
property: Whenever $\alpha$ and $\beta$ are two order-equivalent permutations,
we have $\operatorname*{st}\left(  \alpha\right)  =\operatorname*{st}\left(
\beta\right)  $.

\textbf{(b)} Let $\operatorname*{st}$ be a permutation statistic. Two
permutations $\alpha$ and $\beta$ are said to be $\operatorname*{st}%
$\textit{-equivalent} if they satisfy $\left\vert \alpha\right\vert
=\left\vert \beta\right\vert $ and $\operatorname*{st}\alpha
=\operatorname*{st}\beta$. The relation \textquotedblleft$\operatorname*{st}%
$-equivalent\textquotedblright\ is an equivalence relation; its equivalence
classes are called $\operatorname*{st}$\textit{-equivalence classes}.
\end{definition}

\subsection{Compositions}

\begin{definition}
A \textit{composition} is a finite list of positive integers. If $I=\left(
i_{1},i_{2},\ldots,i_{n}\right)  $ is a composition, then the nonnegative
integer $i_{1}+i_{2}+\cdots+i_{n}$ is called the \textit{size} of $I$ and is
denoted by $\left\vert I\right\vert $; we furthermore say that $I$ is a
\textit{composition of }$\left\vert I\right\vert $.
\end{definition}

\begin{definition}
\label{def.comps-to-sets}Let $n\in\mathbb{N}$. For each composition $I=\left(
i_{1},i_{2},\ldots,i_{k}\right)  $ of $n$, we define a subset
$\operatorname*{Des}I$ of $\left[  n-1\right]  $ by%
\begin{align*}
\operatorname*{Des}I  &  =\left\{  i_{1},i_{1}+i_{2},i_{1}+i_{2}+i_{3}%
,\ldots,i_{1}+i_{2}+\cdots+i_{k-1}\right\} \\
&  =\left\{  i_{1}+i_{2}+\cdots+i_{s}\ \mid\ s\in\left[  k-1\right]  \right\}
.
\end{align*}


On the other hand, for each subset $A=\left\{  a_{1}<a_{2}<\cdots
<a_{k}\right\}  $ of $\left[  n-1\right]  $, we define a composition
$\operatorname*{Comp}A$ of $n$ by%
\[
\operatorname*{Comp}A=\left(  a_{1},a_{2}-a_{1},a_{3}-a_{2},\ldots
,a_{k}-a_{k-1},n-a_{k}\right)  .
\]
(The definition of $\operatorname*{Comp}A$ should be understood to give
$\operatorname*{Comp}A=\left(  n\right)  $ if $A=\varnothing$. Note that
$\operatorname*{Comp}A$ depends not only on the set $A$ itself, but also on
$n$. We hope that $n$ will always be clear from the context when we use this notation.)

We thus have defined a map $\operatorname*{Des}$ (from the set of all
compositions of $n$ to the set of all subsets of $\left[  n-1\right]  $) and a
map $\operatorname*{Comp}$ (in the opposite direction). These two maps are
mutually inverse bijections.
\end{definition}

\begin{definition}
\label{def.Des-et-al}Let $n\in\mathbb{N}$. Let $\pi=\left(  \pi_{1},\pi
_{2},\ldots,\pi_{n}\right)  $ be an $n$-permutation.

\textbf{(a)} The \textit{descents} of $\pi$ are the elements $i\in\left[
n-1\right]  $ satisfying $\pi_{i}>\pi_{i+1}$.

\textbf{(b)} The \textit{descent set} of $\pi$ is defined to be the set of all
descents of $\pi$. This set is denoted by $\operatorname*{Des}\pi$, and is
always a subset of $\left[  n-1\right]  $.

\textbf{(c)} The \textit{descent composition} of $\pi$ is defined to be the
composition $\operatorname*{Comp}\left(  \operatorname*{Des}\pi\right)  $ of
$n$. This composition is denoted by $\operatorname*{Comp}\pi$.

\textbf{(d)} The \textit{peaks} of $\pi$ are the elements $i\in\left\{
2,3,\ldots,n-1\right\}  $ satisfying $\pi_{i-1}<\pi_{i}>\pi_{i+1}$.

\textbf{(e)} The \textit{peak set} of $\pi$ is defined to be the set of all
peaks of $\pi$. This set is denoted by $\operatorname*{Pk}\pi$, and is always
a subset of $\left\{  2,3,\ldots,n-1\right\}  $.

\textbf{(f)} The \textit{left peaks} of $\pi$ are the elements $i\in\left[
n-1\right]  $ satisfying $\pi_{i-1}<\pi_{i}>\pi_{i+1}$, where we set $\pi
_{0}=0$.

\textbf{(g)} The \textit{left peak set} of $\pi$ is defined to be the set of
all left peaks of $\pi$. This set is denoted by $\operatorname*{Lpk}\pi$, and
is always a subset of $\left[  n-1\right]  $. It is easy to see that (for
$n\geq2$) we have%
\[
\operatorname*{Lpk}\pi=\operatorname*{Pk}\pi\cup\left\{  1\ \mid\ \pi_{1}%
>\pi_{2}\right\}  .
\]
(Of course, $\left\{  1\ \mid\ \pi_{1}>\pi_{2}\right\}  $ is the $1$-element
set $\left\{  1\right\}  $ if $\pi_{1}>\pi_{2}$, and the empty set
$\varnothing$ otherwise.)

\textbf{(h)} The \textit{right peaks} of $\pi$ are the elements $i\in\left\{
2,3,\ldots,n\right\}  $ satisfying $\pi_{i-1}<\pi_{i}>\pi_{i+1}$, where we set
$\pi_{n+1}=0$.

\textbf{(i)} The \textit{right peak set} of $\pi$ is defined to be the set of
all right peaks of $\pi$. This set is denoted by $\operatorname*{Rpk}\pi$, and
is always a subset of $\left\{  2,3,\ldots,n\right\}  $. It is easy to see
that (for $n\geq2$) we have%
\[
\operatorname*{Rpk}\pi=\operatorname*{Pk}\pi\cup\left\{  n\ \mid\ \pi
_{n-1}<\pi_{n}\right\}  .
\]


\textbf{(j)} The \textit{exterior peaks} of $\pi$ are the elements
$i\in\left[  n\right]  $ satisfying $\pi_{i-1}<\pi_{i}>\pi_{i+1}$, where we
set $\pi_{0}=0$ and $\pi_{n+1}=0$.

\textbf{(k)} The \textit{exterior peak set} of $\pi$ is defined to be the set
of all exterior peaks of $\pi$. This set is denoted by $\operatorname*{Epk}%
\pi$, and is always a subset of $\left[  n\right]  $. It is easy to see that
(for $n\geq2$) we have%
\begin{align*}
\operatorname*{Epk}\pi &  =\operatorname*{Pk}\pi\cup\left\{  1\ \mid\ \pi
_{1}>\pi_{2}\right\}  \cup\left\{  n\ \mid\ \pi_{n-1}<\pi_{n}\right\} \\
&  =\operatorname*{Lpk}\pi\cup\operatorname*{Rpk}\pi.
\end{align*}
(For $n=1$, we have $\operatorname*{Epk}\pi=\left\{  1\right\}  $.)
\end{definition}

For example, the $6$-permutation $\pi=\left(  4,1,3,9,6,8\right)  $ has%
\begin{align*}
\operatorname*{Des}\pi &  =\left\{  1,4\right\}
,\ \ \ \ \ \ \ \ \ \ \operatorname*{Comp}\pi=\left(  1,3,2\right)
,\ \ \ \ \ \ \ \ \ \ \operatorname*{Pk}\pi=\left\{  4\right\}  ,\\
\operatorname*{Lpk}\pi &  =\left\{  1,4\right\}
,\ \ \ \ \ \ \ \ \ \ \operatorname*{Rpk}\pi=\left\{  4,6\right\}
,\ \ \ \ \ \ \ \ \ \ \operatorname*{Epk}\pi=\left\{  1,4,6\right\}  .
\end{align*}
For another example, the $6$-permutation $\pi=\left(  1,4,3,2,9,8\right)  $
has%
\begin{align*}
\operatorname*{Des}\pi &  =\left\{  2,3,5\right\}
,\ \ \ \ \ \ \ \ \ \ \operatorname*{Comp}\pi=\left(  2,1,2,1\right)
,\ \ \ \ \ \ \ \ \ \ \operatorname*{Pk}\pi=\left\{  2,5\right\}  ,\\
\operatorname*{Lpk}\pi &  =\left\{  2,5\right\}
,\ \ \ \ \ \ \ \ \ \ \operatorname*{Rpk}\pi=\left\{  2,5\right\}
,\ \ \ \ \ \ \ \ \ \ \operatorname*{Epk}\pi=\left\{  2,5\right\}  .
\end{align*}


Notice that Definition \ref{def.Des-et-al} actually defines several
permutation statistics. For example, Definition \ref{def.Des-et-al}
\textbf{(b)} defines the permutation statistic $\operatorname*{Des}$, whose
codomain is the set of all subsets of $\mathbb{P}$. Also, Definition
\ref{def.Des-et-al} \textbf{(c)} defines the permutation statistic
$\operatorname*{Comp}$, whose codomain is the set of all compositions. The
main permutation statistic that we will study in this paper is
$\operatorname*{Epk}$, which is defined in Definition \ref{def.Des-et-al}
\textbf{(k)}; its codomain is the set of all subsets of $\mathbb{P}$.

\subsection{Shuffles and shuffle-compatibility}

\begin{definition}
Let $\pi$ and $\sigma$ be two permutations.

\textbf{(a)} We say that $\pi$ and $\sigma$ are \textit{disjoint} if no letter
appears in both $\pi$ and $\sigma$.

\textbf{(b)} Assume that $\pi$ and $\sigma$ are disjoint. Set $m=\left\vert
\pi\right\vert $ and $n=\left\vert \sigma\right\vert $. Let $\tau$ be an
$\left(  m+n\right)  $-permutation. Then, we say that $\tau$ is a
\textit{shuffle} of $\pi$ and $\sigma$ if both $\pi$ and $\sigma$ appear as
subsequences of $\tau$.

\textbf{(c)} We let $S\left(  \pi,\sigma\right)  $ be the set of all shuffles
of $\pi$ and $\sigma$.
\end{definition}

For example, the permutations $\left(  3,1\right)  $ and $\left(
6,2,9\right)  $ are disjoint, whereas the permutations $\left(  3,2\right)  $
and $\left(  6,2,9\right)  $ are not. The shuffles of the two disjoint
permutations $\left(  3,1\right)  $ and $\left(  2,6\right)  $ are%
\begin{align*}
&  \left(  3,1,2,6\right)  ,\ \ \ \ \ \ \ \ \ \ \left(  3,2,1,6\right)
,\ \ \ \ \ \ \ \ \ \ \left(  3,2,6,1\right)  ,\\
&  \left(  2,3,1,6\right)  ,\ \ \ \ \ \ \ \ \ \ \left(  2,3,6,1\right)
,\ \ \ \ \ \ \ \ \ \ \left(  2,6,3,1\right)  .
\end{align*}


If $\pi$ and $\sigma$ are two disjoint permutations, then $S\left(  \pi
,\sigma\right)  =S\left(  \sigma,\pi\right)  $ is an $\dbinom{m+n}{m}$-element
set, where $m=\left\vert \pi\right\vert $ and $n=\left\vert \sigma\right\vert
$.

\begin{definition}
Let $\operatorname*{st}$ be a permutation statistic. We say that
$\operatorname*{st}$ is \textit{shuffle-compatible} if and only if it has the
following property: For any two disjoint permutations $\pi$ and $\sigma$, the
multiset%
\[
\left\{  \operatorname*{st}\left(  \tau\right)  \ \mid\ \tau\in S\left(
\pi,\sigma\right)  \right\}
\]
depends only on $\operatorname*{st}\left(  \pi\right)  $, $\operatorname*{st}%
\left(  \sigma\right)  $, $\left\vert \pi\right\vert $ and $\left\vert
\sigma\right\vert $.
\end{definition}

\subsection{Descent statistics}

\begin{definition}
Let $\operatorname*{st}$ be a permutation statistic. We say that
$\operatorname*{st}$ is a \textit{descent statistic} if and only if
$\operatorname*{st}\pi$ (for $\pi$ a permutation) depends only on the descent
composition $\operatorname*{Comp}\pi$ of $\pi$. In other words,
$\operatorname*{st}$ is a descent statistic if and only if every two
permutations $\pi$ and $\sigma$ satisfying $\operatorname*{Comp}%
\pi=\operatorname*{Comp}\sigma$ satisfy $\operatorname*{st}\pi
=\operatorname*{st}\sigma$.
\end{definition}

Equivalently, a permutation statistic $\operatorname*{st}$ is a descent
statistic if and only if every two permutations $\pi$ and $\sigma$ satisfying
$\left\vert \pi\right\vert =\left\vert \sigma\right\vert $ and
$\operatorname*{Des}\pi=\operatorname*{Des}\sigma$ satisfy $\operatorname*{st}%
\pi=\operatorname*{st}\sigma$. (This is indeed equivalent, because for two
permutations $\pi$ and $\sigma$, the condition $\left(  \left\vert
\pi\right\vert =\left\vert \sigma\right\vert \text{ and }\operatorname*{Des}%
\pi=\operatorname*{Des}\sigma\right)  $ is equivalent to $\left(
\operatorname*{Comp}\pi=\operatorname*{Comp}\sigma\right)  $.)

For example, the permutation statistic $\operatorname*{Des}$ is a descent
statistic, because each permutation $\pi$ satisfies $\operatorname*{Des}%
\pi=\operatorname*{Des}\left(  \operatorname*{Comp}\pi\right)  $. Also,
$\operatorname*{Pk}$ is a descent statistic, since each permutation $\pi$
satisfies%
\[
\operatorname*{Pk}\pi=\left(  \operatorname*{Des}\pi\right)  \setminus\left(
\left\{  1\right\}  \cup\left(  \operatorname*{Des}\pi+1\right)  \right)  ,
\]
where $\operatorname*{Des}\pi+1$ denotes the set $\left\{  i+1\ \mid
\ i\in\operatorname*{Des}\pi\right\}  $ (and, as we have just said,
$\operatorname*{Des}\pi$ can be recovered from $\operatorname*{Comp}\pi$).
Furthermore, $\operatorname*{Epk}$ is a descent statistic, since each
$n$-permutation $\pi$ (for $n\in\mathbb{N}$) satisfies%
\[
\operatorname*{Epk}\pi=\left(  \operatorname*{Des}\pi\cup\left\{  n\right\}
\right)  \setminus\left(  \operatorname*{Des}\pi+1\right)
\]
(and both $\operatorname*{Des}\pi$ and $n$ can be recovered from
$\operatorname*{Comp}\pi$). The permutation statistics $\operatorname*{Lpk}$
and $\operatorname*{Rpk}$ (and, of course, $\operatorname*{Comp}$) are descent
statistics as well, as one can easily check.

\begin{definition}
\label{def.des-stat.stI}Let $\operatorname*{st}$ be a descent statistic. Then,
we can regard $\operatorname*{st}$ as a map from the set of all compositions
(rather than from the set of all permutations). Namely, for any composition
$I$, we define $\operatorname*{st}I$ (an element of the codomain of
$\operatorname*{st}$) by setting%
\[
\operatorname*{st}I=\operatorname*{st}\pi\ \ \ \ \ \ \ \ \ \ \text{for any
permutation }\pi\text{ satisfying }\operatorname*{Comp}\pi=I.
\]
This is well-defined (because for every composition $I$, there exists at least
one permutation $\pi$ satisfying $\operatorname*{Comp}\pi=I$, and all such
permutations $\pi$ have the same value of $\operatorname*{st}\pi$). In the
following, we shall regard every descent statistic $\operatorname*{st}$
simultaneously as a map from the set of all permutations and as a map from the
set of all compositions.
\end{definition}

Note that this definition leads to a new interpretation of
$\operatorname*{Des}I$ for a composition $I$: It is now defined as
$\operatorname*{Des}\pi$ for any permutation $\pi$ satisfying
$\operatorname*{Comp}\pi=I$. This could clash with the old meaning of
$\operatorname*{Des}I$ introduced in Definition \ref{def.comps-to-sets}.
Fortunately, these two meanings of $\operatorname*{Des}I$ are exactly the
same, so there is no conflict of notation.

\begin{definition}
\label{def.des-stat.eq-comp}Let $\operatorname*{st}$ be a descent statistic.

\textbf{(a)} Two compositions $J$ and $K$ are said to be $\operatorname*{st}%
$\textit{-equivalent} if and only if they have the same size and satisfy
$\operatorname*{st}J=\operatorname*{st}K$. Equivalently, two compositions $J$
and $K$ are $\operatorname*{st}$-equivalent if and only if there exist two
$\operatorname*{st}$-equivalent permutations $\pi$ and $\sigma$ satisfying
$J=\operatorname*{Comp}\pi$ and $K=\operatorname*{Comp}\sigma$.

\textbf{(b)} The relation \textquotedblleft$\operatorname*{st}$%
-equivalent\textquotedblright\ is an equivalence relation on compositions; its
equivalence classes are called $\operatorname*{st}$\textit{-equivalence
classes of compositions}.
\end{definition}

\subsection{Quasisymmetric functions}

We now recall the definition of quasisymmetric functions; see \cite[Chapter
5]{HopfComb} (and various other modern textbooks) for more details about this:

\begin{definition}
Consider the ring of power series $\mathbb{Q}\left[  \left[  x_{1},x_{2}%
,x_{3},\ldots\right]  \right]  $ in infinitely many commuting indeterminates
over $\mathbb{Q}$. A power series $f\in\mathbb{Q}\left[  \left[  x_{1}%
,x_{2},x_{3},\ldots\right]  \right]  $ is said to be \textit{quasisymmetric}
if it has the following property: For any positive integers $a_{1}%
,a_{2},\ldots,a_{k}$ and any two strictly increasing sequences $\left(
i_{1}<i_{2}<\cdots<i_{k}\right)  $ and $\left(  j_{1}<j_{2}<\cdots
<j_{k}\right)  $ of positive integers, the coefficient of $x_{i_{1}}^{a_{1}%
}x_{i_{2}}^{a_{2}}\cdots x_{i_{k}}^{a_{k}}$ in $f$ equals the coefficient of
$x_{j_{1}}^{a_{1}}x_{j_{2}}^{a_{2}}\cdots x_{j_{k}}^{a_{k}}$ in $f$. A
\textit{quasisymmetric function} is a quasisymmetric power series
$f\in\mathbb{Q}\left[  \left[  x_{1},x_{2},x_{3},\ldots\right]  \right]  $
that has bounded degree (i.e., there exists an $N\in\mathbb{N}$ such that each
monomial appearing in $f$ has degree $\leq N$). The quasisymmetric functions
form a $\mathbb{Q}$-subalgebra of $\mathbb{Q}\left[  \left[  x_{1},x_{2}%
,x_{3},\ldots\right]  \right]  $; this $\mathbb{Q}$-subalgebra is denoted by
$\operatorname*{QSym}$ and called the \textit{ring of quasisymmetric
functions} over $\mathbb{Q}$.
\end{definition}

The $\mathbb{Q}$-algebra $\operatorname*{QSym}$ has much interesting structure
(e.g., it is a Hopf algebra), but we will need very little of it (and we will
introduce it whenever it becomes important). One simple yet crucial feature of
$\operatorname*{QSym}$ that we will immediately use is the \textit{fundamental
basis} of $\operatorname*{QSym}$:

\begin{definition}
For any composition $\alpha$, we define the \textit{fundamental quasisymmetric
function} $F_{\alpha}$ to be the power series%
\[
\sum_{\substack{i_{1}\leq i_{2}\leq\cdots\leq i_{n};\\i_{j}<i_{j+1}\text{ for
each }j\in\operatorname*{Des}\alpha}}x_{i_{1}}x_{i_{2}}\cdots x_{i_{n}}%
\in\operatorname*{QSym},
\]
where $n=\left\vert \alpha\right\vert $ is the size of $\alpha$. The family
$\left(  F_{\alpha}\right)  _{\alpha\text{ is a composition}}$ is a basis of
the $\mathbb{Q}$-vector space $\operatorname*{QSym}$; it is known as the
\textit{fundamental basis} of $\operatorname*{QSym}$.
\end{definition}

We notice that the fundamental quasisymmetric function $F_{\alpha}$ is denoted
by $L_{\alpha}$ in \cite[\S 5.2]{HopfComb}.

The multiplication of fundamental quasisymmetric functions is intimately
related to shuffles of permutations:

\begin{theorem}
\label{thm.4.1}Let $\pi$ and $\sigma$ be two disjoint permutations. Let
$J=\operatorname*{Comp}\pi$ and $K=\operatorname*{Comp}\sigma$. For any
composition $L$, let $c_{J,K}^{L}$ be the number of permutations with descent
composition $L$ among the shuffles of $\pi$ and $\sigma$. Then,%
\[
F_{J}F_{K}=\sum_{L}c_{J,K}^{L}F_{L}%
\]
(where the sum is over all compositions $L$).
\end{theorem}

Theorem \ref{thm.4.1} is \cite[Theorem 4.1]{part1}; it can also be written in
the following form:

\begin{proposition}
\label{prop.4.1.rewr}Let $\pi$ and $\sigma$ be two disjoint permutations.
Then,%
\[
F_{\operatorname*{Comp}\pi}F_{\operatorname*{Comp}\sigma}=\sum_{\chi\in
S\left(  \pi,\sigma\right)  }F_{\operatorname*{Comp}\chi}.
\]

\end{proposition}

For a proof of Proposition \ref{prop.4.1.rewr} (and therefore also of the
equivalent Theorem \ref{thm.4.1}), we refer to \cite[(5.2.6)]{HopfComb} (which
makes the additional requirement that the letters of $\pi$ are $1,2,\ldots
,\left\vert \pi\right\vert $ and the letters of $\sigma$ are $\left\vert
\pi\right\vert +1,\left\vert \pi\right\vert +2,\ldots,\left\vert
\pi\right\vert +\left\vert \sigma\right\vert $; but this requirement is not
used in the proof and thus can be dropped).

\subsection{Shuffle algebras}

Any shuffle-compatible permutation statistic $\operatorname*{st}$ gives rise
to a \textit{shuffle algebra} $\mathcal{A}_{\operatorname*{st}}$, defined as follows:

\begin{definition}
\label{def.Ast}Let $\operatorname*{st}$ be a shuffle-compatible permutation
statistic. For each permutation $\pi$, let $\left[  \pi\right]
_{\operatorname*{st}}$ denote the $\operatorname*{st}$-equivalence class of
$\pi$.

Let $\mathcal{A}_{\operatorname*{st}}$ be the free $\mathbb{Q}$-vector space
whose basis is the set of all $\operatorname*{st}$-equivalence classes of
permutations. We define a multiplication on $\mathcal{A}_{\operatorname*{st}}$
by setting%
\[
\left[  \pi\right]  _{\operatorname*{st}}\left[  \sigma\right]
_{\operatorname*{st}}=\sum_{\tau\in S\left(  \pi,\sigma\right)  }\left[
\tau\right]  _{\operatorname*{st}}%
\]
for any two disjoint permutations $\pi$ and $\sigma$. It is easy to see that
this multiplication is well-defined and associative, and turns $\mathcal{A}%
_{\operatorname*{st}}$ into a $\mathbb{Q}$-algebra whose unity is the
$\operatorname*{st}$-equivalence class of the empty permutation. This
$\mathbb{Q}$-algebra is denoted by $\mathcal{A}_{\operatorname*{st}}$, and is
called the \textit{shuffle algebra} of $\operatorname*{st}$. It is a graded
$\mathbb{Q}$-algebra; its $n$-th graded component (for each $n\in\mathbb{N}$)
is spanned by the $\operatorname*{st}$-equivalence classes of all $n$-permutations.
\end{definition}

A central property of the shuffle algebra $\mathcal{A}_{\operatorname*{st}}$
of a shuffle-compatible descent statistic is its relation to
$\operatorname*{QSym}$. This relation is given by \cite[Theorem 4.3]{part1},
which we restate as follows:

\begin{theorem}
\label{thm.4.3}Let $\operatorname*{st}$ be a descent statistic.

\textbf{(a)} The descent statistic $\operatorname*{st}$ is shuffle-compatible
if and only if there exist a $\mathbb{Q}$-algebra $A$ with basis $\left(
u_{\alpha}\right)  $ (indexed by $\operatorname*{st}$-equivalence classes
$\alpha$ of compositions) and a $\mathbb{Q}$-algebra homomorphism
$\phi_{\operatorname*{st}}:\operatorname*{QSym}\rightarrow A$ with the
property that whenever $\alpha$ is an $\operatorname*{st}$-equivalence class
of compositions, we have%
\[
\phi_{\operatorname*{st}}\left(  F_{L}\right)  =u_{\alpha}%
\ \ \ \ \ \ \ \ \ \ \text{for each }L\in\alpha.
\]


\textbf{(b)} In this case, the $\mathbb{Q}$-linear map%
\[
\mathcal{A}_{\operatorname*{st}}\rightarrow A,\ \ \ \ \ \ \ \ \ \ \left[
\pi\right]  _{\operatorname*{st}}\mapsto u_{\alpha},
\]
where $\alpha$ is the $\operatorname*{st}$-equivalence class of the
composition $\operatorname*{Comp}\pi$, is a $\mathbb{Q}$-algebra isomorphism
$\mathcal{A}_{\operatorname*{st}}\rightarrow A$.
\end{theorem}

We shall perhaps also use some other notations that were introduced in
\cite{part1}. The reader should thus consult \cite{part1} for unexplained notations.

\section{Extending enriched $P$-partitions and the exterior peak set}

We are going to define \textit{$\mathcal{Z}$-enriched }$P$\textit{-partitions}%
, which are a straightforward generalization of the notions of
\textquotedblleft$P$-partitions\textquotedblright, \textquotedblleft enriched
$P$-partitions\textquotedblright\ and \textquotedblleft left enriched
$P$-partitions\textquotedblright. We will then consider a new particular case
of this notion, which leads to a proof of the shuffle-compatibility of
$\operatorname*{Epk}$ conjectured in \cite{part1}.

\subsection{\label{subsect.Zenri.gen}$\mathcal{Z}$-enriched $\left(
P,\gamma\right)  $-partitions}

\begin{convention}
By abuse of notation, we will often use the same notation for a poset
$P=\left(  X,\leq\right)  $ and its ground set $X$ when there is no danger of
confusion. In particular, if $x$ is some object, then \textquotedblleft$x\in
P$\textquotedblright\ shall mean \textquotedblleft$x\in X$\textquotedblright.
\end{convention}

\begin{definition}
A \textit{labeled poset} means a pair $\left(  P,\gamma\right)  $ consisting
of a finite poset $P=\left(  X,\leq\right)  $ and an injective map
$\gamma:X\rightarrow A$ for some set $A$. The injective map $\gamma$ is called
the \textit{labeling} of the labeled poset $\left(  P,\gamma\right)  $. The
poset $P$ is called the \textit{ground poset} of the labeled poset $\left(
P,\gamma\right)  $.
\end{definition}

\begin{convention}
Let $\mathcal{N}$ be a totally ordered set, whose (strict) order relation will
be denoted by $\prec$. Let $+$ and $-$ be two distinct symbols. Let
$\mathcal{Z}$ be a subset of the set $\mathcal{N}\times\left\{  +,-\right\}
$. For each $q=\left(  n,s\right)  \in\mathcal{Z}$, we denote the element
$n\in\mathcal{N}$ by $\left\vert q\right\vert $, and we call the element
$s\in\left\{  +,-\right\}  $ the \textit{sign} of $q$. If $n\in\mathcal{N}$,
then we will denote the two elements $\left(  n,+\right)  $ and $\left(
n,-\right)  $ of $\mathcal{N}\times\left\{  +,-\right\}  $ by $+n$ and $-n$, respectively.

Let us totally order the set $\mathcal{Z}$ in such a way that the (strict)
order relation $\prec$ satisfies%
\[
\left(  n,s\right)  \prec\left(  n^{\prime},s^{\prime}\right)  \text{ if and
only if either }n\prec n^{\prime}\text{ or }\left(  n=n^{\prime}\text{ and
}s=-\text{ and }s^{\prime}=+\right)  .
\]
Let $\operatorname*{Pow}\mathcal{N}$ be the ring of all power series over
$\mathbb{Q}$ in the indeterminates $x_{n}$ for $n\in\mathcal{N}$.

We fix $\mathcal{N}$ and $\mathcal{Z}$ throughout Subsection
\ref{subsect.Zenri.gen}. That is, any result in this subsection is tacitly
understood to begin with \textquotedblleft Let $\mathcal{N}$ be a totally
ordered set, whose (strict) order relation will be denoted by $\prec$, and let
$\mathcal{Z}$ be a subset of the set $\mathcal{N}\times\left\{  +,-\right\}
$\textquotedblright.
\end{convention}

\begin{definition}
\label{def.ambivPp}Let $\left(  P,\gamma\right)  $ be a labeled poset. A
\textit{$\mathcal{Z}$-enriched }$\left(  P,\gamma\right)  $\textit{-partition}
means a map $f:P\rightarrow\mathcal{Z}$ such that for all $x<y$ in $P$, the
following conditions hold:

\begin{enumerate}
\item[\textbf{(i)}] We have $f\left(  x\right)  \preccurlyeq f\left(
y\right)  $.

\item[\textbf{(ii)}] If $f\left(  x\right)  =f\left(  y\right)  =+n$ for some
$n\in\mathcal{N}$, then $\gamma\left(  x\right)  <\gamma\left(  y\right)  $.

\item[\textbf{(iii)}] If $f\left(  x\right)  =f\left(  y\right)  =-n$ for some
$n\in\mathcal{N}$, then $\gamma\left(  x\right)  >\gamma\left(  y\right)  $.
\end{enumerate}

(Of course, this concept depends on $\mathcal{N}$ and $\mathcal{Z}$, but these
will always be clear from the context.)
\end{definition}

\begin{example}
\label{exa.ambivPp.diamond}Let $P$ be the poset with the following Hasse
diagram:%
\[%
%TCIMACRO{\TeXButton{Hasse diagram}{\xymatrix{
%& b \are[dl] \are[dr] \\
%c \are[dr] & & d \are[dl] \\
%& a
%}}}%
%BeginExpansion
\xymatrix{
& b \are[dl] \are[dr] \\
c \are[dr] & & d \are[dl] \\
& a
}%
%EndExpansion
\]
and let $\gamma:P\rightarrow\mathbb{Z}$ be a labeling that satisfies
$\gamma\left(  a\right)  <\gamma\left(  b\right)  <\gamma\left(  c\right)
<\gamma\left(  d\right)  $ (for example, $\gamma$ could be the map that sends
$a,b,c,d$ to $2,3,5,7$, respectively). Then, a $\mathcal{Z}$-enriched $\left(
P,\gamma\right)  $-partition is a map $f:P\rightarrow\mathcal{Z}$ satisfying
the following conditions:

\begin{enumerate}
\item[\textbf{(i)}] We have $f\left(  a\right)  \preccurlyeq f\left(
c\right)  \preccurlyeq f\left(  b\right)  $ and $f\left(  a\right)
\preccurlyeq f\left(  d\right)  \preccurlyeq f\left(  b\right)  $.

\item[\textbf{(ii)}] We cannot have $f\left(  c\right)  =f\left(  b\right)
=+n$ with $n\in\mathcal{N}$. Also, we cannot have $f\left(  d\right)
=f\left(  b\right)  =+n$ with $n\in\mathcal{N}$.

\item[\textbf{(iii)}] We cannot have $f\left(  a\right)  =f\left(  c\right)
=-n$ with $n\in\mathcal{N}$. Also, we cannot have $f\left(  a\right)
=f\left(  d\right)  =-n$ with $n\in\mathcal{N}$.
\end{enumerate}

For example, if $\mathcal{N}=\mathbb{P}$ (the totally ordered set of positive
integers, with its usual ordering) and $\mathcal{Z}=\mathcal{N}\times\left\{
+,-\right\}  $, then the map $f:P\rightarrow\mathcal{Z}$ sending $a,b,c,d$ to
$+2,-3,+2,-3$ (respectively) is a $\mathcal{Z}$-enriched $\left(
P,\gamma\right)  $-partition. Notice that the total ordering on $\mathcal{Z}$
in this case is given by%
\[
-1\prec+1\prec-2\prec+2\prec-3\prec+3\prec\cdots,
\]
rather than by the familiar total order on $\mathbb{Z}$.
\end{example}

The concept of a \textquotedblleft$\mathcal{Z}$-enriched $\left(
P,\gamma\right)  $-partition\textquotedblright\ generalizes three notions in
existing literature: that of a \textquotedblleft$\left(  P,\gamma\right)
$-partition\textquotedblright, that of an \textquotedblleft enriched $\left(
P,\gamma\right)  $-partition\textquotedblright, and that of a
\textquotedblleft left enriched $\left(  P,\gamma\right)  $%
-partition\textquotedblright\footnote{The ideas behind these three concepts
are due to Stanley \cite{Stanle72}, Stembridge \cite[\S 2]{Stembr97} and
Petersen \cite{Peters05}, respectively, but the precise definitions are not
standardized through the literature. We define a \textquotedblleft$\left(
P,\gamma\right)  $-partition\textquotedblright\ as in \cite[\S 1.1]{Stembr97};
this definition differs noticeably from Stanley's (in particular, Stanley
requires $f\left(  x\right)  \succcurlyeq f\left(  y\right)  $ instead of
$f\left(  x\right)  \preccurlyeq f\left(  y\right)  $, but the differences do
not end here). We define an \textquotedblleft enriched $\left(  P,\gamma
\right)  $-partition\textquotedblright\ as in \cite[\S 2]{Stembr97}. Finally,
we define an \textquotedblleft left enriched $\left(  P,\gamma\right)
$-partition\textquotedblright\ to be a $\mathcal{Z}$-enriched $\left(
P,\gamma\right)  $-partition where $\mathcal{N}=\mathbb{N}$ and $\mathcal{Z}%
=\left(  \mathcal{N}\times\left\{  +,-\right\}  \right)  \setminus\left\{
-0\right\}  $; it does not literally appear in \cite[Definition 4.1]{Peters05}
in this form.}:

\begin{example}
\label{exa.ambivPp.abc}\textbf{(a)} If $\mathcal{N}=\mathbb{P}$ (the totally
ordered set of positive integers) and $\mathcal{Z}=\mathcal{N}\times\left\{
+\right\}  =\left\{  +n\ \mid\ n\in\mathcal{N}\right\}  $, then the
$\mathcal{Z}$-enriched $\left(  P,\gamma\right)  $-partitions are simply the
$\left(  P,\gamma\right)  $-partitions into $\mathcal{N}$, composed with the
canonical bijection $\mathcal{N}\rightarrow\mathcal{Z},\ n\mapsto\left(
+n\right)  $.

\textbf{(b)} If $\mathcal{N}=\mathbb{P}$ (the totally ordered set of positive
integers) and $\mathcal{Z}=\mathcal{N}\times\left\{  +,-\right\}  $, then the
$\mathcal{Z}$-enriched $\left(  P,\gamma\right)  $-partitions are the enriched
$\left(  P,\gamma\right)  $-partitions.

\textbf{(c)} If $\mathcal{N}=\mathbb{N}$ (the totally ordered set of
nonnegative integers) and $\mathcal{Z}=\left(  \mathcal{N}\times\left\{
+,-\right\}  \right)  \setminus\left\{  -0\right\}  $, then the $\mathcal{Z}%
$-enriched $\left(  P,\gamma\right)  $-partitions are the left enriched
$\left(  P,\gamma\right)  $-partitions. Note that $+0$ and $-0$ here stand for
the pairs $\left(  0,+\right)  $ and $\left(  0,-\right)  $; thus, they are
not the same thing.
\end{example}

\begin{definition}
If $\left(  P,\gamma\right)  $ is a labeled poset, then $\mathcal{E}\left(
P,\gamma\right)  $ shall denote the set of all $\mathcal{Z}$-enriched $\left(
P,\gamma\right)  $-partitions.
\end{definition}

\begin{definition}
If $P$ is any poset, then $\mathcal{L}\left(  P\right)  $ shall denote the set
of all linear extensions of $P$. A linear extension of $P$ shall be understood
simultaneously as a totally ordered set extending $P$ and as a list $\left(
w_{1},w_{2},\ldots,w_{n}\right)  $ of all elements of $P$ such that no two
integers $i<j$ satisfy $w_{i}\geq w_{j}$ in $P$.
\end{definition}

Let us prove some basic facts about $\mathcal{Z}$-enriched $\left(
P,\gamma\right)  $-partitions, straightforwardly generalizing classical
results proven by Stanley and Gessel (for the case of \textquotedblleft
plain\textquotedblright\ $\left(  P,\gamma\right)  $-partitions), Stembridge
(for enriched $\left(  P,\gamma\right)  $-partitions) and Petersen (for left
enriched $\left(  P,\gamma\right)  $-partitions):

\begin{proposition}
\label{prop.fund-lem}For any labeled poset $\left(  P,\gamma\right)  $, we
have%
\[
\mathcal{E}\left(  P,\gamma\right)  =\bigsqcup_{w\in\mathcal{L}\left(
P\right)  }\mathcal{E}\left(  w,\gamma\right)  .
\]

\end{proposition}

\begin{proof}
[Proof of Proposition \ref{prop.fund-lem}.]Imitate, e.g., the proof of
\cite[Lemma 2.1]{Stembr97}.
\end{proof}

\begin{definition}
\label{def.GammaZ}Let $\left(  P,\gamma\right)  $ be a labeled poset. We
define a power series $\Gamma_{\mathcal{Z}}\left(  P,\gamma\right)
\in\operatorname*{Pow}\mathcal{N}$ by%
\[
\Gamma_{\mathcal{Z}}\left(  P,\gamma\right)  =\sum_{f\in\mathcal{E}\left(
P,\gamma\right)  }\prod_{p\in P}x_{\left\vert f\left(  p\right)  \right\vert
}.
\]
This is easily seen to be convergent in the usual topology on
$\operatorname*{Pow}\mathcal{N}$.
\end{definition}

\begin{corollary}
\label{cor.fund-lem}For any labeled poset $\left(  P,\gamma\right)  $, we have%
\[
\Gamma_{\mathcal{Z}}\left(  P,\gamma\right)  =\sum_{w\in\mathcal{L}\left(
P\right)  }\Gamma_{\mathcal{Z}}\left(  w,\gamma\right)  .
\]

\end{corollary}

\begin{proof}
[Proof of Corollary \ref{cor.fund-lem}.]Follows straight from Proposition
\ref{prop.fund-lem}.
\end{proof}

\begin{definition}
Let $P$ be any set. Let $A$ be a totally ordered set. Let $\gamma:P\rightarrow
A$ and $\delta:P\rightarrow A$ be two maps. We say that $\gamma$ and $\delta$
are \textit{order-equivalent} if the following holds: For every pair $\left(
p,q\right)  \in P\times P$, we have $\gamma\left(  p\right)  \leq\gamma\left(
q\right)  $ if and only if $\delta\left(  p\right)  \leq\delta\left(
q\right)  $.
\end{definition}

\begin{proposition}
\label{prop.prod1}Let $\left(  P,\gamma\right)  $ and $\left(  Q,\delta
\right)  $ be two labeled posets. Let $\left(  P\sqcup Q,\varepsilon\right)  $
be the labeled poset whose ground poset $P\sqcup Q$ is the disjoint union of
$P$ and $Q$, and whose labeling $\varepsilon$ is such that the restriction of
$\varepsilon$ to $P$ is order-equivalent to $\gamma$ and such that the
restriction of $\varepsilon$ to $Q$ is order-equivalent to $\delta$. Then,%
\[
\Gamma_{\mathcal{Z}}\left(  P,\gamma\right)  \Gamma_{\mathcal{Z}}\left(
Q,\delta\right)  =\Gamma_{\mathcal{Z}}\left(  P\sqcup Q,\varepsilon\right)  .
\]

\end{proposition}

\begin{proof}
[Proof of Proposition \ref{prop.prod1}.]We WLOG assume that the ground sets
$P$ and $Q$ are disjoint; thus, we can identify $P\sqcup Q$ with the union
$P\cup Q$. The map%
\begin{align}
\mathcal{E}\left(  P\sqcup Q,\varepsilon\right)   &  \rightarrow
\mathcal{E}\left(  P,\gamma\right)  \times\mathcal{E}\left(  Q,\delta\right)
,\nonumber\\
f  &  \mapsto\left(  f\mid_{P},f\mid_{Q}\right)  \label{pf.prop.prod1.bij}%
\end{align}
is a bijection (this is easy to see). Now,%
\begin{align*}
\Gamma_{\mathcal{Z}}\left(  P\sqcup Q,\varepsilon\right)   &  =\sum
_{f\in\mathcal{E}\left(  P\sqcup Q,\varepsilon\right)  }\underbrace{\prod
_{p\in P\sqcup Q}x_{\left\vert f\left(  p\right)  \right\vert }}_{=\left(
\prod_{p\in P}x_{\left\vert f\left(  p\right)  \right\vert }\right)  \left(
\prod_{p\in Q}x_{\left\vert f\left(  p\right)  \right\vert }\right)  }%
=\sum_{f\in\mathcal{E}\left(  P\sqcup Q,\varepsilon\right)  }\left(
\prod_{p\in P}x_{\left\vert f\left(  p\right)  \right\vert }\right)  \left(
\prod_{p\in Q}x_{\left\vert f\left(  p\right)  \right\vert }\right) \\
&  =\underbrace{\left(  \sum_{g\in\mathcal{E}\left(  P,\gamma\right)  }%
\prod_{p\in P}x_{\left\vert g\left(  p\right)  \right\vert }\right)
}_{=\Gamma_{\mathcal{Z}}\left(  P,\gamma\right)  }\underbrace{\left(
\sum_{h\in\mathcal{E}\left(  Q,\delta\right)  }\prod_{p\in Q}x_{\left\vert
h\left(  p\right)  \right\vert }\right)  }_{=\Gamma_{\mathcal{Z}}\left(
Q,\delta\right)  }\\
&  \ \ \ \ \ \ \ \ \ \ \left(
\begin{array}
[c]{c}%
\text{here, we have substituted }\left(  g,h\right)  \text{ for }\left(
f\mid_{P},f\mid_{Q}\right)  \text{, since}\\
\text{the map (\ref{pf.prop.prod1.bij}) is a bijection}%
\end{array}
\right) \\
&  =\Gamma_{\mathcal{Z}}\left(  P,\gamma\right)  \Gamma_{\mathcal{Z}}\left(
Q,\delta\right)  .
\end{align*}

\end{proof}

\begin{definition}
Let $n\in\mathbb{N}$. Let $\pi$ be any $n$-permutation. (Recall that we have
defined the concept of an \textquotedblleft$n$-permutation\textquotedblright%
\ in Definition \ref{def.perm}.) Then, $\left(  \left[  n\right]  ,\pi\right)
$ is a labeled poset (in fact, $\pi$ is an injective map $\left[  n\right]
\rightarrow\left\{  1,2,3,\ldots\right\}  $, and thus can be considered a
labeling). We define $\Gamma_{\mathcal{Z}}\left(  \pi\right)  $ to be the
power series $\Gamma_{\mathcal{Z}}\left(  \left[  n\right]  ,\pi\right)  $.
\end{definition}

We shall now prove two simple facts of auxiliary use:

\begin{proposition}
\label{prop.Gamma=Gamma}Let $w$ be a finite totally ordered set with ground
set $W$. Let $n=\left\vert W\right\vert $. Let $\overline{w}$ be the unique
poset isomorphism $w\rightarrow\left[  n\right]  $. Let $\gamma:W\rightarrow
\left\{  1,2,3,\ldots\right\}  $ be any injective map. Then, $\Gamma
_{\mathcal{Z}}\left(  w,\gamma\right)  =\Gamma_{\mathcal{Z}}\left(
\gamma\circ\overline{w}^{-1}\right)  $.
\end{proposition}

\begin{proof}
[Proof of Proposition \ref{prop.Gamma=Gamma}.]The map $\gamma\circ\overline
{w}^{-1}:\left[  n\right]  \rightarrow\left\{  1,2,3,\ldots\right\}  $ is an
injective map, thus an $n$-permutation. Hence, $\Gamma_{\mathcal{Z}}\left(
\gamma\circ\overline{w}^{-1}\right)  $ is well-defined, and in fact we have
$\Gamma_{\mathcal{Z}}\left(  \gamma\circ\overline{w}^{-1}\right)
=\Gamma_{\mathcal{Z}}\left(  \left[  n\right]  ,\gamma\circ\overline{w}%
^{-1}\right)  $. Now, the map%
\begin{align*}
\mathcal{E}\left(  w,\gamma\right)   &  \rightarrow\mathcal{E}\left(  \left[
n\right]  ,\gamma\circ\overline{w}^{-1}\right)  ,\\
f  &  \mapsto f\circ\overline{w}^{-1}%
\end{align*}
is a bijection. Furthermore, it satisfies $\prod_{p\in w}x_{\left\vert
f\left(  p\right)  \right\vert }=\prod_{p\in\left[  n\right]  }x_{\left\vert
\left(  f\circ\overline{w}^{-1}\right)  \left(  p\right)  \right\vert }$ for
each $f\in\mathcal{E}\left(  w,\gamma\right)  $. Hence, $\Gamma_{\mathcal{Z}%
}\left(  w,\gamma\right)  =\Gamma_{\mathcal{Z}}\left(  \left[  n\right]
,\gamma\circ\overline{w}^{-1}\right)  =\Gamma_{\mathcal{Z}}\left(  \gamma
\circ\overline{w}^{-1}\right)  $.
\end{proof}

\begin{corollary}
\label{cor.fund-lem2}Let $\left(  P,\gamma\right)  $ be a labeled poset. Let
$n=\left\vert P\right\vert $. Then,%
\[
\Gamma_{\mathcal{Z}}\left(  P,\gamma\right)  =\sum_{\substack{x:P\rightarrow
\left[  n\right]  \\\text{bijective poset}\\\text{homomorphism}}%
}\Gamma_{\mathcal{Z}}\left(  \gamma\circ x^{-1}\right)  .
\]

\end{corollary}

\begin{proof}
[Proof of Corollary \ref{cor.fund-lem2}.]For each totally ordered set $w$ with
ground set $P$, we let $\overline{w}$ be the unique poset isomorphism
$w\rightarrow\left[  n\right]  $.

Corollary \ref{cor.fund-lem} yields%
\begin{equation}
\Gamma_{\mathcal{Z}}\left(  P,\gamma\right)  =\sum_{w\in\mathcal{L}\left(
P\right)  }\underbrace{\Gamma_{\mathcal{Z}}\left(  w,\gamma\right)
}_{\substack{=\Gamma_{\mathcal{Z}}\left(  \gamma\circ\overline{w}^{-1}\right)
\\\text{(by Proposition \ref{prop.Gamma=Gamma})}}}=\sum_{w\in\mathcal{L}%
\left(  P\right)  }\Gamma_{\mathcal{Z}}\left(  \gamma\circ\overline{w}%
^{-1}\right)  . \label{pf.cor.fund-lem2.1}%
\end{equation}
But the linear extensions of $P$ are in bijection with the bijective poset
homomorphisms $x:P\rightarrow\left[  n\right]  $; the bijection sends a linear
extension $w$ of $P$ to the bijective poset homomorphism $\overline
{w}:P\rightarrow\left[  n\right]  $. Thus, we can substitute $x$ for $w$ in
the sum $\sum_{w\in\mathcal{L}\left(  P\right)  }\Gamma_{\mathcal{Z}}\left(
\gamma\circ\overline{w}^{-1}\right)  $, obtaining%
\[
\sum_{w\in\mathcal{L}\left(  P\right)  }\Gamma_{\mathcal{Z}}\left(
\gamma\circ\overline{w}^{-1}\right)  =\sum_{\substack{x:P\rightarrow\left[
n\right]  \\\text{bijective poset}\\\text{homomorphism}}}\Gamma_{\mathcal{Z}%
}\left(  \gamma\circ x^{-1}\right)  .
\]
Combining this with (\ref{pf.cor.fund-lem2.1}), we end up with the claim of
Corollary \ref{cor.fund-lem2}.
\end{proof}

\begin{corollary}
\label{cor.prod2}Let $n\in\mathbb{N}$ and $m\in\mathbb{N}$. Let $\pi$ be an
$n$-permutation and let $\sigma$ be an $m$-permutation such that $\pi$ and
$\sigma$ are disjoint. Then,%
\[
\Gamma_{\mathcal{Z}}\left(  \pi\right)  \Gamma_{\mathcal{Z}}\left(
\sigma\right)  =\sum_{\tau\in S\left(  \pi,\sigma\right)  }\Gamma
_{\mathcal{Z}}\left(  \tau\right)  .
\]

\end{corollary}

\begin{proof}
[Proof of Corollary \ref{cor.prod2}.]Let $\varepsilon$ be the map $\left[
n\right]  \sqcup\left[  m\right]  \rightarrow\left\{  1,2,3,\ldots\right\}  $
which restricts to $\pi$ on the $\left[  n\right]  $ part and restricts to
$\sigma$ on the $\left[  m\right]  $ part. This map $\varepsilon$ is an
$\left(  n+m\right)  $-permutation, since $\pi$ and $\sigma$ are disjoint.

Let $\rho:\left[  n\right]  \sqcup\left[  m\right]  \rightarrow\left[
n+m\right]  $ be the strictly order-preserving bijection which sends the
elements of $\left[  n\right]  $ to $1,2,\ldots,n$ and sends the elements of
$\left[  m\right]  $ to $n+1,n+2,\ldots,n+m$.

The definitions of $\Gamma_{\mathcal{Z}}\left(  \pi\right)  $ and
$\Gamma_{\mathcal{Z}}\left(  \sigma\right)  $ yield%
\begin{align*}
\Gamma_{\mathcal{Z}}\left(  \pi\right)  \Gamma_{\mathcal{Z}}\left(
\sigma\right)   &  =\Gamma_{\mathcal{Z}}\left(  \left[  n\right]  ,\pi\right)
\Gamma_{\mathcal{Z}}\left(  \left[  m\right]  ,\sigma\right) \\
&  =\Gamma_{\mathcal{Z}}\left(  \left[  n\right]  \sqcup\left[  m\right]
,\varepsilon\right)  \ \ \ \ \ \ \ \ \ \ \left(  \text{by Proposition
\ref{prop.prod1}}\right) \\
&  =\sum_{\substack{x:\left[  n\right]  \sqcup\left[  m\right]  \rightarrow
\left[  n+m\right]  \\\text{bijective poset}\\\text{homomorphism}}%
}\Gamma_{\mathcal{Z}}\left(  \varepsilon\circ x^{-1}\right)
\ \ \ \ \ \ \ \ \ \ \left(  \text{by Corollary \ref{cor.fund-lem2}}\right) \\
&  =\sum_{\tau\in S\left(  \sigma,\pi\right)  }\Gamma_{\mathcal{Z}}\left(
\tau\right)  .
\end{align*}
Here, the last equality sign makes use of the (easy) fact that the map%
\begin{align*}
\left\{  \text{bijective poset homomorphisms }x:\left[  n\right]
\sqcup\left[  m\right]  \rightarrow\left[  n+m\right]  \right\}   &
\rightarrow S\left(  \sigma,\pi\right)  ,\\
x  &  \mapsto\varepsilon\circ x^{-1}%
\end{align*}
is a well-defined bijection.
\end{proof}

\subsection{Exterior peaks}

So far we have been doing general nonsense. Let us now specialize to a
situation that is connected to exterior peaks.

\begin{convention}
From now on, we set $\mathcal{N}=\left\{  0,1,2,\ldots\right\}  \cup\left\{
\infty\right\}  $, with total order given by $0\prec1\prec2\prec\cdots
\prec\infty$, and we set
\begin{align*}
\mathcal{Z}  &  =\left(  \mathcal{N}\times\left\{  +,-\right\}  \right)
\setminus\left\{  -0,+\infty\right\} \\
&  =\left\{  +0\right\}  \cup\left\{  +n\ \mid\ n\in\left\{  1,2,3,\ldots
\right\}  \right\}  \cup\left\{  -n\ \mid\ n\in\left\{  1,2,3,\ldots\right\}
\right\}  \cup\left\{  -\infty\right\}  .
\end{align*}
Recall that the total order on $\mathcal{Z}$ has%
\[
+0\prec-1\prec+1\prec-2\prec+2\prec\cdots\prec-\infty.
\]

\end{convention}

\begin{definition}
A map $\chi$ from a subset $S$ of $\mathbb{Z}$ to a totally ordered set $K$ is
said to be \textit{V-shaped} if there exists some $t\in S$ such that the map
$\chi\mid_{\left\{  s\in S\ \mid\ s\leq t\right\}  }$ is strictly decreasing
while the map $\chi\mid_{\left\{  s\in S\ \mid\ s\geq t\right\}  }$ is
strictly increasing. Notice that this $t\in S$ is uniquely determined in this
case; namely, it is the unique $k\in S$ that minimizes $\chi\left(  k\right)
$.
\end{definition}

Thus, roughly speaking, a map from a totally ordered set is \textit{V-shaped}
if and only if it is strictly decreasing up until a certain value of its
argument, and then strictly increasing afterwards.

\begin{definition}
Let $n\in\mathbb{N}$.

\begin{enumerate}
\item[\textbf{(a)}] Let $f:\left[  n\right]  \rightarrow\mathcal{Z}$ be any
map. Then, $\left\vert f\right\vert $ shall denote the map $\left[  n\right]
\rightarrow\mathcal{N},\ i\mapsto\left\vert f\left(  i\right)  \right\vert $.

\item[\textbf{(b)}] Let $g:\left[  n\right]  \rightarrow\mathcal{N}$ be any
map. Then, we define a monomial $\mathbf{x}_{g}$ in $\operatorname*{Pow}%
\mathcal{N}$ by $\mathbf{x}_{g}=\prod_{i=1}^{n}x_{g\left(  i\right)  }$. Note
that this allows us to rewrite the definition of $\Gamma_{\mathcal{Z}}\left(
\pi\right)  $ as follows: If $\pi$ is any $n$-permutation, then%
\begin{equation}
\Gamma_{\mathcal{Z}}\left(  \pi\right)  =\sum_{f\in\mathcal{E}\left(  \left[
n\right]  ,\pi\right)  }\prod_{p\in\left[  n\right]  }x_{\left\vert f\left(
p\right)  \right\vert }=\sum_{f\in\mathcal{E}\left(  \left[  n\right]
,\pi\right)  }\mathbf{x}_{\left\vert f\right\vert }. \label{eq.Gamma.rewr}%
\end{equation}


\item[\textbf{(c)}] Let $g:\left[  n\right]  \rightarrow\mathcal{N}$ be any
map. Let $\pi$ be an $n$-permutation. We shall say that $g$ is $\pi
$\textit{-amenable} if it has the following properties:

\begin{enumerate}
\item[\textbf{(i')}] The map $\pi\mid_{g^{-1}\left(  0\right)  }$ is strictly
increasing. (This allows the case when $g^{-1}\left(  0\right)  =\varnothing$.)

\item[\textbf{(ii')}] For each $h\in g\left(  \left[  n\right]  \right)
\cap\left\{  1,2,3,\ldots\right\}  $, the map $\pi\mid_{g^{-1}\left(
h\right)  }$ is V-shaped.

\item[\textbf{(iii')}] The map $\pi\mid_{g^{-1}\left(  \infty\right)  }$ is
strictly decreasing. (This allows the case when $g^{-1}\left(  \infty\right)
=\varnothing$.)

\item[\textbf{(iv')}] The map $g$ is weakly increasing.
\end{enumerate}
\end{enumerate}
\end{definition}

\begin{proposition}
\label{prop.Epk-formula}Let $n\in\mathbb{N}$. Let $\pi$ be any $n$%
-permutation. Then,%
\[
\Gamma_{\mathcal{Z}}\left(  \pi\right)  =\sum_{\substack{g:\left[  n\right]
\rightarrow\mathcal{N}\\\text{is }\pi\text{-amenable}}}2^{\left\vert g\left(
\left[  n\right]  \right)  \cap\left\{  1,2,3,\ldots\right\}  \right\vert
}\mathbf{x}_{g}.
\]

\end{proposition}

\begin{proof}
[Proof of Proposition \ref{prop.Epk-formula}.]The claim will immediately
follow from (\ref{eq.Gamma.rewr}) once we have shown the following two observations:

\begin{statement}
\textit{Observation 1:} If $f\in\mathcal{E}\left(  \left[  n\right]
,\pi\right)  $, then the map $\left\vert f\right\vert :\left[  n\right]
\rightarrow\mathcal{N}$ is $\pi$-amenable.
\end{statement}

\begin{statement}
\textit{Observation 2:} If $g:\left[  n\right]  \rightarrow\mathcal{N}$ is a
$\pi$-amenable map, then there exist precisely $2^{\left\vert g\left(  \left[
n\right]  \right)  \cap\left\{  1,2,3,\ldots\right\}  \right\vert }$ maps
$f\in\mathcal{E}\left(  \left[  n\right]  ,\pi\right)  $ satisfying
$\left\vert f\right\vert =g$.
\end{statement}

But both of these observations are easy:

[\textit{Proof of Observation 1:} This is a simple consequence of the
definition of a $\mathcal{Z}$-enriched $\left(  \left[  n\right]  ,\pi\right)
$-partition. Let me spell it out: Let $f\in\mathcal{E}\left(  \left[
n\right]  ,\pi\right)  $. Thus, $f$ is an $\mathcal{Z}$-enriched $\left(
\left[  n\right]  ,\pi\right)  $-partition. In other words, $f$ is a map
$\left[  n\right]  \rightarrow\mathcal{Z}$ such that for all $x<y$ in $\left[
n\right]  $, the following conditions hold:

\begin{enumerate}
\item[\textbf{(i)}] We have $f\left(  x\right)  \preccurlyeq f\left(
y\right)  $.

\item[\textbf{(ii)}] If $f\left(  x\right)  =f\left(  y\right)  =+h$ for some
$h\in\mathcal{N}$, then $\pi\left(  x\right)  <\pi\left(  y\right)  $.

\item[\textbf{(iii)}] If $f\left(  x\right)  =f\left(  y\right)  =-h$ for some
$h\in\mathcal{N}$, then $\pi\left(  x\right)  >\pi\left(  y\right)  $.
\end{enumerate}

Condition \textbf{(i)} shows that the map $f$ is weakly increasing. Condition
\textbf{(ii)} shows that for each $h\in\mathcal{N}$, the map $\pi\mid
_{f^{-1}\left(  +h\right)  }$ is strictly increasing. Condition \textbf{(iii)}
shows that for each $h\in\mathcal{N}$, the map $\pi\mid_{f^{-1}\left(
-h\right)  }$ is strictly decreasing.

Now, set $g=\left\vert f\right\vert $. Then, $g^{-1}\left(  0\right)
=f^{-1}\left(  +0\right)  $ (since $-0\notin\mathcal{Z}$). But the map
$\pi\mid_{f^{-1}\left(  +0\right)  }$ is strictly increasing\footnote{because
for each $h\in\mathcal{N}$, the map $\pi\mid_{f^{-1}\left(  +h\right)  }$ is
strictly increasing}. Thus, the map $\pi\mid_{g^{-1}\left(  0\right)  }$ is
strictly increasing (since $g^{-1}\left(  0\right)  =f^{-1}\left(  +0\right)
$). Hence, Condition \textbf{(i')} in the definition of \textquotedblleft$\pi
$-amenable\textquotedblright\ holds. Similarly, Condition \textbf{(iii')} in
that definition also holds.

Now, fix $h\in g\left(  \left[  n\right]  \right)  \cap\left\{  1,2,3,\ldots
\right\}  $. Then, the set $g^{-1}\left(  h\right)  $ is nonempty (since $h\in
g\left(  \left[  n\right]  \right)  $), and can be written as the union of its
two disjoint subsets $f^{-1}\left(  +h\right)  $ and $f^{-1}\left(  -h\right)
$. Furthermore, each element of $f^{-1}\left(  -h\right)  $ is smaller than
each element of $f^{-1}\left(  +h\right)  $ (since $f$ is weakly increasing),
and we know that the map $\pi\mid_{f^{-1}\left(  -h\right)  }$ is strictly
decreasing while the map $\pi\mid_{f^{-1}\left(  +h\right)  }$ is strictly
increasing. Hence, the map $\pi\mid_{g^{-1}\left(  h\right)  }$ is strictly
decreasing up until some value of its argument, and then strictly increasing
afterwards. In other words, the map $\pi\mid_{g^{-1}\left(  h\right)  }$ is
V-shaped. Thus, Condition \textbf{(ii')} in the definition of
\textquotedblleft$\pi$-amenable\textquotedblright\ holds. Finally, Condition
\textbf{(iv')} in the definition of \textquotedblleft$\pi$%
-amenable\textquotedblright\ holds because $f$ is weakly increasing. We have
hence checked all four conditions; thus, $g$ is $\pi$-amenable. This proves
Observation 1.]

[\textit{Proof of Observation 2:} Let $g:\left[  n\right]  \rightarrow
\mathcal{N}$ be a $\pi$-amenable map. Consider a map $f\in\mathcal{E}\left(
\left[  n\right]  ,\pi\right)  $ satisfying $\left\vert f\right\vert =g$. We
are wondering to what extent the map $f$ is determined by $g$ and $\pi$.

Everything that we said in the proof of Observation 1 is true.

In order to determine the map $f$, it clearly suffices to determine the sets
$f^{-1}\left(  q\right)  $ for all $q\in\mathcal{Z}$. In other words, it
suffices to determine the set $f^{-1}\left(  +0\right)  $, the set
$f^{-1}\left(  -\infty\right)  $ and the sets $f^{-1}\left(  +h\right)  $ and
$f^{-1}\left(  -h\right)  $ for all $h\in\left\{  1,2,3,\ldots\right\}  $.

Recall from the proof of Observation 1 that $g^{-1}\left(  0\right)
=f^{-1}\left(  +0\right)  $. Thus, $f^{-1}\left(  +0\right)  $ is uniquely
determined by $g$. Similarly, $f^{-1}\left(  -\infty\right)  $ is uniquely
determined by $g$. Thus, we can focus on the remaining sets $f^{-1}\left(
+h\right)  $ and $f^{-1}\left(  -h\right)  $ for $h\in\left\{  1,2,3,\ldots
\right\}  $.

Fix $h\in\left\{  1,2,3,\ldots\right\}  $. Recall that the set $g^{-1}\left(
h\right)  $ is the union of its two disjoint subsets $f^{-1}\left(  +h\right)
$ and $f^{-1}\left(  -h\right)  $. Thus, $f^{-1}\left(  +h\right)  $ and
$f^{-1}\left(  -h\right)  $ are complementary subsets of $g^{-1}\left(
h\right)  $. If $g^{-1}\left(  h\right)  =\varnothing$, then this uniquely
determines $f^{-1}\left(  +h\right)  $ and $f^{-1}\left(  -h\right)  $. Thus,
we focus only on the case when $g^{-1}\left(  h\right)  \neq\varnothing$.

So assume that $g^{-1}\left(  h\right)  \neq\varnothing$. Hence, $h\in
g\left(  \left[  n\right]  \right)  $, so that $h\in g\left(  \left[
n\right]  \right)  \cap\left\{  1,2,3,\ldots\right\}  $. Since the map $g$ is
$\pi$-amenable, we thus conclude that the map $\pi\mid_{g^{-1}\left(
h\right)  }$ is V-shaped (by Condition \textbf{(ii')} in the definition of
\textquotedblleft$\pi$-amenable\textquotedblright).

The map $g$ is weakly increasing (by Condition \textbf{(iv')} in the
definition of \textquotedblleft$\pi$-amenable\textquotedblright). Hence,
$g^{-1}\left(  h\right)  $ is an interval of $\left[  n\right]  $. Let
$\alpha\in\mathbb{Z}$ and $\gamma\in\mathbb{Z}$ be such that $g^{-1}\left(
h\right)  =\left[  \alpha,\gamma\right]  $ (where $\left[  \alpha
,\gamma\right]  $ means the interval $\left\{  \alpha,\alpha+1,\ldots
,\gamma\right\}  $).

As in the proof of Observation 1, we can see that each element of
$f^{-1}\left(  -h\right)  $ is smaller than each element of $f^{-1}\left(
+h\right)  $. Since the union of $f^{-1}\left(  -h\right)  $ and
$f^{-1}\left(  +h\right)  $ is $g^{-1}\left(  h\right)  =\left[  \alpha
,\gamma\right]  $, we thus conclude that there exists some $\beta\in\left[
\alpha-1,\gamma\right]  $ such that $f^{-1}\left(  -h\right)  =\left[
\alpha,\beta\right]  $ and $f^{-1}\left(  +h\right)  =\left[  \beta
+1,\gamma\right]  $. Consider this $\beta$. Clearly, $f^{-1}\left(  -h\right)
$ and $f^{-1}\left(  +h\right)  $ are uniquely determined by $\beta$; we just
need to find out which values $\beta$ can take.

As in the proof of Observation 1, we can see that the map $\pi\mid
_{f^{-1}\left(  -h\right)  }$ is strictly decreasing while the map $\pi
\mid_{f^{-1}\left(  +h\right)  }$ is strictly increasing. Let $k$ be the
element of $g^{-1}\left(  h\right)  $ minimizing $\pi\left(  k\right)  $.
Then, the map $\pi$ is strictly decreasing on the set $\left\{  u\in
g^{-1}\left(  h\right)  \ \mid\ u\leq k\right\}  $ and strictly increasing on
the set $\left\{  u\in g^{-1}\left(  h\right)  \ \mid\ u\geq k\right\}  $
(since the map $\pi\mid_{g^{-1}\left(  h\right)  }$ is V-shaped).

The map $\pi\mid_{f^{-1}\left(  -h\right)  }$ is strictly decreasing. In other
words, the map $\pi$ is strictly decreasing on the set $f^{-1}\left(
-h\right)  =\left[  \alpha,\beta\right]  $. On the other hand, the map $\pi$
is strictly increasing on the set $\left\{  u\in g^{-1}\left(  h\right)
\ \mid\ u\geq k\right\}  $. Hence, the two sets $\left[  \alpha,\beta\right]
$ and $\left\{  u\in g^{-1}\left(  h\right)  \ \mid\ u\geq k\right\}  $ cannot
have more than one point in common (since $\pi$ is strictly decreasing on one
and strictly increasing on the other). Thus, $k\geq\beta$. A similar argument
shows that $k\leq\beta+1$. Combining these inequalities, we obtain
$k\in\left\{  \beta,\beta+1\right\}  $, so that $\beta\in\left\{
k,k-1\right\}  $. This shows that $\beta$ can take only two values: $k$ and
$k-1$.

Now, let us take a bird's eye view. We have shown that for each $h\in g\left(
\left[  n\right]  \right)  \cap\left\{  1,2,3,\ldots\right\}  $, the sets
$f^{-1}\left(  +h\right)  $ and $f^{-1}\left(  -h\right)  $ are uniquely
determined once the integer $\beta$ is chosen, and that this integer $\beta$
can be chosen in two ways. (As we have seen, all other values of $h$ do not
matter.) Thus, in total, the map $f$ is uniquely determined up to $\left\vert
g\left(  \left[  n\right]  \right)  \cap\left\{  1,2,3,\ldots\right\}
\right\vert $ decisions, where each decision allows choosing from two values.
Thus, there are at most $2^{\left\vert g\left(  \left[  n\right]  \right)
\cap\left\{  1,2,3,\ldots\right\}  \right\vert }$ maps $f\in\mathcal{E}\left(
\left[  n\right]  ,\pi\right)  $ satisfying $\left\vert f\right\vert =g$.
Working the above argument backwards, we see that each possible decision
actually leads to a map $f\in\mathcal{E}\left(  \left[  n\right]  ,\pi\right)
$ satisfying $\left\vert f\right\vert =g$; thus, there are \textbf{exactly}
$2^{\left\vert g\left(  \left[  n\right]  \right)  \cap\left\{  1,2,3,\ldots
\right\}  \right\vert }$ maps $f\in\mathcal{E}\left(  \left[  n\right]
,\pi\right)  $ satisfying $\left\vert f\right\vert =g$. This proves
Observation 2.]
\end{proof}

\begin{definition}
\label{def.fiberends}Let $n\in\mathbb{N}$. Let $g:\left[  n\right]
\rightarrow\mathcal{N}$ be any map. We define a subset $\operatorname*{FE}%
\left(  g\right)  $ of $\left[  n\right]  $ as follows:%
\begin{align*}
\operatorname*{FE}\left(  g\right)   &  =\left\{  \min\left(  g^{-1}\left(
h\right)  \right)  \ \mid\ h\in\left\{  1,2,3,\ldots,\infty\right\}  \right\}
\\
&  \ \ \ \ \ \ \ \ \ \ \cup\left\{  \max\left(  g^{-1}\left(  h\right)
\right)  \ \mid\ h\in\left\{  0,1,2,3,\ldots\right\}  \right\}  .
\end{align*}
In other words, $\operatorname*{FE}\left(  g\right)  $ is the set comprising
the smallest elements of all nonempty fibers of $g$ except for $g^{-1}\left(
0\right)  $ as well as the largest elements of all nonempty fibers of $g$
except for $g^{-1}\left(  \infty\right)  $. We shall refer to the elements of
$\operatorname*{FE}\left(  g\right)  $ as the \textit{fiber-ends} of $g$.
\end{definition}

We can rewrite Proposition \ref{prop.Epk-formula} as follows, exhibiting its
analogy with \cite[Proposition 2.2]{Stembr97}:

\begin{proposition}
\label{prop.Epk-formula2}Let $n\in\mathbb{N}$. Let $\pi$ be any $n$%
-permutation. Then,%
\[
\Gamma_{\mathcal{Z}}\left(  \pi\right)  =\sum_{\substack{g:\left[  n\right]
\rightarrow\mathcal{N}\text{ is}\\\text{weakly increasing;}%
\\\operatorname*{Epk}\pi\subseteq\operatorname*{FE}\left(  g\right)
}}2^{\left\vert g\left(  \left[  n\right]  \right)  \cap\left\{
1,2,3,\ldots\right\}  \right\vert }\mathbf{x}_{g}.
\]

\end{proposition}

\begin{proof}
[Proof of Proposition \ref{prop.Epk-formula2}.]This will follow from
Proposition \ref{prop.Epk-formula} once we know that the $\pi$-amenable maps
$g:\left[  n\right]  \rightarrow\mathcal{N}$ are precisely the weakly
increasing maps $g:\left[  n\right]  \rightarrow\mathcal{N}$ satisfying
$\operatorname*{Epk}\pi\subseteq\operatorname*{FE}\left(  g\right)  $. But
this is easy to check. (The main idea: If $g:\left[  n\right]  \rightarrow
\mathcal{N}$ is a weakly increasing map, then all nonempty fibers
$g^{-1}\left(  h\right)  $ of $g$ are intervals, and Conditions \textbf{(i')},
\textbf{(ii')} and \textbf{(iii')} in the definition of \textquotedblleft$\pi
$-amenable\textquotedblright\ say precisely that no peak of $\pi$ can appear
in the interior of any such fiber; i.e., all peaks must appear at fiber-ends.
Of course, this needs some exceptions for $g^{-1}\left(  0\right)  $ and
$g^{-1}\left(  \infty\right)  $, but this is all straightforward.)
\end{proof}

\begin{definition}
\label{def.KnL}Let $n\in\mathbb{N}$. If $\Lambda$ is any subset of $\left[
n\right]  $, then we define a power series $K_{n,\Lambda}^{\mathcal{Z}}%
\in\operatorname*{Pow}\mathcal{N}$ by%
\begin{equation}
K_{n,\Lambda}^{\mathcal{Z}}=\sum_{\substack{g:\left[  n\right]  \rightarrow
\mathcal{N}\text{ is}\\\text{weakly increasing;}\\\Lambda\subseteq
\operatorname*{FE}\left(  g\right)  }}2^{\left\vert g\left(  \left[  n\right]
\right)  \cap\left\{  1,2,3,\ldots\right\}  \right\vert }\mathbf{x}_{g}.
\label{eq.def.KnL.1}%
\end{equation}
Thus, if $\Lambda=\operatorname*{Epk}\pi$ for some $n$-permutation $\pi$, then
Proposition \ref{prop.Epk-formula2} shows that%
\begin{equation}
\Gamma_{\mathcal{Z}}\left(  \pi\right)  =K_{n,\Lambda}^{\mathcal{Z}}.
\label{eq.def.KnL.2}%
\end{equation}

\end{definition}

\begin{definition}
A set $S$ of integers is said to be \textit{lacunar} if each $s\in S$
satisfies $s+1\notin S$.
\end{definition}

The following observation is easy:

\begin{proposition}
\label{prop.when-Epk}Let $n\in\mathbb{N}$. Let $\Lambda$ be a subset of
$\left[  n\right]  $. Then, there exists an $n$-permutation $\pi$ satisfying
$\Lambda=\operatorname*{Epk}\pi$ if and only if $\Lambda$ is lacunar and nonempty.
\end{proposition}

\begin{proof}
[Proof of Proposition \ref{prop.when-Epk}.]$\Longrightarrow:$ We need to prove
that for any $n$-permutation $\pi$, the set $\operatorname*{Epk}\pi$ is
lacunar and nonempty. But this set $\operatorname*{Epk}\pi$ is clearly lacunar
(since two consecutive integers cannot both be exterior peaks of $\pi$), and
is also nonempty (because otherwise, $\pi$ would have no peaks, so that $\pi$
would be either strictly increasing or strictly decreasing; but then, either
$n$ or $1$ would be an exterior peak of $\pi$). This proves the
$\Longrightarrow$ direction of Proposition \ref{prop.when-Epk}.

$\Longleftarrow:$ Assume that $\Lambda$ is lacunar and nonempty. We must prove
that there exists an $n$-permutation $\pi$ satisfying $\Lambda
=\operatorname*{Epk}\pi$. Such an $n$-permutation $\pi$ can be constructed as follows:

\begin{itemize}
\item Write the set $\Lambda$ in the form $\Lambda=\left\{  u_{1}<u_{2}%
<\cdots<u_{\ell}\right\}  $ (where $\ell=\left\vert \Lambda\right\vert $).
Thus, $\ell\geq1$ (since $\Lambda$ is nonempty), and we can represent the set
$\left[  n\right]  \setminus\Lambda$ as a union of disjoint intervals as
follows:
\begin{align*}
&  \left[  n\right]  \setminus\Lambda\\
&  =\left[  1,u_{1}-1\right]  \cup\left[  u_{1}+1,u_{2}-1\right]  \cup\left[
u_{2}+1,u_{3}-1\right]  \cup\cdots\cup\left[  u_{\ell-1}+1,u_{\ell}-1\right]
\\
&  \ \ \ \ \ \ \ \ \ \ \cup\left[  u_{\ell}+1,n\right]  .
\end{align*}


\item Let $\pi$ take the values $n,n-1,\ldots,n-\ell+1$ on the elements of
$\Lambda$. (For example, this can be achieved by setting $\pi\left(
u_{i}\right)  =n+1-i$ for each $i\in\left[  \ell\right]  $.)

\item Let $\pi$ take the values $1,2,\ldots,n-\ell$ on the elements of
$\left[  n\right]  \setminus\Lambda$ in such a way that:

\begin{itemize}
\item[(A)] on each of the intervals $\left[  1,u_{1}-1\right]  ,\left[
u_{1}+1,u_{2}-1\right]  ,\left[  u_{2}+1,u_{3}-1\right]  ,\ldots,$%
\newline$\left[  u_{\ell-1}+1,u_{\ell}-1\right]  ,\left[  u_{\ell}+1,n\right]
$, the map $\pi$ is either strictly increasing or strictly decreasing;

\item[(B)] if the interval $\left[  1,u_{1}-1\right]  $ is nonempty, then the
map $\pi$ is strictly increasing on this interval;

\item[(C)] if the interval $\left[  u_{\ell}+1,n\right]  $ is nonempty, then
the map $\pi$ is strictly decreasing on this interval.
\end{itemize}

(This is indeed possible, because if the two intervals $\left[  1,u_{1}%
-1\right]  $ and $\left[  u_{\ell}+1,n\right]  $ are both nonempty, then they
are distinct (since $\ell\geq1$).)
\end{itemize}

Any $n$-permutation $\pi$ constructed in this way will satisfy $\Lambda
=\operatorname*{Epk}\pi$. Indeed, it is clear that $\pi$ satisfies%
\[
\pi\left(  u\right)  >\pi\left(  v\right)  \ \ \ \ \ \ \ \ \ \ \text{for all
}u\in\Lambda\text{ and }v\in\left[  n\right]  \setminus\Lambda.
\]
Hence, any element of $\Lambda$ is an exterior peak of $\pi$. Conversely, an
element of $\left[  n\right]  \setminus\Lambda$ cannot be an exterior peak of
$\pi$ (because our construction of $\pi$ guarantees that any $s\in\left[
n\right]  \setminus\Lambda$ satisfies either $\left(  s-1\in\left[  n\right]
\text{ and }\pi\left(  s-1\right)  >\pi\left(  s\right)  \right)  $ or
$\left(  s+1\in\left[  n\right]  \text{ and }\pi\left(  s+1\right)
>\pi\left(  s\right)  \right)  $). Thus, the exterior peaks of $\pi$ are
precisely the elements of $\Lambda$; in other words, we have $\Lambda
=\operatorname*{Epk}\pi$. This proves the $\Longleftarrow$ direction of
Proposition \ref{prop.when-Epk}.
\end{proof}

\begin{proposition}
\label{prop.KnL.lindep}Let $n\in\mathbb{N}$. Then, the family%
\[
\left(  K_{n,\Lambda}^{\mathcal{Z}}\right)  _{\Lambda\subseteq\left[
n\right]  \text{ is lacunar and nonempty}}%
\]
is $\mathbb{Q}$-linearly independent.
\end{proposition}

\begin{proof}
[Proof of Proposition \ref{prop.KnL.lindep}.]Let $\Omega$ be the subset
$\left\{  1,3,5,\ldots\right\}  \cap\left[  n\right]  =\left\{  i\in\left[
n\right]  \ \mid\ i\text{ is odd}\right\}  $ of $\left[  n\right]  $. This is
clearly a lacunar subset of $\left[  n\right]  $.

We are going to prove the following claim:

\begin{statement}
\textit{Claim 1:} \textbf{(a)} If $n$ is odd, then the only syzygy\footnote{If
$\left(  v_{h}\right)  _{h\in H}$ is a family of vectors in a vector space
over a field $\mathbb{F}$, then a \textit{syzygy} of this family $\left(
v_{h}\right)  _{h\in H}$ means a family $\left(  \lambda_{h}\right)  _{h\in
H}\in\mathbb{F}^{H}$ of scalars in $\mathbb{F}$ satisfying $\sum_{h\in
H}\lambda_{h}v_{h}=0$.
\par
Thus, a syzygy is what is commonly called a \textquotedblleft linear
dependence relation\textquotedblright\ (at least when the scalars $\lambda
_{h}$ are not all $0$). By abuse of notation, we shall speak of the
\textquotedblleft syzygy $\sum_{h\in H}\lambda_{h}v_{h}=0$\textquotedblright%
\ meaning not the equality $\sum_{h\in H}\lambda_{h}v_{h}=0$ but the family of
coefficients $\left(  \lambda_{h}\right)  _{h\in H}$.
\par
When we say \textquotedblleft the only syzygy\textquotedblright, we mean
\textquotedblleft the only nonzero syzygy up to scalar
multiples\textquotedblright.} of the family $\left(  K_{n,\Lambda
}^{\mathcal{Z}}\right)  _{\Lambda\subseteq\left[  n\right]  \text{ is
lacunar}}$ is $\sum_{\Lambda\subseteq\Omega}\left(  -1\right)  ^{\left\vert
\Lambda\right\vert }K_{n,\Lambda}^{\mathcal{Z}}=0$.

\textbf{(b)} If $n$ is even, then the family $\left(  K_{n,\Lambda
}^{\mathcal{Z}}\right)  _{\Lambda\subseteq\left[  n\right]  \text{ is
lacunar}}$ is $\mathbb{Q}$-linearly independent.
\end{statement}

For each subset $\Lambda$ of $\left[  n\right]  $, define a power series
$L_{n,\Lambda}^{\mathcal{Z}}\in\operatorname*{Pow}\mathcal{N}$ by%
\[
L_{n,\Lambda}^{\mathcal{Z}}=\sum_{\substack{g:\left[  n\right]  \rightarrow
\mathcal{N}\text{ is}\\\text{weakly increasing;}\\\Lambda\cap
\operatorname*{FE}\left(  g\right)  =\varnothing}}2^{\left\vert g\left(
\left[  n\right]  \right)  \cap\left\{  1,2,3,\ldots\right\}  \right\vert
}\mathbf{x}_{g}.
\]
Then, for each lacunar subset $\Lambda$ of $\left[  n\right]  $, the equality
(\ref{eq.def.KnL.1}) becomes%
\[
K_{n,\Lambda}^{\mathcal{Z}}=\sum_{\substack{g:\left[  n\right]  \rightarrow
\mathcal{N}\text{ is}\\\text{weakly increasing;}\\\Lambda\subseteq
\operatorname*{FE}\left(  g\right)  }}2^{\left\vert g\left(  \left[  n\right]
\right)  \cap\left\{  1,2,3,\ldots\right\}  \right\vert }\mathbf{x}_{g}%
=\sum_{Q\subseteq\Lambda}\left(  -1\right)  ^{\left\vert Q\right\vert }%
L_{n,Q}^{\mathcal{Z}}%
\]
(by the principle of inclusion and exclusion). Thus, (again by inclusion and
exclusion) each lacunar subset $\Lambda$ of $\left[  n\right]  $ satisfies%
\[
L_{n,\Lambda}^{\mathcal{Z}}=\sum_{Q\subseteq\Lambda}\left(  -1\right)
^{\left\vert Q\right\vert }K_{n,Q}^{\mathcal{Z}}.
\]
Hence, the two families $\left(  K_{n,\Lambda}^{\mathcal{Z}}\right)
_{\Lambda\subseteq\left[  n\right]  \text{ is lacunar}}$ and $\left(
L_{n,\Lambda}^{\mathcal{Z}}\right)  _{\Lambda\subseteq\left[  n\right]  \text{
is lacunar}}$ can be obtained from each other by a unitriangular transition
matrix (unitriangular with respect to inclusion\footnote{We are using the fact
that a subset of a lacunar subset is lacunar.}). Thus, the syzygies of these
two families are in bijection with each other. Hence, in order to prove Claim
1, it suffices to prove the following claim:

\begin{statement}
\textit{Claim 2:} \textbf{(a)} If $n$ is odd, then the only syzygy of the
family $\left(  L_{n,\Lambda}^{\mathcal{Z}}\right)  _{\Lambda\subseteq\left[
n\right]  \text{ is lacunar}}$ is $L_{n,\Omega}^{\mathcal{Z}}=0$.

\textbf{(b)} If $n$ is even, then the family $\left(  L_{n,\Lambda
}^{\mathcal{Z}}\right)  _{\Lambda\subseteq\left[  n\right]  \text{ is
lacunar}}$ is $\mathbb{Q}$-linearly independent.
\end{statement}

Let $G$ be the set of all weakly increasing maps $g:\left[  n\right]
\rightarrow\mathcal{N}$. Let $R$ be the free $\mathbb{Q}$-vector space with
basis $G$; its standard basis will be denoted by $\left(  \left[  g\right]
\right)  _{g\in G}$. We define a $\mathbb{Q}$-linear map%
\begin{align*}
\Phi:R  &  \rightarrow\operatorname*{Pow}\mathcal{N},\\
\left[  g\right]   &  \mapsto2^{\left\vert g\left(  \left[  n\right]  \right)
\cap\left\{  1,2,3,\ldots\right\}  \right\vert }\mathbf{x}_{g}.
\end{align*}
This map $\Phi$ is easily seen to be injective (since the maps $g\in G$ are
weakly increasing, and thus can be uniquely recovered from the monomials
$\mathbf{x}_{g}$).

For each subset $\Lambda$ of $\left[  n\right]  $, we define an element
$\widetilde{L}_{\Lambda}$ of $R$ by%
\[
\widetilde{L}_{\Lambda}=\sum_{\substack{g\in G;\\\Lambda\cap\operatorname*{FE}%
\left(  g\right)  =\varnothing}}\left[  g\right]  .
\]
Then, each subset $\Lambda$ of $\left[  n\right]  $ satisfies%
\begin{align*}
L_{n,\Lambda}^{\mathcal{Z}}  &  =\underbrace{\sum_{\substack{g:\left[
n\right]  \rightarrow\mathcal{N}\text{ is}\\\text{weakly increasing;}%
\\\Lambda\cap\operatorname*{FE}\left(  g\right)  =\varnothing}}}%
_{\substack{=\sum_{\substack{g\in G;\\\Lambda\cap\operatorname*{FE}\left(
g\right)  =\varnothing}}\\\text{(by the definition of }G\text{)}%
}}\underbrace{2^{\left\vert g\left(  \left[  n\right]  \right)  \cap\left\{
1,2,3,\ldots\right\}  \right\vert }\mathbf{x}_{g}}_{\substack{=\Phi\left(
\left[  g\right]  \right)  \\\text{(by the definition of }\Phi\text{)}}%
}=\sum_{\substack{g\in G;\\\Lambda\cap\operatorname*{FE}\left(  g\right)
=\varnothing}}\Phi\left(  \left[  g\right]  \right) \\
&  =\Phi\left(  \underbrace{\sum_{\substack{g\in G;\\\Lambda\cap
\operatorname*{FE}\left(  g\right)  =\varnothing}}\left[  g\right]
}_{=\widetilde{L}_{\Lambda}}\right)  =\Phi\left(  \widetilde{L}_{\Lambda
}\right)  .
\end{align*}
Hence, the family $\left(  L_{n,\Lambda}^{\mathcal{Z}}\right)  _{\Lambda
\subseteq\left[  n\right]  \text{ is lacunar}}$ is the image of the family
$\left(  \widetilde{L}_{\Lambda}\right)  _{\Lambda\subseteq\left[  n\right]
\text{ is lacunar}}$ under the map $\Phi$. Thus, the syzygies of the two
families are in bijection (since the map $\Phi$ is injective\footnote{We are
here using the following obvious fact:
\par
Let $V$ and $W$ be two vector spaces over a field $\mathbb{F}$. Let $\left(
v_{h}\right)  _{h\in H}\in V^{H}$ be a family of vectors in $V$. Let
$\phi:V\rightarrow W$ be an injective $\mathbb{F}$-linear map. Then, the
syzygies of the families $\left(  v_{h}\right)  _{h\in H}\in V^{H}$ and
$\left(  f\left(  v_{h}\right)  \right)  _{h\in H}\in W^{H}$ are in bijection.
(Actually, these syzygies, when regarded as families of scalars, are literally
the same.) In particular, the family $\left(  v_{h}\right)  _{h\in H}$ is
$\mathbb{F}$-linearly independent if and only if the family $\left(  f\left(
v_{h}\right)  \right)  _{h\in H}$ is $\mathbb{F}$-linearly independent.}).
Hence, in order to prove Claim 2, it suffices to prove the following claim:

\begin{statement}
\textit{Claim 3:} \textbf{(a)} If $n$ is odd, then the only syzygy of the
family $\left(  \widetilde{L}_{\Lambda}\right)  _{\Lambda\subseteq\left[
n\right]  \text{ is lacunar}}$ is $\widetilde{L}_{\Omega}=0$.

\textbf{(b)} If $n$ is even, then the family $\left(  \widetilde{L}_{\Lambda
}\right)  _{\Lambda\subseteq\left[  n\right]  \text{ is lacunar}}$ is
$\mathbb{Q}$-linearly independent.
\end{statement}

Let us agree that if $g\in G$, then we will set $g\left(  0\right)  =0$ and
$g\left(  n+1\right)  =\infty$. Hence, $g\left(  i\right)  $ will be a
well-defined value of $\mathcal{N}$ for each $i\in\left\{  0,1,\ldots
,n+1\right\}  $.

If $g\in G$, then we let $\operatorname*{Stag}\left(  g\right)  $ be the
subset $\left\{  i\in\left[  n+1\right]  \ \mid\ g\left(  i\right)  =g\left(
i-1\right)  \right\}  $ of $\left[  n+1\right]  $. It is easy to see that the
family $\left(  \sum_{\substack{g\in G;\\\operatorname*{Stag}\left(  g\right)
=T}}\left[  g\right]  \right)  _{T\subseteq\left[  n+1\right]  ;\ T\neq\left[
n+1\right]  }$ of elements of $R$ is $\mathbb{Q}$-linearly
independent\footnote{\textit{Proof.} Clearly, any two elements of this family
are supported on different basis elements (i.e., any $\left[  g\right]  $
appearing in one of them cannot appear in any other). It thus remains to show
that these elements are $\neq0$. In other words, it remains to show that for
any proper subset $T$ of $\left[  n+1\right]  $, we have $\sum_{\substack{g\in
G;\\\operatorname*{Stag}\left(  g\right)  =T}}\left[  g\right]  \neq0$. But
this is easy: Just construct some $g\in G$ satisfying $\operatorname*{Stag}%
\left(  g\right)  =T$.}. Hence, the family $\left(  \sum_{\substack{g\in
G;\\\operatorname*{Stag}\left(  g\right)  \supseteq T}}\left[  g\right]
\right)  _{T\subseteq\left[  n+1\right]  ;\ T\neq\left[  n+1\right]  }$ of
elements of $R$ is $\mathbb{Q}$-linearly independent, too (because this family
is obtained from the previous family $\left(  \sum_{\substack{g\in
G;\\\operatorname*{Stag}\left(  g\right)  =T}}\left[  g\right]  \right)
_{T\subseteq\left[  n+1\right]  ;\ T\neq\left[  n+1\right]  }$ via a
unitriangular change-of-basis matrix\footnote{unitriangular with respect to
the reverse inclusion order (notice that $\sum_{\substack{g\in
G;\\\operatorname*{Stag}\left(  g\right)  =T}}\left[  g\right]  =0$ for
$T=\left[  n+1\right]  $, so the exclusion of $\left[  n+1\right]  $ makes
sense and does not mess up our computations)}). Therefore, the only syzygy of
the family \newline$\left(  \sum_{\substack{g\in G;\\\operatorname*{Stag}%
\left(  g\right)  \supseteq T}}\left[  g\right]  \right)  _{T\subseteq\left[
n+1\right]  }$ is $\sum_{\substack{g\in G;\\\operatorname*{Stag}\left(
g\right)  \supseteq\left[  n+1\right]  }}\left[  g\right]  =0$ (since it is
easy to see that no $g\in G$ satisfies $\operatorname*{Stag}\left(  g\right)
\supseteq\left[  n+1\right]  $, which is why $\sum_{\substack{g\in
G;\\\operatorname*{Stag}\left(  g\right)  \supseteq\left[  n+1\right]
}}\left[  g\right]  $ is indeed $0$).

But if $\Lambda$ is a lacunar subset of $\left[  n\right]  $, and if $g\in G$,
then we have the following logical equivalence:%
\begin{align*}
&  \ \left(  \Lambda\cap\operatorname*{FE}\left(  g\right)  =\varnothing
\right) \\
&  \Longleftrightarrow\ \left(  \text{no }i\in\Lambda\text{ satisfies }%
i\in\operatorname*{FE}\left(  g\right)  \right) \\
&  \Longleftrightarrow\ \left(  \text{each }i\in\Lambda\text{ satisfies
}i\notin\operatorname*{FE}\left(  g\right)  \right) \\
&  \Longleftrightarrow\ \left(  \text{each }i\in\Lambda\text{ satisfies
}\underbrace{i\neq\min\left(  g^{-1}\left(  h\right)  \right)  \text{ for all
}h\in\left\{  1,2,3,\ldots,\infty\right\}  }_{\substack{\Longleftrightarrow
\ \left(  g\left(  i\right)  =g\left(  i-1\right)  \right)  \\\text{(since
}g\text{ is weakly increasing, and }g\left(  0\right)  =0\text{)}}}\right. \\
&  \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \left.  \text{and }%
\underbrace{i\neq\max\left(  g^{-1}\left(  h\right)  \right)  \ \text{for
all}\ h\in\left\{  0,1,2,3,\ldots\right\}  }_{\substack{\Longleftrightarrow
\ \left(  g\left(  i\right)  =g\left(  i+1\right)  \right)  \\\text{(since
}g\text{ is weakly increasing, and }g\left(  n+1\right)  =\infty\text{)}%
}}\right) \\
&  \Longleftrightarrow\ \left(  \text{each }i\in\Lambda\text{ satisfies
}\underbrace{g\left(  i\right)  =g\left(  i-1\right)  }_{\Longleftrightarrow
\ \left(  i\in\operatorname*{Stag}\left(  g\right)  \right)  }\text{ and
}\underbrace{g\left(  i\right)  =g\left(  i+1\right)  }_{\Longleftrightarrow
\ \left(  i+1\in\operatorname*{Stag}\left(  g\right)  \right)  }\right) \\
&  \Longleftrightarrow\ \left(  \text{each }i\in\Lambda\text{ satisfies }%
i\in\operatorname*{Stag}\left(  g\right)  \text{ and }i+1\in
\operatorname*{Stag}\left(  g\right)  \right) \\
&  \Longleftrightarrow\ \left(  \Lambda\cup\left(  \Lambda+1\right)
\subseteq\operatorname*{Stag}\left(  g\right)  \right)  \ \Longleftrightarrow
\ \left(  \operatorname*{Stag}\left(  g\right)  \supseteq\Lambda\cup\left(
\Lambda+1\right)  \right)  .
\end{align*}
Hence, if $\Lambda$ is a lacunar subset of $\left[  n\right]  $, then the
condition $\Lambda\cap\operatorname*{FE}\left(  g\right)  =\varnothing$ is
equivalent to the condition $\operatorname*{Stag}\left(  g\right)
\supseteq\Lambda\cup\left(  \Lambda+1\right)  $. Thus, for each lacunar subset
$\Lambda$ of $\left[  n\right]  $, the definition of $\widetilde{L}_{\Lambda}$
becomes%
\[
\widetilde{L}_{\Lambda}=\sum_{\substack{g\in G;\\\Lambda\cap\operatorname*{FE}%
\left(  g\right)  =\varnothing}}\left[  g\right]  =\sum_{\substack{g\in
G;\\\operatorname*{Stag}\left(  g\right)  \supseteq\Lambda\cup\left(
\Lambda+1\right)  }}\left[  g\right]  .
\]
Hence, the family $\left(  \widetilde{L}_{\Lambda}\right)  _{\Lambda
\subseteq\left[  n\right]  \text{ is lacunar}}$ is a subfamily of the family
$\left(  \sum_{\substack{g\in G;\\\operatorname*{Stag}\left(  g\right)
\supseteq T}}\left[  g\right]  \right)  _{T\subseteq\left[  n+1\right]  }$
(because if $\Lambda$ is a lacunar subset of $\left[  n\right]  $, then
$\Lambda\cup\left(  \Lambda+1\right)  $ is a well-defined subset of $\left[
n+1\right]  $, and moreover $\Lambda$ can be uniquely recovered from
$\Lambda\cup\left(  \Lambda+1\right)  $\ \ \ \ \footnote{This takes a bit of
thought to check. You need to show that if $\Lambda_{1}$ and $\Lambda_{2}$ are
two lacunar subsets of $\left[  n\right]  $ satisfying $\Lambda_{1}\cup\left(
\Lambda_{1}+1\right)  =\Lambda_{2}\cup\left(  \Lambda_{2}+1\right)  $, then
$\Lambda_{1}=\Lambda_{2}$. In order to prove this, assume the contrary, and
conclude that there is a smallest element $h$ of the symmetric difference
$\Lambda_{1}\bigtriangleup\Lambda_{2}$. WLOG assume that $h\in\Lambda
_{1}\setminus\Lambda_{2}$, and argue that $h$ belongs to $\Lambda_{1}%
\cup\left(  \Lambda_{1}+1\right)  $ but not to $\Lambda_{2}\cup\left(
\Lambda_{2}+1\right)  $, which contradicts $\Lambda_{1}\cup\left(  \Lambda
_{1}+1\right)  =\Lambda_{2}\cup\left(  \Lambda_{2}+1\right)  $.}). The further
argument depends on the parity of $n$:

\begin{itemize}
\item If $n$ is odd, then the vanishing element $\sum_{\substack{g\in
G;\\\operatorname*{Stag}\left(  g\right)  \supseteq\left[  n+1\right]
}}\left[  g\right]  $ does appear in the family $\left(  \widetilde{L}%
_{\Lambda}\right)  _{\Lambda\subseteq\left[  n\right]  \text{ is lacunar}}$,
because there exists a lacunar subset $\Lambda$ of $\left[  n\right]  $
satisfying $\Lambda\cup\left(  \Lambda+1\right)  =\left[  n+1\right]  $:
Namely, this $\Lambda$ is $\Omega$. Thus, the only syzygy of the family
$\left(  \widetilde{L}_{\Lambda}\right)  _{\Lambda\subseteq\left[  n\right]
\text{ is lacunar}}$ is $\widetilde{L}_{\Omega}=0$ (since the only syzygy of
the family $\left(  \sum_{\substack{g\in G;\\\operatorname*{Stag}\left(
g\right)  \supseteq T}}\left[  g\right]  \right)  _{T\subseteq\left[
n+1\right]  }$ is $\sum_{\substack{g\in G;\\\operatorname*{Stag}\left(
g\right)  \supseteq\left[  n+1\right]  }}\left[  g\right]  =0$).

\item If $n$ is even, then the vanishing element $\sum_{\substack{g\in
G;\\\operatorname*{Stag}\left(  g\right)  \supseteq\left[  n+1\right]
}}\left[  g\right]  $ does not appear in the family $\left(  \widetilde{L}%
_{\Lambda}\right)  _{\Lambda\subseteq\left[  n\right]  \text{ is lacunar}}$,
since no lacunar subset $\Lambda$ of $\left[  n\right]  $ satisfies
$\Lambda\cup\left(  \Lambda+1\right)  =\left[  n+1\right]  $. Hence, the
syzygy $\sum_{\substack{g\in G;\\\operatorname*{Stag}\left(  g\right)
\supseteq\left[  n+1\right]  }}\left[  g\right]  =0$ of the family $\left(
\sum_{\substack{g\in G;\\\operatorname*{Stag}\left(  g\right)  \supseteq
T}}\left[  g\right]  \right)  _{T\subseteq\left[  n+1\right]  }$ disappears
when we pass to the subfamily $\left(  \widetilde{L}_{\Lambda}\right)
_{\Lambda\subseteq\left[  n\right]  \text{ is lacunar}}$. Consequently, the
subfamily $\left(  \widetilde{L}_{\Lambda}\right)  _{\Lambda\subseteq\left[
n\right]  \text{ is lacunar}}$ is $\mathbb{Q}$-linearly independent.
\end{itemize}

This proves Claim 3. As explained above, this yields Claim 2, hence also Claim
1, and thus completes the proof of Proposition \ref{prop.KnL.lindep}.
\end{proof}

\begin{corollary}
\label{cor.KnL.lindep-all}The family%
\[
\left(  K_{n,\Lambda}^{\mathcal{Z}}\right)  _{n\in\mathbb{N};\ \Lambda
\subseteq\left[  n\right]  \text{ is lacunar and nonempty}}%
\]
is $\mathbb{Q}$-linearly independent.
\end{corollary}

\begin{proof}
[Proof of Corollary \ref{cor.KnL.lindep-all}.]For each $n\in\mathbb{N}$, the
family $\left(  K_{n,\Lambda}^{\mathcal{Z}}\right)  _{\Lambda\subseteq\left[
n\right]  \text{ is lacunar and nonempty}}$ is $\mathbb{Q}$-linearly
independent (by Proposition \ref{prop.KnL.lindep}). Furthermore, these
families for varying $n\in\mathbb{N}$ live in linearly disjoint subspaces of
$\operatorname*{Pow}\mathcal{N}$ (because for each $n\in\mathbb{N}$, the power
series $K_{n,\Lambda}^{\mathcal{Z}}$ is homogeneous of degree $n$). Thus, the
union $\left(  K_{n,\Lambda}^{\mathcal{Z}}\right)  _{n\in\mathbb{N}%
;\ \Lambda\subseteq\left[  n\right]  \text{ is lacunar and nonempty}}$ of all
these families must also be $\mathbb{Q}$-linearly independent. This proves
Corollary \ref{cor.KnL.lindep-all}.
\end{proof}

\begin{definition}
Let $\Pi_{\mathcal{Z}}$ be the $\mathbb{Q}$-vector subspace of
$\operatorname*{Pow}\mathcal{N}$ spanned by the family $\left(  K_{n,\Lambda
}^{\mathcal{Z}}\right)  _{n\in\mathbb{N};\ \Lambda\subseteq\left[  n\right]
\text{ is lacunar and nonempty}}$. Then, $\Pi_{\mathcal{Z}}$ is also the
$\mathbb{Q}$-vector subspace of $\operatorname*{Pow}\mathcal{N}$ spanned by
the family $\left(  K_{n,\operatorname*{Epk}\pi}^{\mathcal{Z}}\right)
_{n\in\mathbb{N};\ \pi\text{ is an }n\text{-permutation}}$ (by Proposition
\ref{prop.when-Epk}). In other words, $\Pi_{\mathcal{Z}}$ is also the
$\mathbb{Q}$-vector subspace of $\operatorname*{Pow}\mathcal{N}$ spanned by
the family $\left(  \Gamma_{\mathcal{Z}}\left(  \pi\right)  \right)
_{n\in\mathbb{N};\ \pi\text{ is an }n\text{-permutation}}$ (because of
(\ref{eq.def.KnL.2})). Hence, Corollary \ref{cor.prod2} shows that
$\Pi_{\mathcal{Z}}$ is closed under multiplication. Since furthermore
$\Gamma_{\mathcal{Z}}\left(  \operatorname*{id}\nolimits_{0}\right)  =1$ (for
the empty $0$-permutation $\operatorname*{id}\nolimits_{0}$), we can thus
conclude that $\Pi_{\mathcal{Z}}$ is a $\mathbb{Q}$-subalgebra of
$\operatorname*{Pow}\mathcal{N}$.
\end{definition}

We can now finally prove what we came here for:

\begin{theorem}
\label{thm.Epk.sh-co}\textbf{(a)} The permutation statistic
$\operatorname*{Epk}$ is shuffle-compatible.

\textbf{(b)} The map given by%
\[
\left[  \pi\right]  _{\operatorname*{Epk}}\mapsto K_{n,\operatorname*{Epk}%
}^{\mathcal{Z}}%
\]
is a $\mathbb{Q}$-algebra isomorphism from $\mathcal{A}_{\operatorname*{Epk}}$
to $\Pi_{\mathcal{Z}}$.
\end{theorem}

\begin{proof}
[Proof of Theorem \ref{thm.Epk.sh-co}.]For each $n\in\mathbb{N}$ and each
$n$-permutation $\pi$, we have%
\[
\operatorname*{Epk}\pi=\operatorname*{Lpk}\pi\cup\operatorname*{Rpk}%
\pi=\left(  \operatorname*{Des}\pi\cup\left\{  n\right\}  \right)
\setminus\left(  \operatorname*{Des}\pi+1\right)  .
\]
Thus, $\operatorname*{Epk}\pi$ is uniquely determined by $\operatorname*{Des}%
\pi$ and $n$. Hence, $\operatorname*{Epk}$ is a descent statistic. Thus, for
every composition $L$, a set $\operatorname*{Epk}L$ is defined (according to
Definition \ref{def.des-stat.stI}); explicitly, $\operatorname*{Epk}%
L=\operatorname*{Epk}\pi$ whenever $\pi$ is a permutation satisfying
$\operatorname*{Comp}\pi=L$. Let us spell out this definition: For each
$n\in\mathbb{N}$ and each composition $L$ of $n$, the subset
$\operatorname*{Epk}L$ of $\left[  n\right]  $ is given by%
\[
\operatorname*{Epk}L=\operatorname*{Lpk}L\cup\operatorname*{Rpk}L=\left(
\operatorname*{Des}L\cup\left\{  n\right\}  \right)  \setminus\left(
\operatorname*{Des}L+1\right)  .
\]


Recall that $\left(  F_{L}\right)  _{L\text{ is a composition}}$ is a basis of
the $\mathbb{Q}$-vector space $\operatorname*{QSym}$. Let $\phi
_{\operatorname*{Epk}}:\operatorname*{QSym}\rightarrow\Pi_{\mathcal{Z}}$ be
the $\mathbb{Q}$-linear map that sends each $F_{L}$ (for each $n\in\mathbb{N}$
and each composition $L$ of $n$) to $K_{n,\operatorname*{Epk}L}^{\mathcal{Z}%
}\in\Pi_{\mathcal{Z}}$. This $\mathbb{Q}$-linear map $\phi
_{\operatorname*{Epk}}$ respects multiplication\footnote{\textit{Proof.} Let
$n\in\mathbb{N}$ and $m\in\mathbb{N}$. Let $J$ be a composition of $n$, and
let $K$ be a composition of $m$. Fix an $n$-permutation $\pi$ satisfying
$\operatorname*{Comp}\pi=J$, and fix an $m$-permutation $\sigma$ satisfying
$\operatorname*{Comp}\sigma=K$. Now,%
\begin{align*}
&  \underbrace{\phi_{\operatorname*{Epk}}\left(  F_{J}\right)  }%
_{\substack{=K_{n,\operatorname*{Epk}J}^{\mathcal{Z}}=K_{n,\operatorname*{Epk}%
\pi}^{\mathcal{Z}}\\\text{(since }\operatorname*{Epk}J=\operatorname*{Epk}%
\pi\text{)}}}\cdot\underbrace{\phi_{\operatorname*{Epk}}\left(  F_{K}\right)
}_{\substack{=K_{m,\operatorname*{Epk}K}^{\mathcal{Z}}%
=K_{m,\operatorname*{Epk}\sigma}^{\mathcal{Z}}\\\text{(since }%
\operatorname*{Epk}K=\operatorname*{Epk}\sigma\text{)}}}\\
&  =\underbrace{K_{n,\operatorname*{Epk}\pi}^{\mathcal{Z}}}_{\substack{=\Gamma
_{\mathcal{Z}}\left(  \pi\right)  \\\text{(by (\ref{eq.def.KnL.2}))}}%
}\cdot\underbrace{K_{m,\operatorname*{Epk}\sigma}^{\mathcal{Z}}}%
_{\substack{=\Gamma_{\mathcal{Z}}\left(  \sigma\right)  \\\text{(by
(\ref{eq.def.KnL.2}))}}}=\Gamma_{\mathcal{Z}}\left(  \pi\right)  \cdot
\Gamma_{\mathcal{Z}}\left(  \sigma\right)  =\sum_{\tau\in S\left(  \pi
,\sigma\right)  }\underbrace{\Gamma_{\mathcal{Z}}\left(  \tau\right)
}_{\substack{=K_{n+m,\operatorname*{Epk}\tau}^{\mathcal{Z}}\\\text{(by
(\ref{eq.def.KnL.2}))}}}\ \ \ \ \ \ \ \ \ \ \left(  \text{by Corollary
\ref{cor.prod2}}\right) \\
&  =\sum_{\tau\in S\left(  \pi,\sigma\right)  }K_{n+m,\operatorname*{Epk}\tau
}^{\mathcal{Z}}.
\end{align*}
Comparing this with%
\begin{align*}
\phi_{\operatorname*{Epk}}\left(  \underbrace{F_{J}F_{K}}_{\substack{=\sum
_{\tau\in S\left(  \pi,\sigma\right)  }F_{\operatorname*{Comp}\tau}\\\text{(by
Proposition~\ref{prop.4.1.rewr})}}}\right)   &  =\phi_{\operatorname*{Epk}%
}\left(  \sum_{\tau\in S\left(  \pi,\sigma\right)  }F_{\operatorname*{Comp}%
\tau}\right)  =\sum_{\tau\in S\left(  \pi,\sigma\right)  }\underbrace{\phi
_{\operatorname*{Epk}}\left(  F_{\operatorname*{Comp}\tau}\right)
}_{\substack{=K_{n+m,\operatorname*{Epk}\left(  \operatorname*{Comp}%
\tau\right)  }^{\mathcal{Z}}=K_{n+m,\operatorname*{Epk}\tau}^{\mathcal{Z}%
}\\\text{(since }\operatorname*{Epk}\left(  \operatorname*{Comp}\tau\right)
=\operatorname*{Epk}\tau\text{)}}}\\
&  =\sum_{\tau\in S\left(  \pi,\sigma\right)  }K_{n+m,\operatorname*{Epk}\tau
}^{\mathcal{Z}},
\end{align*}
we obtain $\phi_{\operatorname*{Epk}}\left(  F_{J}\right)  \cdot
\phi_{\operatorname*{Epk}}\left(  F_{K}\right)  =\phi_{\operatorname*{Epk}%
}\left(  F_{J}F_{K}\right)  $. Since the map $\phi_{\operatorname*{Epk}}$ is
$\mathbb{Q}$-linear, this yields that $\phi_{\operatorname*{Epk}}$ respects
multiplication (since $\left(  F_{L}\right)  _{L\text{ is a composition}}$ is
a basis of the $\mathbb{Q}$-vector space $\operatorname*{QSym}$).} and sends
$1\in\operatorname*{QSym}$ to $1\in\Pi_{\mathcal{Z}}$\ \ \ \ \footnote{This is
easy, since $1=F_{\left(  {}\right)  }$.}. Thus, $\phi_{\operatorname*{Epk}}$
is a $\mathbb{Q}$-algebra homomorphism.

The family $\left(  K_{n,\Lambda}^{\mathcal{Z}}\right)  _{n\in\mathbb{N}%
;\ \Lambda\subseteq\left[  n\right]  \text{ is lacunar and nonempty}}$ spans
$\Pi_{\mathcal{Z}}$ (by the definition of $\Pi_{\mathcal{Z}}$) and is
$\mathbb{Q}$-linearly independent (by Corollary \ref{cor.KnL.lindep-all}).
Thus, it is a basis of $\Pi_{\mathcal{Z}}$.

For each $n\in\mathbb{N}$, there is a canonical bijection between the
$\operatorname*{Epk}$-equivalence classes of $n$-permutations and the nonempty
lacunar subsets $\Lambda$ of $\left[  n\right]  $ (indeed, the bijection sends
any equivalence class $\left[  \pi\right]  _{\operatorname*{Epk}}$ to
$\operatorname*{Epk}\pi$)\ \ \ \ \footnote{Proposition \ref{prop.when-Epk}
shows that this is indeed a bijection.}. Hence, Theorem~\ref{thm.4.3}
\textbf{(a)} (applied to $A=\Pi_{\mathcal{Z}}$, $\operatorname*{st}%
=\operatorname*{Epk}$ and $u_{\alpha}=K_{n,\Lambda}^{\mathcal{Z}}$, where
$\alpha$ is an $\operatorname*{Epk}$-equivalence class of $n$-permutations and
where $\Lambda$ is the corresponding nonempty lacunar subset) shows that the
descent statistic $\operatorname*{Epk}$ is shuffle-compatible.
Theorem~\ref{thm.4.3} \textbf{(b)} then yields that the $\mathbb{Q}$-linear
map%
\[
\mathcal{A}_{\operatorname*{Epk}}\rightarrow\Pi_{\mathcal{Z}}%
,\ \ \ \ \ \ \ \ \ \ \left[  \pi\right]  _{\operatorname*{Epk}}\mapsto
K_{n,\operatorname*{Epk}\pi}^{\mathcal{Z}}%
\]
is a $\mathbb{Q}$-algebra isomorphism from $\mathcal{A}_{\operatorname*{Epk}}$
to $\Pi_{\mathcal{Z}}$. Hence, Theorem \ref{thm.Epk.sh-co} is proven.
\end{proof}

The permutation statistic $\left(  \operatorname*{Lpk},\operatorname*{val}%
\right)  $ (see \cite{part1} for its definition) is equivalent to
$\operatorname*{Epk}$\ \ \ \ \footnote{Indeed, $\operatorname*{val}$ is
equivalent to $\operatorname*{epk}$ by \cite[Lemma 2.1 \textbf{(e)}]{part1};
but knowing $\operatorname*{epk}$ allows you to compute $\operatorname*{Epk}$
from $\operatorname*{Lpk}$ and vice versa (since $\operatorname*{Epk}$ differs
from $\operatorname*{Lpk}$ only in the possible element $n$).}. Thus, an
analogue of Theorem \ref{thm.Epk.sh-co} holds for the statistic $\left(
\operatorname*{Lpk},\operatorname*{val}\right)  $.

\begin{question}
Our concept of a \textquotedblleft$\mathcal{Z}$-enriched $\left(
P,\gamma\right)  $-partition\textquotedblright\ generalizes the concept of an
\textquotedblleft enriched $\left(  P,\gamma\right)  $%
-partition\textquotedblright\ by restricting ourselves to a subset
$\mathcal{Z}$ of $\mathcal{N}\times\left\{  +,-\right\}  $. (This does not
sound like much of a generalization when stated like this, but as we have seen
the behavior of the power series $\Gamma_{\mathcal{Z}}\left(  P,\gamma\right)
$ depends strongly on what $\mathcal{Z}$ is, and is not all anticipated by the
$\mathcal{Z}=\mathcal{N}\times\left\{  +,-\right\}  $ case.) A different
generalization of enriched $\left(  P,\gamma\right)  $-partitions (introduced
by Hsiao and Petersen in \cite{HsiPet10}) are the \textit{colored }$\left(
P,\gamma\right)  $\textit{-partitions}, where the two-element set $\left\{
+,-\right\}  $ is replaced by the set $\left\{  1,\omega,\ldots,\omega
^{m-1}\right\}  $ of all $m$-th roots of unity (where $m$ is a chosen positive
integer, and $\omega$ is a fixed primitive $m$-th root of unity). We can play
various games with this concept. The most natural thing to do seems to be to
consider $m$ arbitrary total orders $<_{0},<_{1},\ldots,<_{m-1}$ on the
codomain $A$ of the labeling $\gamma$ (perhaps with some nice properties such
as all intervals being finite) and an arbitrary subset $\mathcal{Z}$ of
$\mathcal{N}\times\left\{  1,\omega,\ldots,\omega^{m-1}\right\}  $, and define
a $\mathcal{Z}$-enriched colored $\left(  P,\gamma\right)  $-partition to be a
map $f:P\rightarrow\mathcal{Z}$ such that every $x<y$ in $P$ satisfy the
following conditions:

\begin{enumerate}
\item[\textbf{(i)}] We have $f\left(  x\right)  \preccurlyeq f\left(
y\right)  $. (Here, the total order on $\mathcal{N}\times\left\{
1,\omega,\ldots,\omega^{m-1}\right\}  $ is defined by%
\[
\left(  n,\omega^{i}\right)  \prec\left(  n^{\prime},\omega^{i^{\prime}%
}\right)  \text{ if and only if either }n\prec n^{\prime}\text{ or }\left(
n=n^{\prime}\text{ and }i<i^{\prime}\right)
\]
(for $i,i^{\prime}\in\left\{  0,1,\ldots,m-1\right\}  $).)

\item[\textbf{(ii)}] If $f\left(  x\right)  =f\left(  y\right)  =\left(
n,\omega^{i}\right)  $ for some $n\in\mathcal{N}$ and $i\in\left\{
0,1,\ldots,m-1\right\}  $, then $\gamma\left(  x\right)  <_{i}\gamma\left(
y\right)  $.
\end{enumerate}

Is this a useful concept, and can it be used to study descent statistics?
\end{question}

\section{The kernel of the map $\operatorname*{QSym}\rightarrow\mathcal{A}%
_{\operatorname*{Epk}}$}

\subsection{The kernel of a descent statistic}

Now, we shall focus on a feature of shuffle-compatible descent statistics that
seems to have been overlooked so far: their kernels.

\begin{definition}
Let $\operatorname*{st}$ be a descent statistic. Then, $\mathcal{K}%
_{\operatorname*{st}}$ shall mean the $\mathbb{Q}$-vector subspace of
$\operatorname*{QSym}$ spanned by all elements of the form $F_{J}-F_{K}$,
where $J$ and $K$ are two $\operatorname*{st}$-equivalent compositions. (See
Definition \ref{def.des-stat.eq-comp} for the definition of \textquotedblleft%
$\operatorname*{st}$-equivalent compositions\textquotedblright.) We shall
refer to $\mathcal{K}_{\operatorname*{st}}$ as the \textit{kernel} of
$\operatorname*{st}$.
\end{definition}

Theorem~\ref{thm.4.3} easily yields the following fact:

\begin{proposition}
\label{prop.K.ideal}Let $\operatorname*{st}$ be a descent statistic. Then,
$\operatorname*{st}$ is shuffle-compatible if and only if $\mathcal{K}%
_{\operatorname*{st}}$ is an ideal of $\operatorname*{QSym}$. Furthermore, in
this case, $\mathcal{A}_{\operatorname*{st}}\cong\operatorname*{QSym}%
/\mathcal{K}_{\operatorname*{st}}$.
\end{proposition}

\begin{proof}
[Proof of Proposition \ref{prop.K.ideal}.]$\Longrightarrow:$ Assume that
$\operatorname*{st}$ is shuffle-compatible. Thus, Theorem~\ref{thm.4.3}
\textbf{(a)} shows that there exist a $\mathbb{Q}$-algebra $A$ with basis
$\left(  u_{\alpha}\right)  $ indexed by $\operatorname*{st}$-equivalence
classes $\alpha$ of compositions, and a $\mathbb{Q}$-algebra homomorphism
$\phi_{\operatorname*{st}}:\operatorname*{QSym}\rightarrow A$ with the
property that whenever $\alpha$ is an $\operatorname*{st}$-equivalence class
of compositions, we have%
\begin{equation}
\phi_{\operatorname*{st}}\left(  F_{L}\right)  =u_{\alpha}%
\ \ \ \ \ \ \ \ \ \ \text{for each }L\in\alpha. \label{pf.prop.K.ideal.dir1.1}%
\end{equation}
Consider this $A$ and this $\phi_{\operatorname*{st}}$.

The map $\phi_{\operatorname*{st}}$ is a $\mathbb{Q}$-algebra homomorphism.
Thus, its kernel $\operatorname*{Ker}\left(  \phi_{\operatorname*{st}}\right)
$ is an ideal of $\operatorname*{QSym}$.

Let us first show that $\operatorname*{Ker}\left(  \phi_{\operatorname*{st}%
}\right)  \subseteq\mathcal{K}_{\operatorname*{st}}$.

Indeed, let $x\in\operatorname*{Ker}\left(  \phi_{\operatorname*{st}}\right)
$ be arbitrary. Write $x\in\operatorname*{QSym}$ in the form $x=\sum_{L}%
x_{L}F_{L}$, where the sum ranges over all compositions $L$, and where the
$x_{L}$ are elements of $\mathbb{Q}$ (all but finitely many of which are
zero). Now, $x\in\operatorname*{Ker}\left(  \phi_{\operatorname*{st}}\right)
$, so that $\phi_{\operatorname*{st}}\left(  x\right)  =0$. Thus,%
\begin{align*}
0  &  =\phi_{\operatorname*{st}}\left(  x\right)  =\sum_{L}x_{L}%
\phi_{\operatorname*{st}}\left(  F_{L}\right)  \ \ \ \ \ \ \ \ \ \ \left(
\text{since }x=\sum_{L}x_{L}F_{L}\right) \\
&  =\sum_{\alpha}\sum_{L\in\alpha}x_{L}\underbrace{\phi_{\operatorname*{st}%
}\left(  F_{L}\right)  }_{\substack{=u_{\alpha}\\\text{(by
(\ref{pf.prop.K.ideal.dir1.1}))}}}\ \ \ \ \ \ \ \ \ \ \left(
\begin{array}
[c]{c}%
\text{where the first sum is over}\\
\text{all }\operatorname*{st}\text{-equivalence classes }\alpha\text{ of
compositions}%
\end{array}
\right) \\
&  =\sum_{\alpha}\sum_{L\in\alpha}x_{L}u_{\alpha}=\sum_{\alpha}\left(
\sum_{L\in\alpha}x_{L}\right)  u_{\alpha}.
\end{align*}
Since the family $\left(  u_{\alpha}\right)  $ is linearly independent
(because it is a basis of $A$), we thus conclude that
\begin{equation}
\sum_{L\in\alpha}x_{L}=0 \label{pf.prop.K.ideal.dir1.2}%
\end{equation}
for each $\operatorname*{st}$-equivalence class $\alpha$ of compositions.

Now, for each $\operatorname*{st}$-equivalence class $\alpha$ of compositions,
we fix an element $L_{\alpha}$ of $\alpha$. Then, for each $\operatorname*{st}%
$-equivalence class $\alpha$ of compositions and each composition $L\in\alpha
$, we have
\begin{equation}
F_{L}-F_{L_{\alpha}}\in\mathcal{K}_{\operatorname*{st}}
\label{pf.prop.K.ideal.dir1.3}%
\end{equation}
(since the compositions $L$ and $L_{\alpha}$ are $\operatorname*{st}%
$-equivalent\footnote{since both compositions $L$ and $L_{\alpha}$ lie in the
same $\operatorname*{st}$-equivalence class $\alpha$}).

Now,%
\begin{align*}
x  &  =\sum_{L}x_{L}F_{L}\\
&  =\sum_{\alpha}\sum_{L\in\alpha}x_{L}\underbrace{F_{L}}_{=\left(
F_{L}-F_{L_{\alpha}}\right)  +F_{L_{\alpha}}}\ \ \ \ \ \ \ \ \ \ \left(
\begin{array}
[c]{c}%
\text{where the first sum is over}\\
\text{all }\operatorname*{st}\text{-equivalence classes }\alpha\text{ of
compositions}%
\end{array}
\right) \\
&  =\sum_{\alpha}\sum_{L\in\alpha}x_{L}\left(  \left(  F_{L}-F_{L_{\alpha}%
}\right)  +F_{L_{\alpha}}\right) \\
&  =\sum_{\alpha}\sum_{L\in\alpha}x_{L}\underbrace{\left(  F_{L}-F_{L_{\alpha
}}\right)  }_{\substack{\in\mathcal{K}_{\operatorname*{st}}\\\text{(by
(\ref{pf.prop.K.ideal.dir1.3}))}}}+\sum_{\alpha}\underbrace{\sum_{L\in\alpha
}x_{L}}_{\substack{=0\\\text{(by (\ref{pf.prop.K.ideal.dir1.2}))}%
}}F_{L_{\alpha}}\\
&  \in\underbrace{\sum_{\alpha}\sum_{L\in\alpha}x_{L}\mathcal{K}%
_{\operatorname*{st}}}_{\subseteq\mathcal{K}_{\operatorname*{st}}%
}+\underbrace{\sum_{\alpha}0F_{L_{\alpha}}}_{=0}\subseteq\mathcal{K}%
_{\operatorname*{st}}.
\end{align*}


Now, forget that we fixed $x$. We thus have proven that $x\in\mathcal{K}%
_{\operatorname*{st}}$ for each $x\in\operatorname*{Ker}\left(  \phi
_{\operatorname*{st}}\right)  $. In other words, $\operatorname*{Ker}\left(
\phi_{\operatorname*{st}}\right)  \subseteq\mathcal{K}_{\operatorname*{st}}$.

Conversely, it is easy to see that $\mathcal{K}_{\operatorname*{st}}%
\subseteq\operatorname*{Ker}\left(  \phi_{\operatorname*{st}}\right)
$\ \ \ \ \footnote{\textit{Proof.} Recall that $\mathcal{K}%
_{\operatorname*{st}}$ is the $\mathbb{Q}$-vector subspace of
$\operatorname*{QSym}$ spanned by all elements of the form $F_{J}-F_{K}$,
where $J$ and $K$ are two $\operatorname*{st}$-equivalent compositions. Hence,
in order to prove that $\mathcal{K}_{\operatorname*{st}}\subseteq
\operatorname*{Ker}\left(  \phi_{\operatorname*{st}}\right)  $, it suffices to
show that $F_{J}-F_{K}\in\operatorname*{Ker}\left(  \phi_{\operatorname*{st}%
}\right)  $, whenever $J$ and $K$ are two $\operatorname*{st}$-equivalent
compositions. So let $J$ and $K$ be two $\operatorname*{st}$-equivalent
compositions. We must show that $F_{J}-F_{K}\in\operatorname*{Ker}\left(
\phi_{\operatorname*{st}}\right)  $.
\par
The two compositions $J$ and $K$ are $\operatorname*{st}$-equivalent. Hence,
they lie in one and the same $\operatorname*{st}$-equivalence class. Let
$\alpha$ be this $\operatorname*{st}$-equivalence class. Then, $J\in\alpha$
and therefore $\phi_{\operatorname*{st}}\left(  F_{J}\right)  =u_{\alpha}$ (by
(\ref{pf.prop.K.ideal.dir1.1}), applied to $L=J$). Similarly, $\phi
_{\operatorname*{st}}\left(  F_{K}\right)  =u_{\alpha}$. Now, $\phi
_{\operatorname*{st}}\left(  F_{J}-F_{K}\right)  =\underbrace{\phi
_{\operatorname*{st}}\left(  F_{J}\right)  }_{=u_{\alpha}}-\underbrace{\phi
_{\operatorname*{st}}\left(  F_{K}\right)  }_{=u_{\alpha}}=u_{\alpha
}-u_{\alpha}=0$. In other words, $F_{J}-F_{K}\in\operatorname*{Ker}\left(
\phi_{\operatorname*{st}}\right)  $. This completes our proof.}. Combining
this with $\operatorname*{Ker}\left(  \phi_{\operatorname*{st}}\right)
\subseteq\mathcal{K}_{\operatorname*{st}}$, we obtain $\mathcal{K}%
_{\operatorname*{st}}=\operatorname*{Ker}\left(  \phi_{\operatorname*{st}%
}\right)  $. Hence, $\mathcal{K}_{\operatorname*{st}}$ is an ideal of
$\operatorname*{QSym}$ (since $\operatorname*{Ker}\left(  \phi
_{\operatorname*{st}}\right)  $ is an ideal of $\operatorname*{QSym}$).

It remains to show that $\mathcal{A}_{\operatorname*{st}}\cong%
\operatorname*{QSym}/\mathcal{K}_{\operatorname*{st}}$. This is easy: Each
element of the basis $\left(  u_{\alpha}\right)  $ of the $\mathbb{Q}$-vector
space $A$ is contained in the image of $\phi_{\operatorname*{st}}$ (because of
(\ref{pf.prop.K.ideal.dir1.1})). Therefore, the homomorphism $\phi
_{\operatorname*{st}}$ is surjective. Thus, $\phi_{\operatorname*{st}}\left(
\operatorname*{QSym}\right)  =A$. Hence, $A=\phi_{\operatorname*{st}}\left(
\operatorname*{QSym}\right)  \cong\operatorname*{QSym}/\operatorname*{Ker}%
\left(  \phi_{\operatorname*{st}}\right)  $ (by the homomorphism theorem). But
Theorem \ref{thm.4.3} \textbf{(b)} shows that $\mathcal{A}_{\operatorname*{st}%
}\cong A$. Thus, $\mathcal{A}_{\operatorname*{st}}\cong A\cong%
\operatorname*{QSym}/\underbrace{\operatorname*{Ker}\left(  \phi
_{\operatorname*{st}}\right)  }_{=\mathcal{K}_{\operatorname*{st}}%
}=\operatorname*{QSym}/\mathcal{K}_{\operatorname*{st}}$. This finishes the
proof of the $\Longrightarrow$ direction of Proposition \ref{prop.K.ideal}.

$\Longleftarrow:$ Assume that $\mathcal{K}_{\operatorname*{st}}$ is an ideal
of $\operatorname*{QSym}$. We must prove that $\operatorname*{st}$ is shuffle-compatible.

We shall not use this direction of Proposition \ref{prop.K.ideal}, so let us
merely sketch the proof. Let $A$ be the $\mathbb{Q}$-algebra
$\operatorname*{QSym}/\mathcal{K}_{\operatorname*{st}}$. Let $\phi
_{\operatorname*{st}}$ be the canonical projection $\operatorname*{QSym}%
\rightarrow A$; this is clearly a $\mathbb{Q}$-algebra homomorphism.

For each $\operatorname*{st}$-equivalence class $\alpha$ of compositions, we
define an element $u_{\alpha}$ of $A$ by requiring that%
\[
u_{\alpha}=\phi_{\operatorname*{st}}\left(  F_{L}\right)
\ \ \ \ \ \ \ \ \ \ \text{whenever }L\in\alpha.
\]
This is easily seen to be well-defined, because the image $\phi
_{\operatorname*{st}}\left(  F_{L}\right)  $ depends only on $\alpha$ but not
on $L$ (indeed, if $J$ and $K$ are two elements of $\alpha$, then $J$ and $K$
are $\operatorname*{st}$-equivalent, whence $F_{J}-F_{K}\in\mathcal{K}%
_{\operatorname*{st}}$, whence $F_{J}\equiv F_{K}\operatorname{mod}%
\mathcal{K}_{\operatorname*{st}}$ and therefore $\phi_{\operatorname*{st}%
}\left(  F_{J}\right)  =\phi_{\operatorname*{st}}\left(  F_{K}\right)  $).

It is not hard to see that the family $\left(  u_{\alpha}\right)  $ (where
$\alpha$ ranges over all $\operatorname*{st}$-equivalence classes of
compositions) is a basis of the $\mathbb{Q}$-algebra $A$. Hence, Theorem
\ref{thm.4.3} \textbf{(a)} yields that $\operatorname*{st}$ is
shuffle-compatible. This proves the $\Longleftarrow$ direction of Proposition
\ref{prop.K.ideal}.
\end{proof}

\begin{corollary}
\label{cor.Epk.ideal}The kernel $\mathcal{K}_{\operatorname*{Epk}}$ of the
descent statistic $\operatorname*{Epk}$ is an ideal of $\operatorname*{QSym}$.
\end{corollary}

\begin{proof}
[Proof of Corollary \ref{cor.Epk.ideal}.]This follows from Proposition
\ref{prop.K.ideal} (applied to $\operatorname*{st}=\operatorname*{Epk}$),
because of Theorem \ref{thm.Epk.sh-co} \textbf{(a)}.
\end{proof}

We can study the kernel of any descent statistic; in particular, the case of
shuffle-compatible descent statistics appears interesting. Since
$\operatorname*{QSym}$ is isomorphic to a polynomial ring (as an algebra), it
has many ideals, which are rather hopeless to classify or tame; but the ones
obtained as kernels of shuffle-compatible descent statistics might be worth discussing.

\subsection{The F-generating set of $\mathcal{K}_{\operatorname*{Epk}}$}

Let us now focus on $\mathcal{K}_{\operatorname*{Epk}}$, the kernel of
$\operatorname*{Epk}$.

\begin{proposition}
\label{prop.K.Epk.F}If $J=\left(  j_{1},j_{2},\ldots,j_{m}\right)  $ and $K$
are two compositions, then we shall write $J\rightarrow K$ if there exists an
$\ell\in\left\{  2,3,\ldots,m\right\}  $ such that $j_{\ell}>2$ and $K=\left(
j_{1},j_{2},\ldots,j_{\ell-1},1,j_{\ell}-1,j_{\ell+1},j_{\ell+2},\ldots
,j_{m}\right)  $. (In other words, we write $J\rightarrow K$ if $K$ can be
obtained from $J$ by \textquotedblleft splitting\textquotedblright\ some entry
$j_{\ell}>2$ into two consecutive entries $1$ and $j_{\ell}-1$, provided that
this entry was not the first entry -- i.e., we had $\ell>1$ -- and that this
entry was greater than $2$.)

The ideal $\mathcal{K}_{\operatorname*{Epk}}$ of $\operatorname*{QSym}$ is
spanned (as a $\mathbb{Q}$-vector space) by all differences of the form
$F_{J}-F_{K}$, where $J$ and $K$ are two compositions satisfying $J\rightarrow
K$.
\end{proposition}

\begin{example}
We have $\left(  2,1,4,4\right)  \rightarrow\left(  2,1,1,3,4\right)  $, since
the composition $\left(  2,1,1,3,4\right)  $ is obtained from $\left(
2,1,4,4\right)  $ by splitting the third entry (which is $4>2$) into two
consecutive entries $1$ and $3$.

Similarly, $\left(  2,1,4,4\right)  \rightarrow\left(  2,1,4,1,3\right)  $.

But we do not have $\left(  3,1\right)  \rightarrow\left(  1,2,1\right)  $,
because splitting the first entry of the composition is not allowed in the
definition of the relation $\rightarrow$. Also, we do not have $\left(
1,2,1\right)  \rightarrow\left(  1,1,1,1\right)  $, because the entry we are
splitting must be $>2$.

Two compositions $J$ and $K$ satisfying $J\rightarrow K$ must necessarily
satisfy $\left\vert J\right\vert =\left\vert K\right\vert $.

Here are all relations $\rightarrow$ between compositions of size $4$:%
\[
\left(  1,3\right)  \rightarrow\left(  1,1,2\right)  .
\]


Here are all relations $\rightarrow$ between compositions of size $5$:%
\begin{align*}
\left(  1,4\right)   &  \rightarrow\left(  1,1,3\right)  ,\\
\left(  1,3,1\right)   &  \rightarrow\left(  1,1,2,1\right)  ,\\
\left(  1,1,3\right)   &  \rightarrow\left(  1,1,1,2\right)  ,\\
\left(  2,3\right)   &  \rightarrow\left(  2,1,2\right)  .
\end{align*}
There are no relations $\rightarrow$ between compositions of size $\leq3$.
\end{example}

\begin{proof}
[Proof of Proposition \ref{prop.K.Epk.F}.]We begin by proving some simple claims.

\begin{statement}
\textit{Claim 1:} Let $n\in\mathbb{N}$. Let $J$ and $K$ be two compositions of
size $n$. Then, $J\rightarrow K$ if and only if there exists some $k\in\left[
n-1\right]  $ such that
\begin{align*}
\operatorname*{Des}K  &  =\operatorname*{Des}J\cup\left\{  k\right\}
,\ \ \ \ \ \ \ \ \ \ k\notin\operatorname*{Des}J,\\
k-1  &  \in\operatorname*{Des}J\ \ \ \ \ \ \ \ \ \ \text{and}%
\ \ \ \ \ \ \ \ \ \ k+1\notin\operatorname*{Des}J\cup\left\{  n\right\}  .
\end{align*}

\end{statement}

[\textit{Proof of Claim 1:} This is straightforward to check:
\textquotedblleft Splitting\textquotedblright\ an entry of a composition $C$
into two consecutive entries (summing up to the original entry) is always
tantamount to adding a new element to $\operatorname*{Des}C$. The rest is
translating conditions.]

Recall that
\begin{equation}
\operatorname*{Epk}L=\operatorname*{Lpk}L\cup\operatorname*{Rpk}L=\left(
\operatorname*{Des}L\cup\left\{  n\right\}  \right)  \setminus\left(
\operatorname*{Des}L+1\right)  \label{pf.prop.K.Epk.F.1}%
\end{equation}
for any composition $L$ of $n$.

\begin{statement}
\textit{Claim 2:} Let $J$ and $K$ be two compositions satisfying $J\rightarrow
K$. Then, $\operatorname*{Epk}J=\operatorname*{Epk}K$.
\end{statement}

[\textit{Proof of Claim 2:} Easy consequence of Claim 1 and
(\ref{pf.prop.K.Epk.F.1}).]

For any two integers $a$ and $b$, we set $\left[  a,b\right]  =\left\{
a,a+1,\ldots,b\right\}  $. (This is an empty set if $a>b$.)

It is easy to see that every composition $J$ of size $n>0$ satisfies%
\begin{equation}
\left[  \max\left(  \operatorname*{Epk}J\right)  ,n-1\right]  \subseteq
\operatorname*{Des}J \label{pf.prop.K.Epk.F.2}%
\end{equation}
\footnote{\textit{Proof of (\ref{pf.prop.K.Epk.F.2}):} Let $J$ be a
composition of size $n>0$. We shall show that $\left[  \max\left(
\operatorname*{Epk}J\right)  ,n-1\right]  \subseteq\operatorname*{Des}J$.
\par
Indeed, assume the contrary. Thus, $\left[  \max\left(  \operatorname*{Epk}%
J\right)  ,n-1\right]  \not \subseteq \operatorname*{Des}J$. Hence, there
exists some $q\in\left[  \max\left(  \operatorname*{Epk}J\right)  ,n-1\right]
$ satisfying $q\notin\operatorname*{Des}J$. Let $r$ be the \textbf{largest}
such $q$.
\par
Thus, $r\in\left[  \max\left(  \operatorname*{Epk}J\right)  ,n-1\right]  $ but
$r\notin\operatorname*{Des}J$. From $r\in\left[  \max\left(
\operatorname*{Epk}J\right)  ,n-1\right]  \subseteq\left[  n-1\right]  $, we
obtain $r+1\in\left[  n\right]  $. Also, from $r\notin\operatorname*{Des}J$,
we obtain $r+1\notin\operatorname*{Des}J+1$.
\par
From $r\in\left[  \max\left(  \operatorname*{Epk}J\right)  ,n-1\right]  $, we
obtain $r\geq\max\left(  \operatorname*{Epk}J\right)  $, so that
$r+1>r\geq\max\left(  \operatorname*{Epk}J\right)  $ and therefore
$r+1\notin\operatorname*{Epk}J$ (since a number that is higher than
$\max\left(  \operatorname*{Epk}J\right)  $ cannot belong to
$\operatorname*{Epk}J$).
\par
From (\ref{pf.prop.K.Epk.F.1}), we obtain $\operatorname*{Epk}J=\left(
\operatorname*{Des}J\cup\left\{  n\right\}  \right)  \setminus\left(
\operatorname*{Des}J+1\right)  $.
\par
If we had $r+1\in\operatorname*{Des}J\cup\left\{  n\right\}  $, then we would
have $r+1\in\left(  \operatorname*{Des}J\cup\left\{  n\right\}  \right)
\setminus\left(  \operatorname*{Des}J+1\right)  $ (since $r+1\notin%
\operatorname*{Des}J+1$). This would contradict $r+1\notin\operatorname*{Epk}%
J=\left(  \operatorname*{Des}J\cup\left\{  n\right\}  \right)  \setminus
\left(  \operatorname*{Des}J+1\right)  $. Thus, we cannot have $r+1\in
\operatorname*{Des}J\cup\left\{  n\right\}  $. Therefore, $r+1\notin%
\operatorname*{Des}J\cup\left\{  n\right\}  $.
\par
Hence, $r+1\neq n$ (since $r+1\notin\operatorname*{Des}J\cup\left\{
n\right\}  $ but $n\in\left\{  n\right\}  \subseteq\operatorname*{Des}%
J\cup\left\{  n\right\}  $). Combined with $r+1\in\left[  n\right]  $, this
yields $r+1\in\left[  n\right]  \setminus\left\{  n\right\}  =\left[
n-1\right]  $. Combined with $r+1>\max\left(  \operatorname*{Epk}J\right)  $,
this yields $r+1\in\left[  \max\left(  \operatorname*{Epk}J\right)
,n-1\right]  $. Also, $r+1\notin\operatorname*{Des}J$ (since $r+1\notin%
\operatorname*{Des}J\cup\left\{  n\right\}  $).
\par
Thus, $r+1$ is a $q\in\left[  \max\left(  \operatorname*{Epk}J\right)
,n-1\right]  $ satisfying $q\notin\operatorname*{Des}J$. This contradicts the
fact that $r$ is the \textbf{largest} such $q$ (since $r+1$ is clearly larger
than $r$). This contradiction proves that our assumption was wrong; thus,
(\ref{pf.prop.K.Epk.F.2}) is proven.}.

For each $n\in\mathbb{N}$ and each subset $S$ of $\left[  n-1\right]  $, we
define a subset $S^{\circ}$ of $\left[  n-1\right]  $ as follows:%
\[
S_{n}^{\circ}=\left\{  s\in S\ \mid\ s-1\notin S\text{ or }\left[
s,n-1\right]  \subseteq S\right\}  .
\]


Also, for each $n\in\mathbb{N}$ and each nonempty subset $T$ of $\left[
n\right]  $, we define a subset $\rho_{n}\left(  T\right)  $ of $\left[
n-1\right]  $ as follows:%
\[
\rho_{n}\left(  T\right)  =%
\begin{cases}
T\setminus\left\{  n\right\}  , & \text{if }n\in T;\\
T\cup\left[  \max T,n-1\right]  , & \text{if }n\notin T
\end{cases}
.
\]


\begin{statement}
\textit{Claim 3:} Let $n\in\mathbb{N}$. Let $J$ be a composition of size $n$.
Then, $\left(  \operatorname*{Des}J\right)  _{n}^{\circ}=\rho_{n}\left(
\operatorname*{Epk}J\right)  $.
\end{statement}

[\textit{Proof of Claim 3:} Let $g\in\left(  \operatorname*{Des}J\right)
_{n}^{\circ}$. We shall show that $g\in\rho_{n}\left(  \operatorname*{Epk}%
J\right)  $.

From (\ref{pf.prop.K.Epk.F.1}), we obtain $\operatorname*{Epk}J=\left(
\operatorname*{Des}J\cup\left\{  n\right\}  \right)  \setminus\left(
\operatorname*{Des}J+1\right)  $. Thus, the set $\operatorname*{Epk}J$ is
disjoint from $\operatorname*{Des}J+1$.

We have $g\in\left(  \operatorname*{Des}J\right)  _{n}^{\circ}$. Thus, $g$ is
an element of $\operatorname*{Des}J$ satisfying $g-1\notin\operatorname*{Des}%
J$ or $\left[  g,n-1\right]  \subseteq\operatorname*{Des}J$ (by the definition
of $\left(  \operatorname*{Des}J\right)  _{n}^{\circ}$). We are thus in one of
the following two cases:

\textit{Case 1:} We have $g-1\notin\operatorname*{Des}J$.

\textit{Case 2:} We have $\left[  g,n-1\right]  \subseteq\operatorname*{Des}J$.

Let us first consider Case 1. In this case, we have $g-1\notin%
\operatorname*{Des}J$. In other words, $g\notin\operatorname*{Des}J+1$.
Combined with $g\in\operatorname*{Des}J\subseteq\operatorname*{Des}%
J\cup\left\{  n\right\}  $, this yields $g\in\left(  \operatorname*{Des}%
J\cup\left\{  n\right\}  \right)  \setminus\left(  \operatorname*{Des}%
J+1\right)  =\operatorname*{Epk}J$. Moreover, $g\neq n$ (since $g\in
\operatorname*{Des}J\subseteq\left[  n-1\right]  $) and thus $g\in\left(
\operatorname*{Epk}J\right)  \setminus\left\{  n\right\}  $ (since
$g\in\operatorname*{Epk}J$). But each nonempty subset $T$ of $\left[
n\right]  $ satisfies $T\setminus\left\{  n\right\}  \subseteq\rho_{n}\left(
T\right)  $ (by the definition of $\rho_{n}\left(  T\right)  $). Applying this
to $T=\operatorname*{Epk}J$, we obtain $\left(  \operatorname*{Epk}J\right)
\setminus\left\{  n\right\}  \subseteq\rho_{n}\left(  \operatorname*{Epk}%
J\right)  $. Hence, $g\in\left(  \operatorname*{Epk}J\right)  \setminus
\left\{  n\right\}  \subseteq\rho_{n}\left(  \operatorname*{Epk}J\right)  $.
Thus, $g\in\rho_{n}\left(  \operatorname*{Epk}J\right)  $ is proven in Case 1.

Let us now consider Case 2. In this case, we have $\left[  g,n-1\right]
\subseteq\operatorname*{Des}J$. Hence, each of the elements $g,g+1,\ldots,n-1$
belongs to $\operatorname*{Des}J$. In other words, each of the elements
$g+1,g+2,\ldots,n$ belongs to $\operatorname*{Des}J+1$. Hence, none of the
elements $g+1,g+2,\ldots,n$ belongs to $\operatorname*{Epk}J$ (since the set
$\operatorname*{Epk}J$ is disjoint from $\operatorname*{Des}J+1$). Thus,
$\max\left(  \operatorname*{Epk}J\right)  \leq g$. Therefore, $g\in\left[
\max\left(  \operatorname*{Epk}J\right)  ,n-1\right]  $ (since $g\in
\operatorname*{Des}J\subseteq\left[  n-1\right]  $).

Also, $n\notin\operatorname*{Epk}J$\ \ \ \ \footnote{\textit{Proof.} Assume
the contrary. Thus, $n\in\operatorname*{Epk}J$. But none of the elements
$g+1,g+2,\ldots,n$ belongs to $\operatorname*{Epk}J$. Hence, $n$ is not among
the elements $g+1,g+2,\ldots,n$. Therefore, $g\geq n$, so that $g=n$. This
contradicts $g\in\operatorname*{Des}J\subseteq\left[  n-1\right]  $. This
contradiction shows that our assumption was wrong, qed.}. Hence, the
definition of $\rho_{n}\left(  \operatorname*{Epk}J\right)  $ yields $\rho
_{n}\left(  \operatorname*{Epk}J\right)  =\operatorname*{Epk}J\cup\left[
\max\left(  \operatorname*{Epk}J\right)  ,n-1\right]  $. Now,%
\[
g\in\left[  \max\left(  \operatorname*{Epk}J\right)  ,n-1\right]
\subseteq\operatorname*{Epk}J\cup\left[  \max\left(  \operatorname*{Epk}%
J\right)  ,n-1\right]  =\rho_{n}\left(  \operatorname*{Epk}J\right)  .
\]
Hence, $g\in\rho_{n}\left(  \operatorname*{Epk}J\right)  $ is proven in Case 2.

Thus, $g\in\rho_{n}\left(  \operatorname*{Epk}J\right)  $ is proven in both
Cases 1 and 2. This shows that $g\in\rho_{n}\left(  \operatorname*{Epk}%
J\right)  $ always holds.

Forget that we fixed $g$. We thus have proven that $g\in\rho_{n}\left(
\operatorname*{Epk}J\right)  $ for each $g\in\left(  \operatorname*{Des}%
J\right)  _{n}^{\circ}$. In other words, $\left(  \operatorname*{Des}J\right)
_{n}^{\circ}\subseteq\rho_{n}\left(  \operatorname*{Epk}J\right)  $.

Now, let $h\in\rho_{n}\left(  \operatorname*{Epk}J\right)  $ be arbitrary. We
shall prove that $h\in\left(  \operatorname*{Des}J\right)  _{n}^{\circ}$.

We are in one of the following two cases:

\textit{Case 1:} We have $n\in\operatorname*{Epk}J$.

\textit{Case 2:} We have $n\notin\operatorname*{Epk}J$.

Let us first consider Case 1. In this case, we have $n\in\operatorname*{Epk}%
J$, and thus $\rho_{n}\left(  \operatorname*{Epk}J\right)
=\operatorname*{Epk}J\setminus\left\{  n\right\}  $ (by the definition of
$\rho_{n}\left(  \operatorname*{Epk}J\right)  $). Hence,
\[
h\in\rho_{n}\left(  \operatorname*{Epk}J\right)  =\operatorname*{Epk}%
J\setminus\left\{  n\right\}  \subseteq\operatorname*{Epk}J=\left(
\operatorname*{Des}J\cup\left\{  n\right\}  \right)  \setminus\left(
\operatorname*{Des}J+1\right)  .
\]
In other words, $h\in\operatorname*{Des}J\cup\left\{  n\right\}  $ and
$h\notin\operatorname*{Des}J+1$. Since $h\in\operatorname*{Des}J\cup\left\{
n\right\}  $ and $h\neq n$ (because $h\in\rho_{n}\left(  \operatorname*{Epk}%
J\right)  \subseteq\left[  n-1\right]  $), we obtain $h\in\left(
\operatorname*{Des}J\cup\left\{  n\right\}  \right)  \setminus\left\{
j\right\}  \subseteq\operatorname*{Des}J$. From $h\notin\operatorname*{Des}%
J+1$, we obtain $h-1\notin\operatorname*{Des}J$. Thus, $h$ is an element of
$\operatorname*{Des}J$ satisfying $h-1\notin\operatorname*{Des}J$ or $\left[
h,n-1\right]  \subseteq\operatorname*{Des}J$ (in fact, $h-1\notin%
\operatorname*{Des}J$ holds). Thus, $h\in\left(  \operatorname*{Des}J\right)
_{n}^{\circ}$ (by the definition of $\left(  \operatorname*{Des}J\right)
_{n}^{\circ}$). Thus, $h\in\left(  \operatorname*{Des}J\right)  _{n}^{\circ}$
is proven in Case 1.

Let us now consider Case 2. In this case, we have $n\notin\operatorname*{Epk}%
J$. Hence, the definition of $\rho_{n}\left(  \operatorname*{Epk}J\right)  $
yields $\rho_{n}\left(  \operatorname*{Epk}J\right)  =\left(
\operatorname*{Epk}J\right)  \cup\left[  \max\left(  \operatorname*{Epk}%
J\right)  ,n-1\right]  $. Thus, $h\in\rho_{n}\left(  \operatorname*{Epk}%
J\right)  =\left(  \operatorname*{Epk}J\right)  \cup\left[  \max\left(
\operatorname*{Epk}J\right)  ,n-1\right]  $.

If $h\in\operatorname*{Epk}J$, then we can prove $h\in\left(
\operatorname*{Des}J\right)  _{n}^{\circ}$ just as in Case 1. Hence, let us
WLOG assume that we don't have $h\in\operatorname*{Epk}J$. Thus,
$h\notin\operatorname*{Epk}J$. Combined with $h\in\left(  \operatorname*{Epk}%
J\right)  \cup\left[  \max\left(  \operatorname*{Epk}J\right)  ,n-1\right]  $,
this yields%
\begin{align*}
h  &  \in\left(  \left(  \operatorname*{Epk}J\right)  \cup\left[  \max\left(
\operatorname*{Epk}J\right)  ,n-1\right]  \right)  \setminus\left(
\operatorname*{Epk}J\right)  =\left[  \max\left(  \operatorname*{Epk}J\right)
,n-1\right]  \setminus\left(  \operatorname*{Epk}J\right) \\
&  \subseteq\left[  \max\left(  \operatorname*{Epk}J\right)  ,n-1\right]
\subseteq\operatorname*{Des}J\ \ \ \ \ \ \ \ \ \ \left(  \text{by
(\ref{pf.prop.K.Epk.F.2})}\right)  .
\end{align*}
Moreover, from $h\in\left[  \max\left(  \operatorname*{Epk}J\right)
,n-1\right]  $, we obtain $h\geq\max\left(  \operatorname*{Epk}J\right)  $, so
that%
\[
\left[  h,n-1\right]  \subseteq\left[  \max\left(  \operatorname*{Epk}%
J\right)  ,n-1\right]  \subseteq\operatorname*{Des}%
J\ \ \ \ \ \ \ \ \ \ \left(  \text{by (\ref{pf.prop.K.Epk.F.2})}\right)  .
\]
Hence, $h$ is an element of $\operatorname*{Des}J$ satisfying $h-1\notin%
\operatorname*{Des}J$ or $\left[  h,n-1\right]  \subseteq\operatorname*{Des}J$
(namely, $\left[  h,n-1\right]  \subseteq\operatorname*{Des}J$). In other
words, $h\in\left(  \operatorname*{Des}J\right)  _{n}^{\circ}$ (by the
definition of $\left(  \operatorname*{Des}J\right)  _{n}^{\circ}$). Thus,
$h\in\left(  \operatorname*{Des}J\right)  _{n}^{\circ}$ is proven in Case 2.

We have now proven $h\in\left(  \operatorname*{Des}J\right)  _{n}^{\circ}$ in
both Cases 1 and 2. Hence, $h\in\left(  \operatorname*{Des}J\right)
_{n}^{\circ}$ always holds.

Forget that we fixed $h$. We thus have shown that $h\in\left(
\operatorname*{Des}J\right)  _{n}^{\circ}$ for each $h\in\rho_{n}\left(
\operatorname*{Epk}J\right)  $. In other words, $\rho_{n}\left(
\operatorname*{Epk}J\right)  \subseteq\left(  \operatorname*{Des}J\right)
_{n}^{\circ}$. Combining this with $\left(  \operatorname*{Des}J\right)
_{n}^{\circ}\subseteq\rho_{n}\left(  \operatorname*{Epk}J\right)  $, we obtain
$\left(  \operatorname*{Des}J\right)  _{n}^{\circ}=\rho_{n}\left(
\operatorname*{Epk}J\right)  $. This proves Claim 3.]

\begin{statement}
\textit{Claim 4:} Let $n\in\mathbb{N}$. Let $J$ and $K$ be two compositions of
size $n$ satisfying $\operatorname*{Epk}J=\operatorname*{Epk}K$. Then,
$\left(  \operatorname*{Des}J\right)  _{n}^{\circ}=\left(  \operatorname*{Des}%
K\right)  _{n}^{\circ}$.
\end{statement}

[\textit{Proof of Claim 4:} Claim 3 yields $\left(  \operatorname*{Des}%
J\right)  _{n}^{\circ}=\rho_{n}\left(  \operatorname*{Epk}J\right)  $ and
similarly $\left(  \operatorname*{Des}K\right)  _{n}^{\circ}=\rho_{n}\left(
\operatorname*{Epk}K\right)  $. Hence,%
\[
\left(  \operatorname*{Des}J\right)  _{n}^{\circ}=\rho_{n}\left(
\underbrace{\operatorname*{Epk}J}_{=\operatorname*{Epk}K}\right)  =\rho
_{n}\left(  \operatorname*{Epk}K\right)  =\left(  \operatorname*{Des}K\right)
_{n}^{\circ}.
\]
This proves Claim 4.]

We let $\overset{\ast}{\rightarrow}$ be the transitive-and-reflexive closure
of the relation $\rightarrow$. Thus, two compositions $J$ and $K$ satisfy
$J\overset{\ast}{\rightarrow}K$ if and only if there exists a sequence
$\left(  L_{0},L_{1},\ldots,L_{\ell}\right)  $ of compositions satisfying
$L_{0}=J$ and $L_{\ell}=K$ and $L_{0}\rightarrow L_{1}\rightarrow
\cdots\rightarrow L_{\ell}$.

\begin{statement}
\textit{Claim 5:} Let $n\in\mathbb{N}$. Let $K$ be a composition of size $n$.
Then, $\operatorname*{Comp}\left(  \left(  \operatorname*{Des}K\right)
_{n}^{\circ}\right)  \overset{\ast}{\rightarrow}K$.
\end{statement}

[\textit{Proof of Claim 5:} We shall prove Claim 5 by strong induction on
$\left\vert \left(  \operatorname*{Des}K\right)  \setminus\left(
\operatorname*{Des}K\right)  _{n}^{\circ}\right\vert $. Thus, we fix an
$n\in\mathbb{N}$ and a composition $K$ of size $n$, and we assume (as the
induction hypothesis) that each composition $J$ of size $n$ satisfying
$\left\vert \left(  \operatorname*{Des}J\right)  \setminus\left(
\operatorname*{Des}J\right)  _{n}^{\circ}\right\vert <\left\vert \left(
\operatorname*{Des}K\right)  \setminus\left(  \operatorname*{Des}K\right)
_{n}^{\circ}\right\vert $ satisfies $\operatorname*{Comp}\left(  \left(
\operatorname*{Des}J\right)  _{n}^{\circ}\right)  \overset{\ast}{\rightarrow
}J$. Our goal is to prove that $\operatorname*{Comp}\left(  \left(
\operatorname*{Des}K\right)  _{n}^{\circ}\right)  \overset{\ast}{\rightarrow
}K$.

Let $A=\operatorname*{Des}K$. Thus, $K=\operatorname*{Comp}A$ and
$A\subseteq\left[  n-1\right]  $.

Applying (\ref{pf.prop.K.Epk.F.1}) to $L=K$, we obtain $\operatorname*{Epk}%
K=\left(  \operatorname*{Des}K\cup\left\{  n\right\}  \right)  \setminus
\left(  \operatorname*{Des}K+1\right)  =\left(  A\cup\left\{  n\right\}
\right)  \setminus\left(  A+1\right)  $ (since $\operatorname*{Des}K=A$).

Also, $A_{n}^{\circ}\subseteq A$ (since $S_{n}^{\circ}\subseteq S$ for any
subset $S$ of $\left[  n-1\right]  $). If $A_{n}^{\circ}=A$, then we are done
(because if $A_{n}^{\circ}=A$, then $\operatorname*{Comp}\left(  \left(
\underbrace{\operatorname*{Des}K}_{=A}\right)  _{n}^{\circ}\right)
=\operatorname*{Comp}\left(  \underbrace{A_{n}^{\circ}}_{=A}\right)
=\operatorname*{Comp}A=K$, and therefore the reflexivity of $\overset{\ast
}{\rightarrow}$ shows that $\operatorname*{Comp}\left(  \left(
\operatorname*{Des}K\right)  _{n}^{\circ}\right)  \overset{\ast}{\rightarrow
}K$). Hence, we WLOG assume that $A_{n}^{\circ}\neq A$. Thus, $A_{n}^{\circ}$
is a proper subset of $A$ (since $A_{n}^{\circ}\subseteq A$). Therefore, there
exists a $q\in A$ satisfying $q\notin A_{n}^{\circ}$. Let $k$ be the
\textbf{largest} such $q$. Thus, $k\in A$ and $k\notin A_{n}^{\circ}$. Hence,
$k\in A\setminus A_{n}^{\circ}$. Also, $k\in A\subseteq\left[  n-1\right]  $.

Let $J=\operatorname*{Comp}\left(  A\setminus\left\{  k\right\}  \right)  $.
Thus, $\operatorname*{Des}J=A\setminus\left\{  k\right\}  $, so that
$A=\operatorname*{Des}J\cup\left\{  k\right\}  $ (since $k\in A$). Hence,
$\operatorname*{Des}K=A=\operatorname*{Des}J\cup\left\{  k\right\}  $. Also,
$k\notin A\setminus\left\{  k\right\}  =\operatorname*{Des}J$.

Furthermore, $k-1\notin\operatorname*{Des}J$\ \ \ \ \footnote{\textit{Proof.}
Assume the contrary. Thus, $k-1\in\operatorname*{Des}J$. Hence, $k-1\in
\operatorname*{Des}J=A\setminus\left\{  k\right\}  \subseteq A$. Therefore,
the element $k$ of $A$ satisfies $k-1\in A$ or $\left[  k,n-1\right]
\subseteq A$. Thus, the definition of $A_{n}^{\circ}$ yields $k\in
A_{n}^{\circ}$. This contradicts $k\notin A_{n}^{\circ}$. This contradiction
shows that our assumption was false; qed.} and $k+1\notin\operatorname*{Des}%
J\cup\left\{  n\right\}  $\ \ \ \ \footnote{\textit{Proof.} Assume the
contrary. Thus, $k+1\in\operatorname*{Des}J\cup\left\{  n\right\}  $. In other
words, we have $k+1\in\operatorname*{Des}J$ or $k+1=n$. In other words, we are
in one of the following two cases:
\par
\textit{Case 1:} We have $k+1\in\operatorname*{Des}J$.
\par
\textit{Case 2:} We have $k+1=n$.
\par
Let us first consider Case 1. In this case, we have $k+1\in\operatorname*{Des}%
J$. Hence, $k+1\in\operatorname*{Des}J\subseteq\operatorname*{Des}%
J\cup\left\{  k\right\}  =A$. If we had $k+1\notin A_{n}^{\circ}$, then $k+1$
would be a $q\in A$ satisfying $q\notin A_{n}^{\circ}$; this would contradict
the fact that $k$ is the \textbf{largest} such $q$ (since $k+1$ is larger than
$k$). Hence, we cannot have $k+1\notin A_{n}^{\circ}$. Thus, we must have
$k+1\in A_{n}^{\circ}$. In other words, $k+1$ is an element of $A$ satisfying
$\left(  k+1\right)  -1\notin A$ or $\left[  k+1,n-1\right]  \subseteq A$ (by
the definition of $A_{n}^{\circ}$). Since $\left(  k+1\right)  -1\notin A$ is
impossible (because $\left(  k+1\right)  -1=k\in A$), we thus have $\left[
k+1,n-1\right]  \subseteq A$. Now, $\left[  k,n-1\right]
=\underbrace{\left\{  k\right\}  }_{\substack{\subseteq A\\\text{(since }k\in
A\text{)}}}\cup\underbrace{\left[  k+1,n-1\right]  }_{\subseteq A}\subseteq
A\cup A=A$. Thus, the element $k$ of $A$ satisfies $k-1\notin A$ or $\left[
k,n-1\right]  \subseteq A$. In other words, $k\in A_{n}^{\circ}$ (by the
definition of $A_{n}^{\circ}$). This contradicts $k\notin A_{n}^{\circ}$.
Thus, we have found a contradiction in Case 1.
\par
Let us now consider Case 2. In this case, we have $k+1=n$. Hence, $k=n-1$, so
that $\left[  k,n-1\right]  =\left\{  k\right\}  \subseteq A$ (since $k\in
A$). Thus, the element $k$ of $A$ satisfies $k-1\notin A$ or $\left[
k,n-1\right]  \subseteq A$. In other words, $k\in A_{n}^{\circ}$ (by the
definition of $A_{n}^{\circ}$). This contradicts $k\notin A_{n}^{\circ}$.
Thus, we have found a contradiction in Case 2.
\par
We have therefore found a contradiction in each of the two Cases 1 and 2.
Thus, we always get a contradiction, so our assumption must have been wrong.
Qed.}. Hence, we have found a $k\in\left[  n-1\right]  $ satisfying%
\begin{align*}
\operatorname*{Des}K  &  =\operatorname*{Des}J\cup\left\{  k\right\}
,\ \ \ \ \ \ \ \ \ \ k\notin\operatorname*{Des}J,\\
k-1  &  \in\operatorname*{Des}J\ \ \ \ \ \ \ \ \ \ \text{and}%
\ \ \ \ \ \ \ \ \ \ k+1\notin\operatorname*{Des}J\cup\left\{  n\right\}  .
\end{align*}
Therefore, Claim 1 yields $J\rightarrow K$. Thus, Claim 2 yields
$\operatorname*{Epk}J=\operatorname*{Epk}K$. Claim 4 therefore yields $\left(
\operatorname*{Des}J\right)  _{n}^{\circ}=\left(  \operatorname*{Des}K\right)
_{n}^{\circ}=A_{n}^{\circ}$ (since $\operatorname*{Des}K=A$). Thus,%
\begin{align*}
\left\vert \underbrace{\left(  \operatorname*{Des}J\right)  }_{=A\setminus
\left\{  k\right\}  }\setminus\underbrace{\left(  \operatorname*{Des}J\right)
_{n}^{\circ}}_{=A_{n}^{\circ}}\right\vert  &  =\left\vert \underbrace{\left(
A\setminus\left\{  k\right\}  \right)  \setminus A_{n}^{\circ}}_{=\left(
A\setminus A_{n}^{\circ}\right)  \setminus\left\{  k\right\}  }\right\vert
=\left\vert \left(  A\setminus A_{n}^{\circ}\right)  \setminus\left\{
k\right\}  \right\vert \\
&  =\left\vert A\setminus A_{n}^{\circ}\right\vert
-1\ \ \ \ \ \ \ \ \ \ \left(  \text{since }k\in A\setminus A_{n}^{\circ
}\right) \\
&  =\left\vert \left(  \operatorname*{Des}K\right)  \setminus\left(
\operatorname*{Des}K\right)  _{n}^{\circ}\right\vert
\ \ \ \ \ \ \ \ \ \ \left(  \text{since }A=\operatorname*{Des}K\right)  .
\end{align*}
Thus, the induction hypothesis shows that $\operatorname*{Comp}\left(  \left(
\operatorname*{Des}J\right)  _{n}^{\circ}\right)  \overset{\ast}{\rightarrow
}J$. Combining this with $J\rightarrow K$, we obtain $\operatorname*{Comp}%
\left(  \left(  \operatorname*{Des}J\right)  _{n}^{\circ}\right)
\overset{\ast}{\rightarrow}K$ (since $\overset{\ast}{\rightarrow}$ is the
transitive-and-reflexive closure of the relation $\rightarrow$). In light of
$\left(  \operatorname*{Des}J\right)  _{n}^{\circ}=\left(  \operatorname*{Des}%
K\right)  _{n}^{\circ}$, this rewrites as $\operatorname*{Comp}\left(  \left(
\operatorname*{Des}K\right)  _{n}^{\circ}\right)  \overset{\ast}{\rightarrow
}K$. Thus, Claim 5 is proven by induction.]

Now, let $\mathcal{K}^{\prime}$ be the $\mathbb{Q}$-vector subspace of
$\operatorname*{QSym}$ spanned by all differences of the form $F_{J}-F_{K}$,
where $J$ and $K$ are two compositions satisfying $J\rightarrow K$.

\begin{statement}
\textit{Claim 6:} Let $J$ and $K$ be two compositions such that
$J\overset{\ast}{\rightarrow}K$. Then, $F_{J}-F_{K}\in\mathcal{K}^{\prime}$.
\end{statement}

[\textit{Proof of Claim 6:} We have $J\overset{\ast}{\rightarrow}K$. By the
definition of the relation $\overset{\ast}{\rightarrow}$, this means that
there exists a sequence $\left(  L_{0},L_{1},\ldots,L_{\ell}\right)  $ of
compositions satisfying $L_{0}=J$ and $L_{\ell}=K$ and $L_{0}\rightarrow
L_{1}\rightarrow\cdots\rightarrow L_{\ell}$. Consider this sequence. For each
$i\in\left\{  0,1,\ldots,\ell-1\right\}  $, we have $L_{i}\rightarrow L_{i+1}$
and thus $F_{L_{i}}-F_{L_{i+1}}\in\mathcal{K}^{\prime}$ (by the definition of
$\mathcal{K}^{\prime}$). Therefore, $\sum_{i=0}^{\ell-1}\left(  F_{L_{i}%
}-F_{L_{i+1}}\right)  \in\mathcal{K}^{\prime}$. In light of%
\begin{align*}
\sum_{i=0}^{\ell-1}\left(  F_{L_{i}}-F_{L_{i+1}}\right)   &  =F_{L_{0}%
}-F_{L_{\ell}}\ \ \ \ \ \ \ \ \ \ \left(  \text{by the telescope
principle}\right) \\
&  =F_{J}-F_{K}\ \ \ \ \ \ \ \ \ \ \left(  \text{since }L_{0}=J\text{ and
}L_{\ell}=K\right)  ,
\end{align*}
this rewrites as $F_{J}-F_{K}\in\mathcal{K}^{\prime}$. This proves Claim 6.]

\begin{statement}
\textit{Claim 7:} We have $\mathcal{K}_{\operatorname*{Epk}}\subseteq
\mathcal{K}^{\prime}$.
\end{statement}

[\textit{Proof of Claim 7:} Recall that $\mathcal{K}_{\operatorname*{Epk}}$ is
the $\mathbb{Q}$-vector subspace of $\operatorname*{QSym}$ spanned by all
elements of the form $F_{J}-F_{K}$, where $J$ and $K$ are two
$\operatorname*{Epk}$-equivalent compositions. Thus, it suffices to show that
if $J$ and $K$ are two $\operatorname*{Epk}$-equivalent compositions, then
$F_{J}-F_{K}\in\mathcal{K}^{\prime}$.

So let $J$ and $K$ be two $\operatorname*{Epk}$-equivalent compositions. We
must prove that $F_{J}-F_{K}\in\mathcal{K}^{\prime}$.

The compositions $J$ and $K$ are $\operatorname*{Epk}$-equivalent; in other
words, they have the same size and satisfy $\operatorname*{Epk}%
J=\operatorname*{Epk}K$. Let $n=\left\vert J\right\vert =\left\vert
K\right\vert $. (This is well-defined, since the compositions $J$ and $K$ have
the same size.)

Claim 4 yields $\left(  \operatorname*{Des}J\right)  _{n}^{\circ}=\left(
\operatorname*{Des}K\right)  _{n}^{\circ}$. But Claim 5 yields
$\operatorname*{Comp}\left(  \left(  \operatorname*{Des}K\right)  _{n}^{\circ
}\right)  \overset{\ast}{\rightarrow}K$. Hence, Claim 6 (applied to
$\operatorname*{Comp}\left(  \left(  \operatorname*{Des}K\right)  _{n}^{\circ
}\right)  $ instead of $J$) shows that $F_{\operatorname*{Comp}\left(  \left(
\operatorname*{Des}K\right)  _{n}^{\circ}\right)  }-F_{K}\in\mathcal{K}%
^{\prime}$. The same argument (applied to $J$ instead of $K$) shows that
$F_{\operatorname*{Comp}\left(  \left(  \operatorname*{Des}J\right)
_{n}^{\circ}\right)  }-F_{J}\in\mathcal{K}^{\prime}$. Now,%
\begin{align*}
&  \left(  F_{\operatorname*{Comp}\left(  \left(  \operatorname*{Des}K\right)
_{n}^{\circ}\right)  }-F_{K}\right)  -\left(  F_{\operatorname*{Comp}\left(
\left(  \operatorname*{Des}J\right)  _{n}^{\circ}\right)  }-F_{J}\right) \\
&  =\left(  F_{\operatorname*{Comp}\left(  \left(  \operatorname*{Des}%
K\right)  _{n}^{\circ}\right)  }-\underbrace{F_{\operatorname*{Comp}\left(
\left(  \operatorname*{Des}J\right)  _{n}^{\circ}\right)  }}%
_{\substack{=F_{\operatorname*{Comp}\left(  \left(  \operatorname*{Des}%
K\right)  _{n}^{\circ}\right)  }\\\text{(since }\left(  \operatorname*{Des}%
J\right)  _{n}^{\circ}=\left(  \operatorname*{Des}K\right)  _{n}^{\circ
}\text{)}}}\right)  +F_{J}-F_{K}\\
&  =\underbrace{\left(  F_{\operatorname*{Comp}\left(  \left(
\operatorname*{Des}K\right)  _{n}^{\circ}\right)  }-F_{\operatorname*{Comp}%
\left(  \left(  \operatorname*{Des}K\right)  _{n}^{\circ}\right)  }\right)
}_{=0}+F_{J}-F_{K}=F_{J}-F_{K},
\end{align*}
so that%
\[
F_{J}-F_{K}=\underbrace{\left(  F_{\operatorname*{Comp}\left(  \left(
\operatorname*{Des}K\right)  _{n}^{\circ}\right)  }-F_{K}\right)  }%
_{\in\mathcal{K}^{\prime}}-\underbrace{\left(  F_{\operatorname*{Comp}\left(
\left(  \operatorname*{Des}J\right)  _{n}^{\circ}\right)  }-F_{J}\right)
}_{\in\mathcal{K}^{\prime}}\in\mathcal{K}^{\prime}-\mathcal{K}^{\prime
}\subseteq\mathcal{K}^{\prime}.
\]
This proves Claim 7.]

\begin{statement}
\textit{Claim 8:} We have $\mathcal{K}^{\prime}\subseteq\mathcal{K}%
_{\operatorname*{Epk}}$.
\end{statement}

[\textit{Proof of Claim 8:} Recall that $\mathcal{K}^{\prime}$ is the
$\mathbb{Q}$-vector subspace of $\operatorname*{QSym}$ spanned by all
differences of the form $F_{J}-F_{K}$, where $J$ and $K$ are two compositions
satisfying $J\rightarrow K$. Thus, it suffices to show that if $J$ and $K$ are
two compositions satisfying $J\rightarrow K$, then $F_{J}-F_{K}\in
\mathcal{K}_{\operatorname*{Epk}}$.

So let $J$ and $K$ be two compositions satisfying $J\rightarrow K$. We must
prove that $F_{J}-F_{K}\in\mathcal{K}_{\operatorname*{Epk}}$.

We have $J\rightarrow K$ and thus $J\overset{\ast}{\rightarrow}K$ (since
$\overset{\ast}{\rightarrow}$ is the transitive-and-reflexive closure of the
relation $\rightarrow$). Hence, Claim 6 shows that $F_{J}-F_{K}\in
\mathcal{K}^{\prime}$. This proves Claim 8.]

Combining Claim 7 and Claim 8, we obtain $\mathcal{K}_{\operatorname*{Epk}%
}=\mathcal{K}^{\prime}$. Recalling the definition of $\mathcal{K}^{\prime}$,
we can rewrite this as follows: $\mathcal{K}_{\operatorname*{Epk}}$ is the
$\mathbb{Q}$-vector subspace of $\operatorname*{QSym}$ spanned by all
differences of the form $F_{J}-F_{K}$, where $J$ and $K$ are two compositions
satisfying $J\rightarrow K$. This proves Proposition \ref{prop.K.Epk.F}.
\end{proof}

\subsection{The M-generating set of $\mathcal{K}_{\operatorname*{Epk}}$}

Another characterization of the ideal $\mathcal{K}_{\operatorname*{Epk}}$ of
$\operatorname*{QSym}$ can be obtained using the monomial basis of
$\operatorname*{QSym}$. Let us first recall how said basis is defined:

For any composition $\alpha=\left(  \alpha_{1},\alpha_{2},\ldots,\alpha_{\ell
}\right)  $, we let%
\[
M_{\alpha}=\sum_{i_{1}<i_{2}<\cdots<i_{\ell}}x_{i_{1}}^{\alpha_{1}}x_{i_{2}%
}^{\alpha_{2}}\cdots x_{i_{\ell}}^{\alpha_{\ell}}%
\]
(where the sum is over all strictly increasing $\ell$-tuples $\left(
i_{1},i_{2},\ldots,i_{\ell}\right)  $ of positive integers). This power series
$M_{\alpha}$ belongs to $\operatorname*{QSym}$. The family $\left(  M_{\alpha
}\right)  _{\alpha\text{ is a composition}}$ is a basis of the $\mathbb{Q}%
$-vector space $\operatorname*{QSym}$; it is called the \textit{monomial
basis} of $\operatorname*{QSym}$.

\begin{proposition}
\label{prop.K.Epk.M}If $J=\left(  j_{1},j_{2},\ldots,j_{m}\right)  $ and $K$
are two compositions, then we shall write $J\underset{M}{\rightarrow}K$ if
there exists an $\ell\in\left\{  2,3,\ldots,m\right\}  $ such that $j_{\ell
}>2$ and $K=\left(  j_{1},j_{2},\ldots,j_{\ell-1},2,j_{\ell}-2,j_{\ell
+1},j_{\ell+2},\ldots,j_{m}\right)  $. (In other words, we write
$J\underset{M}{\rightarrow}K$ if $K$ can be obtained from $J$ by
\textquotedblleft splitting\textquotedblright\ some entry $j_{\ell}>2$ into
two consecutive entries $2$ and $j_{\ell}-2$, provided that this entry was not
the first entry -- i.e., we had $\ell>1$ -- and that this entry was greater
than $2$.)

The ideal $\mathcal{K}_{\operatorname*{Epk}}$ of $\operatorname*{QSym}$ is
spanned (as a $\mathbb{Q}$-vector space) by all sums of the form $M_{J}+M_{K}%
$, where $J$ and $K$ are two compositions satisfying
$J\underset{M}{\rightarrow}K$.
\end{proposition}

\begin{example}
We have $\left(  2,1,4,4\right)  \underset{M}{\rightarrow}\left(
2,1,2,2,4\right)  $, since the composition $\left(  2,1,2,2,4\right)  $ is
obtained from $\left(  2,1,4,4\right)  $ by splitting the third entry (which
is $4>2$) into two consecutive entries $2$ and $2$.

Similarly, $\left(  2,1,4,4\right)  \underset{M}{\rightarrow}\left(
2,1,4,2,2\right)  $ and $\left(  2,1,5,4\right)  \underset{M}{\rightarrow
}\left(  2,1,2,3,4\right)  $.

But we do not have $\left(  3,1\right)  \underset{M}{\rightarrow}\left(
2,1,1\right)  $, because splitting the first entry of the composition is not
allowed in the definition of the relation $\underset{M}{\rightarrow}$.

Two compositions $J$ and $K$ satisfying $J\underset{M}{\rightarrow}K$ must
necessarily satisfy $\left\vert J\right\vert =\left\vert K\right\vert $.

Here are all relations $\underset{M}{\rightarrow}$ between compositions of
size $4$:%
\[
\left(  1,3\right)  \underset{M}{\rightarrow}\left(  1,2,1\right)  .
\]


Here are all relations $\underset{M}{\rightarrow}$ between compositions of
size $5$:%
\begin{align*}
\left(  1,4\right)   &  \underset{M}{\rightarrow}\left(  1,2,2\right)  ,\\
\left(  1,3,1\right)   &  \underset{M}{\rightarrow}\left(  1,2,1,1\right)  ,\\
\left(  1,1,3\right)   &  \underset{M}{\rightarrow}\left(  1,1,2,1\right)  ,\\
\left(  2,3\right)   &  \underset{M}{\rightarrow}\left(  2,2,1\right)  .
\end{align*}
There are no relations $\underset{M}{\rightarrow}$ between compositions of
size $\leq3$.
\end{example}

Before we start proving Proposition \ref{prop.K.Epk.M}, let us recall a basic
formula that connects the monomial quasisymmetric functions with the
fundamental quasisymmetric functions:

\begin{proposition}
\label{prop.M-through-F.1}Let $n\in\mathbb{N}$. Let $\alpha$ be any
composition of $n$. Then,%
\[
M_{\alpha}=\sum_{\substack{\beta\text{ is a composition}\\\text{of }n\text{
that refines }\alpha}}\left(  -1\right)  ^{\ell\left(  \beta\right)
-\ell\left(  \alpha\right)  }F_{\beta}.
\]

\end{proposition}

\begin{proof}
[Proof of Proposition \ref{prop.M-through-F.1}.]This precisely \cite[(5.2.2)]%
{HopfComb}. (If the numbering shifts: This is the formula in Proposition 5.2.8.)
\end{proof}

\begin{proposition}
\label{prop.M-through-F.2}Let $n$ be a positive integer. Let $C$ be a subset
of $\left[  n-1\right]  $.

\textbf{(a)} Then,%
\[
M_{\operatorname*{Comp}C}=\sum_{B\supseteq C}\left(  -1\right)  ^{\left\vert
B\setminus C\right\vert }F_{\operatorname*{Comp}B}.
\]
(The bound variable $B$ in this sum and any similar sums is supposed to be a
subset of $\left[  n-1\right]  $; thus, the above sum ranges over all subsets
$B$ of $\left[  n-1\right]  $ satisfying $B\supseteq C$.)

\textbf{(b)} Let $k\in\left[  n-1\right]  $ be such that $k\notin C$. Then,%
\[
M_{\operatorname*{Comp}C}+M_{\operatorname*{Comp}\left(  C\cup\left\{
k\right\}  \right)  }=\sum_{\substack{B\supseteq C;\\k\notin B}}\left(
-1\right)  ^{\left\vert B\setminus C\right\vert }F_{\operatorname*{Comp}B}.
\]


\textbf{(c)} Let $k\in\left[  n-1\right]  $ be such that $k\notin C$ and
$k-1\notin C\cup\left\{  0\right\}  $. Then,%
\[
M_{\operatorname*{Comp}C}+M_{\operatorname*{Comp}\left(  C\cup\left\{
k\right\}  \right)  }=\sum_{\substack{B\supseteq C;\\k\notin B;\\k-1\notin
B}}\left(  -1\right)  ^{\left\vert B\setminus C\right\vert }\left(
F_{\operatorname*{Comp}B}-F_{\operatorname*{Comp}\left(  B\cup\left\{
k-1\right\}  \right)  }\right)  .
\]

\end{proposition}

\begin{proof}
[Proof of Proposition \ref{prop.M-through-F.2}.]\textbf{(a)} Proposition
\ref{prop.M-through-F.2} \textbf{(a)} is the result of applying Proposition
\ref{prop.M-through-F.1} to $\alpha=\operatorname*{Comp}C$ and using the
standard dictionary between compositions of $n$ and subsets of $\left[
n-1\right]  $.

\textbf{(b)} Proposition \ref{prop.M-through-F.2} \textbf{(a)} (applied to
$C\cup\left\{  k\right\}  $ instead of $C$) yields%
\begin{align}
M_{\operatorname*{Comp}\left(  C\cup\left\{  k\right\}  \right)  }  &
=\underbrace{\sum_{B\supseteq C\cup\left\{  k\right\}  }}_{=\sum
_{\substack{B\supseteq C;\\k\in B}}}\underbrace{\left(  -1\right)
^{\left\vert B\setminus\left(  C\cup\left\{  k\right\}  \right)  \right\vert
}}_{\substack{=\left(  -1\right)  ^{\left\vert B\setminus C\right\vert
-1}\\\text{(since }\left\vert B\setminus\left(  C\cup\left\{  k\right\}
\right)  \right\vert =\left\vert B\setminus C\right\vert -1\\\text{(since
}k\notin C\text{))}}}F_{\operatorname*{Comp}B}=\sum_{\substack{B\supseteq
C;\\k\in B}}\underbrace{\left(  -1\right)  ^{\left\vert B\setminus
C\right\vert -1}}_{=-\left(  -1\right)  ^{\left\vert B\setminus C\right\vert
}}F_{\operatorname*{Comp}B}\nonumber\\
&  =-\sum_{\substack{B\supseteq C;\\k\in B}}\left(  -1\right)  ^{\left\vert
B\setminus C\right\vert }F_{\operatorname*{Comp}B}.
\label{pf.prop.M-through-F.2.b.1}%
\end{align}
But Proposition \ref{prop.M-through-F.2} \textbf{(a)} yields
\begin{align*}
M_{\operatorname*{Comp}C}  &  =\sum_{B\supseteq C}\left(  -1\right)
^{\left\vert B\setminus C\right\vert }F_{\operatorname*{Comp}B}\\
&  =\sum_{\substack{B\supseteq C;\\k\in B}}\left(  -1\right)  ^{\left\vert
B\setminus C\right\vert }F_{\operatorname*{Comp}B}+\sum_{\substack{B\supseteq
C;\\k\notin B}}\left(  -1\right)  ^{\left\vert B\setminus C\right\vert
}F_{\operatorname*{Comp}B}.
\end{align*}
Adding (\ref{pf.prop.M-through-F.2.b.1}) to this equality, we obtain%
\begin{align*}
&  M_{\operatorname*{Comp}C}+M_{\operatorname*{Comp}\left(  C\cup\left\{
k\right\}  \right)  }\\
&  =\sum_{\substack{B\supseteq C;\\k\in B}}\left(  -1\right)  ^{\left\vert
B\setminus C\right\vert }F_{\operatorname*{Comp}B}+\sum_{\substack{B\supseteq
C;\\k\notin B}}\left(  -1\right)  ^{\left\vert B\setminus C\right\vert
}F_{\operatorname*{Comp}B}+\left(  -\sum_{\substack{B\supseteq C;\\k\in
B}}\left(  -1\right)  ^{\left\vert B\setminus C\right\vert }%
F_{\operatorname*{Comp}B}\right) \\
&  =\sum_{\substack{B\supseteq C;\\k\notin B}}\left(  -1\right)  ^{\left\vert
B\setminus C\right\vert }F_{\operatorname*{Comp}B}.
\end{align*}
This proves Proposition \ref{prop.M-through-F.2} \textbf{(b)}.

\textbf{(c)} We have $k-1\notin C\cup\left\{  0\right\}  $. Thus, $k-1\notin
C$ and $k-1\neq0$. From $k-1\neq0$, we obtain $k-1\in\left[  n-1\right]  $.

The map%
\begin{align}
&  \left\{  B\subseteq\left[  n-1\right]  \ \mid\ B\supseteq C\text{ and
}k\notin B\text{ and }k-1\notin B\right\} \nonumber\\
&  \rightarrow\left\{  B\subseteq\left[  n-1\right]  \ \mid\ B\supseteq
C\text{ and }k\notin B\text{ and }k-1\in B\right\} \nonumber
\end{align}
sending each $B$ to $B\cup\left\{  k-1\right\}  $ is a bijection (this is easy
to check using the facts that $k-1\notin C$ and $k-1\in\left[  n-1\right]  $).
We shall denote this map by $\Phi$.

Proposition \ref{prop.M-through-F.2} \textbf{(b)} yields
\begin{align*}
&  M_{\operatorname*{Comp}C}+M_{\operatorname*{Comp}\left(  C\cup\left\{
k\right\}  \right)  }\\
&  =\sum_{\substack{B\supseteq C;\\k\notin B}}\left(  -1\right)  ^{\left\vert
B\setminus C\right\vert }F_{\operatorname*{Comp}B}\\
&  =\sum_{\substack{B\supseteq C;\\k\notin B;\\k-1\notin B}}\left(  -1\right)
^{\left\vert B\setminus C\right\vert }F_{\operatorname*{Comp}B}%
+\underbrace{\sum_{\substack{B\supseteq C;\\k\notin B;\\k-1\in B}}\left(
-1\right)  ^{\left\vert B\setminus C\right\vert }F_{\operatorname*{Comp}B}%
}_{\substack{=\sum_{\substack{B\supseteq C;\\k\notin B;\\k-1\notin B}}\left(
-1\right)  ^{\left\vert \left(  B\cup\left\{  k-1\right\}  \right)  \setminus
C\right\vert }F_{\operatorname*{Comp}\left(  B\cup\left\{  k-1\right\}
\right)  }\\\text{(here, we have substituted }B\cup\left\{  k-1\right\}
\text{ for }B\text{ in the sum}\\\text{(since the map }\Phi\text{ is a
bijection))}}}\\
&  =\sum_{\substack{B\supseteq C;\\k\notin B;\\k-1\notin B}}\left(  -1\right)
^{\left\vert B\setminus C\right\vert }F_{\operatorname*{Comp}B}+\sum
_{\substack{B\supseteq C;\\k\notin B;\\k-1\notin B}}\underbrace{\left(
-1\right)  ^{\left\vert \left(  B\cup\left\{  k-1\right\}  \right)  \setminus
C\right\vert }}_{\substack{=\left(  -1\right)  ^{\left\vert B\setminus
C\right\vert +1}\\\text{(since }\left\vert \left(  B\cup\left\{  k-1\right\}
\right)  \setminus C\right\vert =\left\vert B\setminus C\right\vert
+1\\\text{(since }k-1\notin B\text{ and }k-1\notin C\text{))}}%
}F_{\operatorname*{Comp}\left(  B\cup\left\{  k-1\right\}  \right)  }\\
&  =\sum_{\substack{B\supseteq C;\\k\notin B;\\k-1\notin B}}\left(  -1\right)
^{\left\vert B\setminus C\right\vert }F_{\operatorname*{Comp}B}+\sum
_{\substack{B\supseteq C;\\k\notin B;\\k-1\notin B}}\underbrace{\left(
-1\right)  ^{\left\vert B\setminus C\right\vert +1}}_{=-\left(  -1\right)
^{\left\vert B\setminus C\right\vert }}F_{\operatorname*{Comp}\left(
B\cup\left\{  k-1\right\}  \right)  }\\
&  =\sum_{\substack{B\supseteq C;\\k\notin B;\\k-1\notin B}}\left(  -1\right)
^{\left\vert B\setminus C\right\vert }F_{\operatorname*{Comp}B}-\sum
_{\substack{B\supseteq C;\\k\notin B;\\k-1\notin B}}\left(  -1\right)
^{\left\vert B\setminus C\right\vert }F_{\operatorname*{Comp}\left(
B\cup\left\{  k-1\right\}  \right)  }\\
&  =\sum_{\substack{B\supseteq C;\\k\notin B;\\k-1\notin B}}\left(  -1\right)
^{\left\vert B\setminus C\right\vert }\left(  F_{\operatorname*{Comp}%
B}-F_{\operatorname*{Comp}\left(  B\cup\left\{  k-1\right\}  \right)
}\right)  .
\end{align*}
This proves Proposition \ref{prop.M-through-F.2} \textbf{(c)}.
\end{proof}

\begin{proof}
[Proof of Proposition \ref{prop.K.Epk.M}.]We shall use the notation
$\left\langle f_{i}\ \mid\ i\in I\right\rangle $ for the $\mathbb{Q}$-linear
span of a family $\left(  f_{i}\right)  _{i\in I}$ of elements of a
$\mathbb{Q}$-vector space.

Define a $\mathbb{Q}$-vector subspace $\mathcal{M}$ of $\operatorname*{QSym}$
by%
\[
\mathcal{M}=\left\langle M_{J}+M_{K}\ \mid\ J\text{ and }K\text{ are
compositions satisfying }J\underset{M}{\rightarrow}K\right\rangle .
\]
Then, our goal is to prove that $\mathcal{K}_{\operatorname*{Epk}}%
=\mathcal{M}$.

We have%
\begin{align*}
\mathcal{M}  &  =\left\langle M_{J}+M_{K}\ \mid\ J\text{ and }K\text{ are
compositions satisfying }J\underset{M}{\rightarrow}K\right\rangle \\
&  =\sum_{n\in\mathbb{N}}\left\langle M_{J}+M_{K}\ \mid\ J\text{ and }K\text{
are compositions of }n\text{ satisfying }J\underset{M}{\rightarrow
}K\right\rangle
\end{align*}
(because if $J$ and $K$ are two compositions satisfying
$J\underset{M}{\rightarrow}K$, then $J$ and $K$ have the same size).

Consider the binary relation $\rightarrow$ defined in Proposition
\ref{prop.K.Epk.F}. Then, Proposition \ref{prop.K.Epk.F} yields%
\begin{align*}
\mathcal{K}_{\operatorname*{Epk}}  &  =\left\langle F_{J}-F_{K}\ \mid\ J\text{
and }K\text{ are compositions satisfying }J\rightarrow K\right\rangle \\
&  =\sum_{n\in\mathbb{N}}\left\langle F_{J}-F_{K}\ \mid\ J\text{ and }K\text{
are compositions of }n\text{ satisfying }J\rightarrow K\right\rangle
\end{align*}
(because if $J$ and $K$ are two compositions satisfying $J\rightarrow K$, then
$J$ and $K$ have the same size).

Now, fix $n\in\mathbb{N}$. Let $\Omega$ be the set of all pairs $\left(
C,k\right)  $ in which $C$ is a subset of $\left[  n-1\right]  $ and $k$ is an
element of $\left[  n-1\right]  $ satisfying $k\notin C$, $k-1\in C$ and
$k+1\notin C\cup\left\{  n\right\}  $.

For every $\left(  C,k\right)  \in\Omega$, we define two elements
$\mathbf{m}_{C,k}$ and $\mathbf{f}_{C,k}$ of $\operatorname*{QSym}$ by%
\begin{align}
\mathbf{m}_{C,k}  &  =M_{\operatorname*{Comp}C}+M_{\operatorname*{Comp}\left(
C\cup\left\{  k+1\right\}  \right)  }\ \ \ \ \ \ \ \ \ \ \text{and}%
\label{pf.prop.K.Epk.M.mCk=}\\
\mathbf{f}_{C,k}  &  =F_{\operatorname*{Comp}C}-F_{\operatorname*{Comp}\left(
C\cup\left\{  k\right\}  \right)  }. \label{pf.prop.K.Epk.M.fCk=}%
\end{align}
\footnote{These two elements are well-defined, because both $C\cup\left\{
k\right\}  $ and $C\cup\left\{  k+1\right\}  $ are subsets of $\left[
n-1\right]  $ (since $k+1\notin C\cup\left\{  n\right\}  $ shows that $k+1\neq
n$).}

We have the following:

\begin{statement}
\textit{Claim 1:} We have%
\begin{align*}
&  \left\langle M_{J}+M_{K}\ \mid\ J\text{ and }K\text{ are compositions of
}n\text{ satisfying }J\underset{M}{\rightarrow}K\right\rangle \\
&  =\left\langle \mathbf{m}_{C,k}\ \mid\ \left(  C,k\right)  \in
\Omega\right\rangle .
\end{align*}

\end{statement}

[\textit{Proof of Claim 1:} It is easy to see that two subsets $C$ and $D$ of
$\left[  n-1\right]  $ satisfy $\operatorname*{Comp}C\underset{M}{\rightarrow
}\operatorname*{Comp}D$ if and only if there exists some $k\in\left[
n-1\right]  $ satisfying $D=C\cup\left\{  k+1\right\}  $, $k\notin C$, $k-1\in
C$ and $k+1\notin C\cup\left\{  n\right\}  $.\ \ \ \ \footnote{To prove this,
recall that \textquotedblleft splitting\textquotedblright\ an entry of a
composition $J$ into two consecutive entries (summing up to the original
entry) is always tantamount to adding a new element to $\operatorname*{Des}J$.
It suffices to show that the conditions under which an entry of a composition
$J$ can be split in the definition of the relation $\underset{M}{\rightarrow}$
are precisely the conditions $k\notin C$, $k-1\in C$ and $k+1\notin
C\cup\left\{  n\right\}  $ on $C=\operatorname*{Des}J$. This is
straightforward.}. Thus,%
\begin{align*}
&  \left\langle M_{\operatorname*{Comp}C}+M_{\operatorname*{Comp}D}%
\ \mid\ C\text{ and }D\text{ are subsets of }\left[  n-1\right]  \right. \\
&  \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \left.  \text{satisfying
}\operatorname*{Comp}C\underset{M}{\rightarrow}\operatorname*{Comp}%
D\right\rangle \\
&  =\left\langle M_{\operatorname*{Comp}C}+M_{\operatorname*{Comp}D}%
\ \mid\ \text{there exists some }k\in\left[  n-1\right]  \right. \\
&  \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \left.  \text{satisfying }%
D=C\cup\left\{  k+1\right\}  \text{, }k\notin C\text{, }k-1\in C\text{ and
}k+1\notin C\cup\left\{  n\right\}  \right\rangle \\
&  =\left\langle M_{\operatorname*{Comp}C}+M_{\operatorname*{Comp}\left(
C\cup\left\{  k+1\right\}  \right)  }\ \mid\ k\in\left[  n-1\right]  \right.
\\
&  \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \left.  \text{satisfies }k\notin
C\text{, }k-1\in C\text{ and }k+1\notin C\cup\left\{  n\right\}  \right\rangle
\\
&  =\left\langle M_{\operatorname*{Comp}C}+M_{\operatorname*{Comp}\left(
C\cup\left\{  k+1\right\}  \right)  }\ \mid\ k\in\left[  n-1\right]
\ \text{satisfies }\left(  C,k\right)  \in\Omega\right\rangle \\
&  \ \ \ \ \ \ \ \ \ \ \left(  \text{by the definition of }\Omega\right) \\
&  =\left\langle \underbrace{M_{\operatorname*{Comp}C}+M_{\operatorname*{Comp}%
\left(  C\cup\left\{  k+1\right\}  \right)  }}_{\substack{=\mathbf{m}%
_{C,k}\\\text{(by (\ref{pf.prop.K.Epk.M.mCk=}))}}}\ \mid\ \left(  C,k\right)
\in\Omega\right\rangle \\
&  =\left\langle \mathbf{m}_{C,k}\ \mid\ \left(  C,k\right)  \in
\Omega\right\rangle .
\end{align*}
Now, recall that $\operatorname*{Comp}$ is a bijection between the subsets of
$\left[  n-1\right]  $ and the compositions of $n$. Hence,%
\begin{align*}
&  \left\langle M_{J}+M_{K}\ \mid\ J\text{ and }K\text{ are compositions of
}n\text{ satisfying }J\underset{M}{\rightarrow}K\right\rangle \\
&  =\left\langle M_{\operatorname*{Comp}C}+M_{\operatorname*{Comp}D}%
\ \mid\ C\text{ and }D\text{ are subsets of }\left[  n-1\right]  \right. \\
&  \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \left.  \text{satisfying
}\operatorname*{Comp}C\underset{M}{\rightarrow}\operatorname*{Comp}%
D\right\rangle \\
&  =\left\langle \mathbf{m}_{C,k}\ \mid\ \left(  C,k\right)  \in
\Omega\right\rangle .
\end{align*}
This proves Claim 1.]

\begin{statement}
\textit{Claim 2:} We have%
\begin{align*}
&  \left\langle F_{J}-F_{K}\ \mid\ J\text{ and }K\text{ are compositions of
}n\text{ satisfying }J\rightarrow K\right\rangle \\
&  =\left\langle \mathbf{f}_{C,k}\ \mid\ \left(  C,k\right)  \in
\Omega\right\rangle .
\end{align*}

\end{statement}

[\textit{Proof of Claim 2:} It is easy to see that two subsets $C$ and $D$ of
$\left[  n-1\right]  $ satisfy $\operatorname*{Comp}C\rightarrow
\operatorname*{Comp}D$ if and only if there exists some $k\in\left[
n-1\right]  $ satisfying $D=C\cup\left\{  k\right\}  $, $k\notin C$, $k-1\in
C$ and $k+1\notin C\cup\left\{  n\right\}  $.\ \ \ \ \footnote{To prove this,
recall that \textquotedblleft splitting\textquotedblright\ an entry of a
composition $J$ into two consecutive entries (summing up to the original
entry) is always tantamount to adding a new element to $\operatorname*{Des}J$.
It suffices to show that the conditions under which an entry of a composition
$J$ can be split in the definition of the relation $\rightarrow$ are precisely
the conditions $k\notin C$, $k-1\in C$ and $k+1\notin C\cup\left\{  n\right\}
$ on $C=\operatorname*{Des}J$. This is straightforward.}. Thus,%
\begin{align*}
&  \left\langle F_{\operatorname*{Comp}C}-F_{\operatorname*{Comp}D}%
\ \mid\ C\text{ and }D\text{ are subsets of }\left[  n-1\right]  \right. \\
&  \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \left.  \text{satisfying
}\operatorname*{Comp}C\rightarrow\operatorname*{Comp}D\right\rangle \\
&  =\left\langle F_{\operatorname*{Comp}C}-F_{\operatorname*{Comp}D}%
\ \mid\ \text{there exists some }k\in\left[  n-1\right]  \right. \\
&  \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \left.  \text{satisfying }%
D=C\cup\left\{  k\right\}  \text{, }k\notin C\text{, }k-1\in C\text{ and
}k+1\notin C\cup\left\{  n\right\}  \right\rangle \\
&  =\left\langle F_{\operatorname*{Comp}C}-F_{\operatorname*{Comp}\left(
C\cup\left\{  k\right\}  \right)  }\ \mid\ \text{there exists some }%
k\in\left[  n-1\right]  \right. \\
&  \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \left.  \text{satisfying }k\notin
C\text{, }k-1\in C\text{ and }k+1\notin C\cup\left\{  n\right\}  \right\rangle
\\
&  =\left\langle F_{\operatorname*{Comp}C}-F_{\operatorname*{Comp}\left(
C\cup\left\{  k\right\}  \right)  }\ \mid\ \text{there exists some }%
k\in\left[  n-1\right]  \right. \\
&  \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \left.  \text{satisfying }\left(
C,k\right)  \in\Omega\right\rangle \\
&  =\left\langle \underbrace{F_{\operatorname*{Comp}C}-F_{\operatorname*{Comp}%
\left(  C\cup\left\{  k\right\}  \right)  }}_{\substack{=\mathbf{f}%
_{C,k}\\\text{(by (\ref{pf.prop.K.Epk.M.fCk=}))}}}\ \mid\ \left(  C,k\right)
\in\Omega\right\rangle \\
&  =\left\langle \mathbf{f}_{C,k}\ \mid\ \left(  C,k\right)  \in
\Omega\right\rangle .
\end{align*}
Now, recall that $\operatorname*{Comp}$ is a bijection between the subsets of
$\left[  n-1\right]  $ and the compositions of $n$. Hence,%
\begin{align*}
&  \left\langle F_{J}-F_{K}\ \mid\ J\text{ and }K\text{ are compositions of
}n\text{ satisfying }J\rightarrow K\right\rangle \\
&  =\left\langle F_{\operatorname*{Comp}C}-F_{\operatorname*{Comp}D}%
\ \mid\ C\text{ and }D\text{ are subsets of }\left[  n-1\right]  \right. \\
&  \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \left.  \text{satisfying
}\operatorname*{Comp}C\rightarrow\operatorname*{Comp}D\right\rangle \\
&  =\left\langle \mathbf{f}_{C,k}\ \mid\ \left(  C,k\right)  \in
\Omega\right\rangle .
\end{align*}
This proves Claim 2.]

We define a partial order on the set $\Omega$ by setting%
\[
\left(  B,k\right)  \geq\left(  C,\ell\right)  \ \ \ \ \ \ \ \ \ \ \text{if
and only if}\ \ \ \ \ \ \ \ \ \ \left(  k=\ell\text{ and }B\supseteq C\right)
.
\]
Thus, $\Omega$ is a finite poset.

\begin{statement}
\textit{Claim 3:} For every $\left(  C,\ell\right)  \in\Omega$, we have%
\[
\mathbf{m}_{C,\ell}=\sum_{\substack{\left(  B,k\right)  \in\Omega;\\\left(
B,k\right)  \geq\left(  C,\ell\right)  }}\left(  -1\right)  ^{\left\vert
B\setminus C\right\vert }\mathbf{f}_{B,k}.
\]

\end{statement}

[\textit{Proof of Claim 3:} Let $\left(  C,\ell\right)  \in\Omega$. Thus, $C$
is a subset of $\left[  n-1\right]  $ and $\ell$ is an element of $\left[
n-1\right]  $ satisfying $\ell\notin C$, $\ell-1\in C$ and $\ell+1\notin
C\cup\left\{  n\right\}  $. From $\ell+1\notin C\cup\left\{  n\right\}  $, we
obtain $\ell+1\notin C$ and $\ell+1\neq n$. From $\ell+1\neq n$, we obtain
$\ell+1\in\left[  n-1\right]  $. Also, $\left(  \ell+1\right)  -1=\ell\notin
C\cup\left\{  0\right\}  $ (since $\ell\notin C$ and $\ell\neq0$). Thus,
Proposition \ref{prop.M-through-F.2} \textbf{(c)} (applied to $k=\ell+1$)
yields\footnote{Here and in the following, the bound variable $B$ in a sum
always is understood to be a subset of $\left[  n-1\right]  $.}%
\[
M_{\operatorname*{Comp}C}+M_{\operatorname*{Comp}\left(  C\cup\left\{
\ell+1\right\}  \right)  }=\sum_{\substack{B\supseteq C;\\\ell+1\notin
B;\\\ell\notin B}}\left(  -1\right)  ^{\left\vert B\setminus C\right\vert
}\left(  F_{\operatorname*{Comp}B}-F_{\operatorname*{Comp}\left(
B\cup\left\{  \ell\right\}  \right)  }\right)  .
\]


But every $B\subseteq\left[  n-1\right]  $ satisfying $B\supseteq C$ must
satisfy $\ell-1\in B$ (since $\ell-1\in C\subseteq B$). Hence, we can
manipulate summation signs as follows:%
\begin{align}
\sum_{\substack{B\supseteq C;\\\ell+1\notin B;\\\ell\notin B}}  &
=\sum_{\substack{B\supseteq C;\\\ell+1\notin B;\\\ell\notin B;\\\ell-1\in
B}}=\sum_{\substack{B\supseteq C;\\\ell+1\notin B\cup\left\{  n\right\}
;\\\ell\notin B;\\\ell-1\in B}}\ \ \ \ \ \ \ \ \ \ \left(
\begin{array}
[c]{c}%
\text{since }\ell+1\notin B\text{ is equivalent to }\ell+1\notin B\cup\left\{
n\right\} \\
\text{(because }\ell+1\neq n\text{)}%
\end{array}
\right) \nonumber\\
&  =\sum_{\substack{B\supseteq C;\\\ell\notin B;\\\ell-1\in B;\\\ell+1\notin
B\cup\left\{  n\right\}  }}\nonumber\\
&  =\sum_{\substack{B\supseteq C;\\\left(  B,\ell\right)  \in\Omega
}}\ \ \ \ \ \ \ \ \ \ \left(
\begin{array}
[c]{c}%
\text{since the}\\
\text{condition }\left(  \ell\notin B\text{, }\ell-1\in B\text{ and }%
\ell+1\notin B\cup\left\{  n\right\}  \right) \\
\text{on a subset }B\text{ of }\left[  n-1\right]  \text{ is equivalent to
}\left(  B,\ell\right)  \in\Omega\\
\text{(by the definition of }\Omega\text{)}%
\end{array}
\right) \nonumber\\
&  =\sum_{\substack{\left(  B,\ell\right)  \in\Omega;\\B\supseteq C}%
}=\sum_{\substack{\left(  B,k\right)  \in\Omega;\\k=\ell;\\B\supseteq C}%
}=\sum_{\substack{\left(  B,k\right)  \in\Omega;\\\left(  B,k\right)
\geq\left(  C,\ell\right)  }} \label{pf.prop.K.Epk.M.sum-man}%
\end{align}
(since the condition $\left(  k=\ell\text{ and }B\supseteq C\right)  $ on a
$\left(  B,k\right)  \in\Omega$ is equivalent to $\left(  B,k\right)
\geq\left(  C,\ell\right)  $ (by the definition of the partial order on
$\Omega$)).

Now, the definition of $\mathbf{m}_{C,\ell}$ yields%
\begin{align*}
\mathbf{m}_{C,\ell}  &  =M_{\operatorname*{Comp}C}+M_{\operatorname*{Comp}%
\left(  C\cup\left\{  \ell+1\right\}  \right)  }\\
&  =\underbrace{\sum_{\substack{B\supseteq C;\\\ell+1\notin B;\\\ell\notin
B}}}_{\substack{=\sum_{\substack{\left(  B,k\right)  \in\Omega;\\\left(
B,k\right)  \geq\left(  C,\ell\right)  }}\\\text{(by
(\ref{pf.prop.K.Epk.M.sum-man}))}}}\left(  -1\right)  ^{\left\vert B\setminus
C\right\vert }\left(  F_{\operatorname*{Comp}B}-F_{\operatorname*{Comp}\left(
B\cup\left\{  \ell\right\}  \right)  }\right) \\
&  =\sum_{\substack{\left(  B,k\right)  \in\Omega;\\\left(  B,k\right)
\geq\left(  C,\ell\right)  }}\left(  -1\right)  ^{\left\vert B\setminus
C\right\vert }\left(  F_{\operatorname*{Comp}B}%
-\underbrace{F_{\operatorname*{Comp}\left(  B\cup\left\{  \ell\right\}
\right)  }}_{\substack{=F_{\operatorname*{Comp}\left(  B\cup\left\{
k\right\}  \right)  }\\\text{(since }\ell=k\\\text{(since }\left(  B,k\right)
\geq\left(  C,\ell\right)  \text{ and thus }k=\ell\text{))}}}\right) \\
&  =\sum_{\substack{\left(  B,k\right)  \in\Omega;\\\left(  B,k\right)
\geq\left(  C,\ell\right)  }}\left(  -1\right)  ^{\left\vert B\setminus
C\right\vert }\underbrace{\left(  F_{\operatorname*{Comp}B}%
-F_{\operatorname*{Comp}\left(  B\cup\left\{  k\right\}  \right)  }\right)
}_{\substack{=\mathbf{f}_{B,k}\\\text{(since (\ref{pf.prop.K.Epk.M.fCk=})
yields}\\\mathbf{f}_{B,k}=F_{\operatorname*{Comp}B}-F_{\operatorname*{Comp}%
\left(  B\cup\left\{  k\right\}  \right)  }\text{)}}}\\
&  =\sum_{\substack{\left(  B,k\right)  \in\Omega;\\\left(  B,k\right)
\geq\left(  C,\ell\right)  }}\left(  -1\right)  ^{\left\vert B\setminus
C\right\vert }\mathbf{f}_{B,k}.
\end{align*}
This proves Claim 3.]

Now, Claim 3 shows that the family $\left(  \mathbf{m}_{C,k}\right)  _{\left(
C,k\right)  \in\Omega}$ expands triangularly with respect to the family
$\left(  \mathbf{f}_{C,k}\right)  _{\left(  C,k\right)  \in\Omega}$ with
respect to the poset structure on $\Omega$. Moreover, the expansion is
\textbf{uni}triangular (because if $\left(  B,k\right)  =\left(
C,\ell\right)  $, then $B=C$ and thus $\left(  -1\right)  ^{\left\vert
B\setminus C\right\vert }=\left(  -1\right)  ^{\left\vert C\setminus
C\right\vert }=\left(  -1\right)  ^{0}=1$) and thus invertibly triangular
(this means that the diagonal entries are invertible). Therefore, by a
standard fact from linear algebra (see, e.g., \cite[Corollary 11.1.19
\textbf{(b)}]{HopfComb}), we conclude that the span of the family $\left(
\mathbf{m}_{C,k}\right)  _{\left(  C,k\right)  \in\Omega}$ equals the span of
the family $\left(  \mathbf{f}_{C,k}\right)  _{\left(  C,k\right)  \in\Omega}%
$. In other words,%
\[
\left\langle \mathbf{m}_{C,k}\ \mid\ \left(  C,k\right)  \in\Omega
\right\rangle =\left\langle \mathbf{f}_{C,k}\ \mid\ \left(  C,k\right)
\in\Omega\right\rangle .
\]
Now, Claim 1 yields%
\begin{align*}
&  \left\langle M_{J}+M_{K}\ \mid\ J\text{ and }K\text{ are compositions of
}n\text{ satisfying }J\underset{M}{\rightarrow}K\right\rangle \\
&  =\left\langle \mathbf{m}_{C,k}\ \mid\ \left(  C,k\right)  \in
\Omega\right\rangle =\left\langle \mathbf{f}_{C,k}\ \mid\ \left(  C,k\right)
\in\Omega\right\rangle \\
&  =\left\langle F_{J}-F_{K}\ \mid\ J\text{ and }K\text{ are compositions of
}n\text{ satisfying }J\rightarrow K\right\rangle
\end{align*}
(by Claim 2).

Now, forget that we fixed $n$. We thus have proven that
\begin{align*}
&  \left\langle M_{J}+M_{K}\ \mid\ J\text{ and }K\text{ are compositions of
}n\text{ satisfying }J\underset{M}{\rightarrow}K\right\rangle \\
&  =\left\langle F_{J}-F_{K}\ \mid\ J\text{ and }K\text{ are compositions of
}n\text{ satisfying }J\rightarrow K\right\rangle
\end{align*}
for each $n\in\mathbb{N}$. Thus,%
\begin{align*}
&  \sum_{n\in\mathbb{N}}\left\langle M_{J}+M_{K}\ \mid\ J\text{ and }K\text{
are compositions of }n\text{ satisfying }J\underset{M}{\rightarrow
}K\right\rangle \\
&  =\sum_{n\in\mathbb{N}}\left\langle F_{J}-F_{K}\ \mid\ J\text{ and }K\text{
are compositions of }n\text{ satisfying }J\rightarrow K\right\rangle .
\end{align*}
In light of%
\[
\mathcal{K}_{\operatorname*{Epk}}=\sum_{n\in\mathbb{N}}\left\langle
F_{J}-F_{K}\ \mid\ J\text{ and }K\text{ are compositions of }n\text{
satisfying }J\rightarrow K\right\rangle
\]
and%
\[
\mathcal{M}=\sum_{n\in\mathbb{N}}\left\langle M_{J}+M_{K}\ \mid\ J\text{ and
}K\text{ are compositions of }n\text{ satisfying }J\underset{M}{\rightarrow
}K\right\rangle ,
\]
this rewrites as $\mathcal{M}=\mathcal{K}_{\operatorname*{Epk}}$. In other
words, $\mathcal{K}_{\operatorname*{Epk}}=\mathcal{M}$. This proves
Proposition \ref{prop.K.Epk.M}.
\end{proof}

\begin{question}
It is worth analyzing the kernels of other known descent statistics
(shuffle-compatible of not). We have seen above that $\mathcal{K}%
_{\operatorname*{Epk}}$ is a \textquotedblleft binomial
subspace\textquotedblright\ of $\operatorname*{QSym}$ in the fundamental basis
(i.e., it can be spanned by elements of the form $\lambda F_{J}+\mu F_{K}$ for
$J,K\in\operatorname*{Comp}$) and a \textquotedblleft binomial
subspace\textquotedblright\ of $\operatorname*{QSym}$ in the monomial basis
(i.e., it can be spanned by elements of the form $\lambda M_{J}+\mu M_{K}$ for
$J,K\in\operatorname*{Comp}$). What other descent statistics have this property?
\end{question}

\section{Dendriform structures}

Next, we shall study how the ideal $\mathcal{K}_{\operatorname*{Epk}}$
interacts with some additional structure on $\operatorname*{QSym}$, viz. the
\textit{dendriform operations }$\left.  \prec\right.  $ and $\left.
\succeq\right.  $ and the \textquotedblleft runic\textquotedblright%
\ operations $\bel$ and $\tvi$. These operations were introduced in
\cite{dimcr}. Our study shall lead us to the notions of \textquotedblleft
left-shuffle-compatibility\textquotedblright\ and \textquotedblleft
right-shuffle-compatibility\textquotedblright, which are two properties
similar to shuffle-compatibility (which, when combined, are stronger than
shuffle-compatibility). We shall prove that $\operatorname*{Epk}$ is
left-shuffle-compatible and right-shuffle-compatible; similar studies can
probably be made for other descent statistics.

\subsection{Four operations on $\operatorname*{QSym}$}

We begin with some definitions. We will use some notations from \cite{dimcr},
but we set $\mathbf{k}=\mathbb{Q}$ because we are working over the ring
$\mathbb{Q}$ in this paper. Monomials always mean formal expressions of the
form $x_{1}^{a_{1}}x_{2}^{a_{2}}x_{3}^{a_{3}}\cdots$ with $a_{1}+a_{2}%
+a_{3}+\cdots<\infty$ (see \cite[Section 2]{dimcr} for details). If
$\mathfrak{m}$ is a monomial, then $\operatorname*{Supp}\mathfrak{m}$ will
denote the finite subset
\[
\left\{  i\in\left\{  1,2,3,\ldots\right\}  \ \mid\ \text{the exponent with
which }x_{i}\text{ occurs in }\mathfrak{m}\text{ is }>0\right\}
\]
of $\left\{  1,2,3,\ldots\right\}  $. Next, we define four binary operations
\begin{align*}
&  \left.  \prec\right.  \ \left(  \text{called \textquotedblleft dendriform
less-than\textquotedblright; but it's an operation, not a relation}\right)
,\\
&  \left.  \succeq\right.  \ \left(  \text{called \textquotedblleft dendriform
greater-or-equal\textquotedblright; but it's an operation, not a
relation}\right)  ,\\
&  \bel\ \left(  \text{called \textquotedblleft belgthor\textquotedblright%
}\right)  ,\\
&  \tvi\ \left(  \text{called \textquotedblleft tvimadur\textquotedblright%
}\right)
\end{align*}
on the ring $\mathbf{k}\left[  \left[  x_{1},x_{2},x_{3},\ldots\right]
\right]  $ of power series by first defining how they act on monomials:%
\begin{align*}
\mathfrak{m}\left.  \prec\right.  \mathfrak{n}  &  =\left\{
\begin{array}
[c]{l}%
\mathfrak{m}\cdot\mathfrak{n},\ \ \ \ \ \ \ \ \ \ \text{if }\min\left(
\operatorname*{Supp}\mathfrak{m}\right)  <\min\left(  \operatorname*{Supp}%
\mathfrak{n}\right)  ;\\
0,\ \ \ \ \ \ \ \ \ \ \text{if }\min\left(  \operatorname*{Supp}%
\mathfrak{m}\right)  \geq\min\left(  \operatorname*{Supp}\mathfrak{n}\right)
\end{array}
\right.  ;\\
\mathfrak{m}\left.  \succeq\right.  \mathfrak{n}  &  =\left\{
\begin{array}
[c]{l}%
\mathfrak{m}\cdot\mathfrak{n},\ \ \ \ \ \ \ \ \ \ \text{if }\min\left(
\operatorname*{Supp}\mathfrak{m}\right)  \geq\min\left(  \operatorname*{Supp}%
\mathfrak{n}\right)  ;\\
0,\ \ \ \ \ \ \ \ \ \ \text{if }\min\left(  \operatorname*{Supp}%
\mathfrak{m}\right)  <\min\left(  \operatorname*{Supp}\mathfrak{n}\right)
\end{array}
\right.  ;\\
\mathfrak{m}\bel\mathfrak{n}  &  =\left\{
\begin{array}
[c]{l}%
\mathfrak{m}\cdot\mathfrak{n},\ \ \ \ \ \ \ \ \ \ \text{if }\max\left(
\operatorname*{Supp}\mathfrak{m}\right)  \leq\min\left(  \operatorname*{Supp}%
\mathfrak{n}\right)  ;\\
0,\ \ \ \ \ \ \ \ \ \ \text{if }\max\left(  \operatorname*{Supp}%
\mathfrak{m}\right)  >\min\left(  \operatorname*{Supp}\mathfrak{n}\right)
\end{array}
\right.  ;\\
\mathfrak{m}\tvi\mathfrak{n}  &  =\left\{
\begin{array}
[c]{l}%
\mathfrak{m}\cdot\mathfrak{n},\ \ \ \ \ \ \ \ \ \ \text{if }\max\left(
\operatorname*{Supp}\mathfrak{m}\right)  <\min\left(  \operatorname*{Supp}%
\mathfrak{n}\right)  ;\\
0,\ \ \ \ \ \ \ \ \ \ \text{if }\max\left(  \operatorname*{Supp}%
\mathfrak{m}\right)  \geq\min\left(  \operatorname*{Supp}\mathfrak{n}\right)
\end{array}
\right.  ;
\end{align*}
and then requiring that they all be $\mathbf{k}$-bilinear and continuous (so
their action on pairs of arbitrary power series can be computed by
\textquotedblleft opening the parentheses\textquotedblright). These operations
$\left.  \prec\right.  $, $\left.  \succeq\right.  $, $\bel$ and $\tvi$ all
restrict to the subset $\operatorname*{QSym}$ of $\mathbf{k}\left[  \left[
x_{1},x_{2},x_{3},\ldots\right]  \right]  $ (this is proven in \cite[detailed
version, Section 3]{dimcr}). They furthermore satisfy numerous
relations\footnote{These relations are all easy to prove (by linearity, it
suffices to verify them on monomials only, and this verification is
straightforward). A proof of the associativity of $\bel$ was given in
\cite[detailed version, Proposition 3.4]{dimcr}.}:

\begin{itemize}
\item The dendriform operations satisfy the four rules
\begin{align}
a\left.  \prec\right.  b+a\left.  \succeq\right.  b  &
=ab;\label{eq.dendriform.1}\\
\left(  a\left.  \prec\right.  b\right)  \left.  \prec\right.  c  &  =a\left.
\prec\right.  \left(  bc\right)  ;\nonumber\\
\left(  a\left.  \succeq\right.  b\right)  \left.  \prec\right.  c  &
=a\left.  \succeq\right.  \left(  b\left.  \prec\right.  c\right)
;\nonumber\\
a\left.  \succeq\right.  \left(  b\left.  \succeq\right.  c\right)   &
=\left(  ab\right)  \left.  \succeq\right.  c\nonumber
\end{align}
for all $a,b,c\in\mathbf{k}\left[  \left[  x_{1},x_{2},x_{3},\ldots\right]
\right]  $. (In other words, they turn $\mathbf{k}\left[  \left[  x_{1}%
,x_{2},x_{3},\ldots\right]  \right]  $ into what is called a dendriform algebra.)

\item For any $a\in\mathbf{k}\left[  \left[  x_{1},x_{2},x_{3},\ldots\right]
\right]  $, we have%
\begin{align}
1\left.  \prec\right.  a  &  =0;\label{eq.dendriform.1<a}\\
a\left.  \prec\right.  1  &  =a-\varepsilon\left(  a\right)
;\label{eq.dendriform.a<1}\\
1\left.  \succeq\right.  a  &  =a;\label{eq.dendriform.1>=a}\\
a\left.  \succeq\right.  1  &  =\varepsilon\left(  a\right)  ,
\label{eq.dendriform.a>=1}%
\end{align}
where $\varepsilon\left(  a\right)  $ denotes the constant term of the power
series $a$.

\item The binary operation $\bel$ is associative and unital (with $1$ serving
as the unity).

\item The binary operation $\tvi$ is associative and unital (with $1$ serving
as the unity).
\end{itemize}

Recall that we are using the notations $M_{\alpha}$ for the monomial
quasisymmetric functions and $F_{\alpha}$ for the fundamental quasisymmetric functions.

\begin{itemize}
\item For any two nonempty compositions $\alpha$ and $\beta$, we have
$M_{\alpha}\bel  M_{\beta}=M_{\left[  \alpha,\beta\right]  }+M_{\alpha
\odot\beta}$, where $\left[  \alpha,\beta\right]  $ and $\alpha\odot\beta$ are
two compositions defined by%
\begin{align*}
\left[  \left(  \alpha_{1},\alpha_{2},\ldots,\alpha_{\ell}\right)  ,\left(
\beta_{1},\beta_{2},\ldots,\beta_{m}\right)  \right]   &  =\left(  \alpha
_{1},\alpha_{2},\ldots,\alpha_{\ell},\beta_{1},\beta_{2},\ldots,\beta
_{m}\right)  ;\\
\left(  \alpha_{1},\alpha_{2},\ldots,\alpha_{\ell}\right)  \odot\left(
\beta_{1},\beta_{2},\ldots,\beta_{m}\right)   &  =\left(  \alpha_{1}%
,\alpha_{2},\ldots,\alpha_{\ell-1},\alpha_{\ell}+\beta_{1},\beta_{2},\beta
_{3},\ldots,\beta_{m}\right)  .
\end{align*}


\item For any two compositions $\alpha$ and $\beta$, we have $M_{\alpha
}\tvi  M_{\beta}=M_{\left[  \alpha,\beta\right]  }$.

\item For any two compositions $\alpha$ and $\beta$, we have $F_{\alpha
}\bel  F_{\beta}=F_{\alpha\odot\beta}$. (Here, $\alpha\odot\beta$ is defined
to be $\alpha$ if $\beta$ is the empty composition, and is defined to be
$\beta$ if $\alpha$ is the empty composition.)

\item For any two compositions $\alpha$ and $\beta$, we have $F_{\alpha
}\tvi  F_{\beta}=F_{\left[  \alpha,\beta\right]  }$.
\end{itemize}

Furthermore, we shall use two theorems from \cite[detailed version, Section
3]{dimcr}:

\begin{theorem}
\label{thm.beldend}Let $S$ denote the antipode of the Hopf algebra
$\operatorname*{QSym}$. Let us use Sweedler's notation $\sum_{\left(
b\right)  }b_{\left(  1\right)  }\otimes b_{\left(  2\right)  }$ for
$\Delta\left(  b\right)  $, where $b$ is any element of $\operatorname*{QSym}%
$. Then,%
\[
\sum_{\left(  b\right)  }\left(  S\left(  b_{\left(  1\right)  }\right)
\bel  a\right)  b_{\left(  2\right)  }=a\left.  \prec\right.  b
\]
for any $a\in\mathbf{k}\left[  \left[  x_{1},x_{2},x_{3},\ldots\right]
\right]  $ and $b\in\operatorname*{QSym}$.
\end{theorem}

\begin{theorem}
\label{thm.tvidend'}Let $S$ denote the antipode of the Hopf algebra
$\operatorname*{QSym}$. Let us use Sweedler's notation $\sum_{\left(
b\right)  }b_{\left(  1\right)  }\otimes b_{\left(  2\right)  }$ for
$\Delta\left(  b\right)  $, where $b$ is any element of $\operatorname*{QSym}%
$. Then,%
\[
\sum_{\left(  b\right)  }\left(  S\left(  b_{\left(  1\right)  }\right)
\tvi  a\right)  b_{\left(  2\right)  }=b\left.  \succeq\right.  a
\]
for any $a\in\mathbf{k}\left[  \left[  x_{1},x_{2},x_{3},\ldots\right]
\right]  $ and $b\in\operatorname*{QSym}$.
\end{theorem}

(Notice that Theorem \ref{thm.tvidend'} differs from \cite[detailed version,
Theorem 3.15]{dimcr} in that we are writing $b\left.  \succeq\right.  a$
instead of $a\left.  \preceq\right.  b$. But this is the same thing, since
$a\left.  \preceq\right.  b=b\left.  \succeq\right.  a$ for all $a,b\in
\mathbf{k}\left[  \left[  x_{1},x_{2},x_{3},\ldots\right]  \right]  $.)

\subsection{Ideals}

\begin{definition}
Let $A$ be a $\mathbf{k}$-module equipped with some binary operation $\ast$
(written infix).

\textbf{(a)} If $B$ and $C$ are two $\mathbf{k}$-submodules of $A$, then
$B\ast C$ shall mean the $\mathbf{k}$-submodule of $A$ spanned by all elements
of the form $b\ast c$ with $b\in B$ and $c\in C$.

\textbf{(b)} A $\mathbf{k}$-submodule $M$ of $A$ is said to be a \textit{left
}$\ast$\textit{-ideal} if and only if it satisfies $A\ast M\subseteq M$.

\textbf{(c)} A $\mathbf{k}$-submodule $M$ of $A$ is said to be a \textit{right
}$\ast$\textit{-ideal} if and only if it satisfies $M\ast A\subseteq M$.

\textbf{(d)} A $\mathbf{k}$-submodule $M$ of $A$ is said to be a\textit{
}$\ast$\textit{-ideal} if and only if it is both a left $\ast$-ideal and a
right $\ast$-ideal.
\end{definition}

\begin{theorem}
\label{thm.ideal-crit2}Let $M$ be an ideal of $\operatorname*{QSym}$. Let
$A=\operatorname*{QSym}$.

\textbf{(a)} If $A\bel  M\subseteq M$, then $M\left.  \prec\right.  A\subseteq
M$.

\textbf{(b)} If $A\tvi  M\subseteq M$, then $A\left.  \succeq\right.
M\subseteq M$.

\textbf{(c)} If $A\tvi  M\subseteq M$ and $A\bel  M\subseteq M$, then $M$ is a
$\left.  \prec\right.  $-ideal and a $\left.  \succeq\right.  $-ideal of
$\operatorname*{QSym}$.
\end{theorem}

\begin{proof}
[Proof of Theorem \ref{thm.ideal-crit2}.]\textbf{(a)} Assume that
$A\bel  M\subseteq M$. If $a\in M$ and $b\in A$, then%
\begin{align*}
a\left.  \prec\right.  b  &  =\sum_{\left(  b\right)  }\left(
\underbrace{S\left(  b_{\left(  1\right)  }\right)  }_{\in A}%
\bel \underbrace{a}_{\in M}\right)  \underbrace{b_{\left(  2\right)  }}_{\in
A}\ \ \ \ \ \ \ \ \ \ \left(  \text{by Theorem \ref{thm.beldend}}\right) \\
&  \in\underbrace{\left(  A\bel M\right)  }_{\subseteq M}A\subseteq
MA\subseteq M\ \ \ \ \ \ \ \ \ \ \left(  \text{since }M\text{ is an ideal of
}A\right)  .
\end{align*}
Thus, $M\left.  \prec\right.  A\subseteq M$. This proves Theorem
\ref{thm.ideal-crit2} \textbf{(a)}.

\textbf{(b)} Assume that $A\tvi  M\subseteq M$. If $a\in M$ and $b\in A$, then%
\begin{align*}
b\left.  \succeq\right.  a  &  =\sum_{\left(  b\right)  }\left(
\underbrace{S\left(  b_{\left(  1\right)  }\right)  }_{\in A}%
\tvi \underbrace{a}_{\in M}\right)  \underbrace{b_{\left(  2\right)  }}_{\in
A}\ \ \ \ \ \ \ \ \ \ \left(  \text{by Theorem \ref{thm.tvidend'}}\right) \\
&  \in\underbrace{\left(  A\tvi M\right)  }_{\subseteq M}A\subseteq
MA\subseteq M\ \ \ \ \ \ \ \ \ \ \left(  \text{since }M\text{ is an ideal of
}A\right)  .
\end{align*}
Thus, $A\left.  \succeq\right.  M\subseteq M$. This proves Theorem
\ref{thm.ideal-crit2} \textbf{(b)}.

\textbf{(c)} Assume that $A\tvi  M\subseteq M$ and $A\bel  M\subseteq M$.
Then, Theorem \ref{thm.ideal-crit2} \textbf{(b)} yields $A\left.
\succeq\right.  M\subseteq M$. Thus, $M$ is a left $\left.  \succeq\right.  $-ideal.

Now, any $b\in M$ and $a\in A$ satisfy%
\begin{align*}
a\left.  \prec\right.  b  &  =\underbrace{a}_{\in A}\underbrace{b}_{\in
M}-\underbrace{a}_{\in A}\left.  \succeq\right.  \underbrace{b}_{\in
M}\ \ \ \ \ \ \ \ \ \ \left(  \text{by (\ref{eq.dendriform.1})}\right) \\
&  \in\underbrace{AM}_{\substack{\subseteq M\\\text{(since }M\text{ is an
ideal of }A\text{)}}}-\underbrace{A\left.  \succeq\right.  M}_{\subseteq
M}\subseteq M-M\subseteq M.
\end{align*}
In other words, $A\left.  \prec\right.  M\subseteq M$. In other words, $M$ is
a left $\left.  \prec\right.  $-ideal.

But Theorem \ref{thm.ideal-crit2} \textbf{(a)} yields $M\left.  \prec\right.
A\subseteq M$. In other words, $M$ is a right $\left.  \prec\right.  $-ideal.

Any $a\in M$ and $b\in A$ satisfy%
\begin{align*}
a\left.  \succeq\right.  b  &  =\underbrace{a}_{\in M}\underbrace{b}_{\in
A}-\underbrace{a}_{\in M}\left.  \prec\right.  \underbrace{b}_{\in
A}\ \ \ \ \ \ \ \ \ \ \left(  \text{by (\ref{eq.dendriform.1})}\right) \\
&  \in\underbrace{MA}_{\substack{\subseteq M\\\text{(since }M\text{ is an
ideal of }A\text{)}}}-\underbrace{M\left.  \prec\right.  A}_{\subseteq
M}\subseteq M-M\subseteq M.
\end{align*}
In other words, $M\left.  \succeq\right.  A\subseteq M$. In other words, $M$
is a right $\left.  \succeq\right.  $-ideal.

Hence, $M$ is a $\left.  \prec\right.  $-ideal (since $M$ is a left $\left.
\prec\right.  $-ideal and a right $\left.  \prec\right.  $-ideal) and a
$\left.  \succeq\right.  $-ideal (since $M$ is a left $\left.  \succeq\right.
$-ideal and a right $\left.  \succeq\right.  $-ideal). This proves Theorem
\ref{thm.ideal-crit2} \textbf{(c)}.
\end{proof}

Another simple fact is the following:

\begin{proposition}
\label{prop.ideal-crit3}Let $M$ be simultaneously a $\left.  \prec\right.
$-ideal and a $\left.  \succeq\right.  $-ideal of $\operatorname*{QSym}$.
Then, $M$ is an ideal of $\operatorname*{QSym}$.
\end{proposition}

\begin{proof}
[Proof of Proposition \ref{prop.ideal-crit3}.]Any $a\in M$ and $b\in
\operatorname*{QSym}$ satisfy%
\begin{align*}
ab  &  =\underbrace{a}_{\in M}\left.  \prec\right.  \underbrace{b}%
_{\in\operatorname*{QSym}}+\underbrace{a}_{\in M}\left.  \succeq\right.
\underbrace{b}_{\in\operatorname*{QSym}}\ \ \ \ \ \ \ \ \ \ \left(  \text{by
(\ref{eq.dendriform.1})}\right) \\
&  \in\underbrace{M\left.  \prec\right.  \operatorname*{QSym}}%
_{\substack{\subseteq M\\\text{(since }M\text{ is a }\left.  \prec\right.
\text{-ideal of }\operatorname*{QSym}\text{)}}}+\underbrace{M\left.
\succeq\right.  \operatorname*{QSym}}_{\substack{\subseteq M\\\text{(since
}M\text{ is a }\left.  \succeq\right.  \text{-ideal of }\operatorname*{QSym}%
\text{)}}}\subseteq M+M\subseteq M.
\end{align*}
In other words, $M$ is an ideal of $\operatorname*{QSym}$. This proves
Proposition \ref{prop.ideal-crit3}.
\end{proof}

\begin{question}
Proposition \ref{prop.ideal-crit3} says that if a $\mathbb{Q}$-vector subspace
$M$ of $\operatorname*{QSym}$ is simultaneously a $\left.  \prec\right.
$-ideal and an $\left.  \succeq\right.  $-ideal, then it is also an ideal.
Similarly, if $M$ is an ideal and a $\left.  \prec\right.  $-ideal, then it is
a $\left.  \succeq\right.  $-ideal. Can we state any other such criteria?
\end{question}

\subsection{Application to $\mathcal{K}_{\operatorname*{Epk}}$}

We now claim the following:

\begin{theorem}
\label{thm.Epk.dend}The ideal $\mathcal{K}_{\operatorname*{Epk}}$ of
$\operatorname*{QSym}$ is a $\tvi  $-ideal, a $\bel  $-ideal, a $\left.
\prec\right.  $-ideal and a $\left.  \succeq\right.  $-ideal of
$\operatorname*{QSym}$.
\end{theorem}

\begin{proof}
[Proof of Theorem \ref{thm.Epk.dend}.]Let $A=\operatorname*{QSym}$. Corollary
\ref{cor.Epk.ideal} shows that $\mathcal{K}_{\operatorname*{Epk}}$ is an ideal
of $\operatorname*{QSym}$.

Let us recall the binary relation $\rightarrow$ on the set of compositions
defined in Proposition \ref{prop.K.Epk.F}.

\begin{statement}
\textit{Claim 1:} Let $J$ and $K$ be two compositions satisfying $J\rightarrow
K$. Let $G$ be a further composition. Then, $\left[  G,J\right]
\rightarrow\left[  G,K\right]  $.
\end{statement}

[\textit{Proof of Claim 1:} Write the composition $J$ in the form $J=\left(
j_{1},j_{2},\ldots,j_{m}\right)  $. Write the composition $G$ in the form
$G=\left(  g_{1},g_{2},\ldots,g_{p}\right)  $.

We have $J\rightarrow K$. In other words, there exists an $\ell\in\left\{
2,3,\ldots,m\right\}  $ such that $j_{\ell}>2$ and $K=\left(  j_{1}%
,j_{2},\ldots,j_{\ell-1},1,j_{\ell}-1,j_{\ell+1},j_{\ell+2},\ldots
,j_{m}\right)  $ (by the definition of the relation $\rightarrow$). Consider
this $\ell$. Clearly, $\ell>1$ (since $\ell\in\left\{  2,3,\ldots,m\right\}
$), so that $p+\ell>\underbrace{p}_{\geq0}+1\geq1$.

From $G=\left(  g_{1},g_{2},\ldots,g_{p}\right)  $ and $J=\left(  j_{1}%
,j_{2},\ldots,j_{m}\right)  $, we obtain%
\begin{equation}
\left[  G,J\right]  =\left(  g_{1},g_{2},\ldots,g_{p},j_{1},j_{2},\ldots
,j_{m}\right)  . \label{pf.thm.Epk.dend.c1.pf.GJ=}%
\end{equation}
From $G=\left(  g_{1},g_{2},\ldots,g_{p}\right)  $ and $K=\left(  j_{1}%
,j_{2},\ldots,j_{\ell-1},1,j_{\ell}-1,j_{\ell+1},j_{\ell+2},\ldots
,j_{m}\right)  $, we obtain%
\begin{equation}
\left[  G,K\right]  =\left(  g_{1},g_{2},\ldots,g_{p},j_{1},j_{2}%
,\ldots,j_{\ell-1},1,j_{\ell}-1,j_{\ell+1},j_{\ell+2},\ldots,j_{m}\right)  .
\label{pf.thm.Epk.dend.c1.pf.GK=}%
\end{equation}
From looking at (\ref{pf.thm.Epk.dend.c1.pf.GJ=}) and
(\ref{pf.thm.Epk.dend.c1.pf.GK=}), we conclude immediately that the
composition $\left[  G,K\right]  $ is obtained from $\left[  G,J\right]  $ by
\textquotedblleft splitting\textquotedblright\ the entry $j_{\ell}>2$ into two
consecutive entries $1$ and $j_{\ell}-1$, and that this entry $j_{\ell}$ was
not the first entry (indeed, this entry is the $\left(  p+\ell\right)  $-th
entry, but $p+\ell>1$). Hence, $\left[  G,J\right]  \rightarrow\left[
G,K\right]  $ (by the definition of the relation $\rightarrow$). This proves
Claim 1.]

\begin{statement}
\textit{Claim 2:} We have $A\tvi  \mathcal{K}_{\operatorname*{Epk}}%
\subseteq\mathcal{K}_{\operatorname*{Epk}}$.
\end{statement}

[\textit{Proof of Claim 2:} We must show that $a\tvi  m\in\mathcal{K}%
_{\operatorname*{Epk}}$ for every $a\in A$ and $m\in\mathcal{K}%
_{\operatorname*{Epk}}$. So let us fix $a\in A$ and $m\in\mathcal{K}%
_{\operatorname*{Epk}}$.

Proposition \ref{prop.K.Epk.F} shows that the $\mathbb{Q}$-vector space
$\mathcal{K}_{\operatorname*{Epk}}$ is spanned by all differences of the form
$F_{J}-F_{K}$, where $J$ and $K$ are two compositions satisfying $J\rightarrow
K$. Hence, we can WLOG assume that $m$ is such a difference (because the
relation $a\tvi  m\in\mathcal{K}_{\operatorname*{Epk}}$, which we must prove,
is $\mathbb{Q}$-linear in $m$). Assume this. Thus, $m=F_{J}-F_{K}$ for some
two compositions $J$ and $K$ satisfying $J\rightarrow K$. Consider these $J$
and $K$.

From $J\rightarrow K$, we easily conclude that the composition $J$ is
nonempty. Thus, $\left\vert J\right\vert \neq0$. But from $J\rightarrow K$, we
also obtain $\left\vert J\right\vert =\left\vert K\right\vert $. Hence,
$\left\vert K\right\vert =\left\vert J\right\vert \neq0$. Thus, the
composition $K$ is nonempty.

Recall that the family $\left(  F_{L}\right)  _{L\text{ is a composition}}$ is
a basis of the $\mathbb{Q}$-vector space $\operatorname*{QSym}=A$. Hence, we
can WLOG assume that $a$ belongs to this family (since the relation
$a\tvi  m\in\mathcal{K}_{\operatorname*{Epk}}$, which we must prove, is
$\mathbb{Q}$-linear in $a$). Assume this. Thus, $a=F_{G}$ for some composition
$G$. Consider this $G$.

If $G$ is the empty composition, then $a=F_{G}=1$, and therefore
$\underbrace{a}_{=1}\tvi  m=1\tvi  m=m\in\mathcal{K}_{\operatorname*{Epk}}$
holds. Thus, for the rest of this proof, we WLOG assume that $G$ is not the
empty composition. Thus, $G$ is nonempty.

Recall that for any two compositions $\alpha$ and $\beta$, we have $F_{\alpha
}\tvi  F_{\beta}=F_{\left[  \alpha,\beta\right]  }$. Applying this to
$\alpha=G$ and $\beta=J$, we obtain $F_{G}\tvi  F_{J}=F_{\left[  G,J\right]
}$. Similarly, $F_{G}\tvi  F_{K}=F_{\left[  G,K\right]  }$.

But Claim 1 yields $\left[  G,J\right]  \rightarrow\left[  G,K\right]  $.
Hence, the difference $F_{\left[  G,J\right]  }-F_{\left[  G,K\right]  }$ is
one of the differences which span the ideal $\mathcal{K}_{\operatorname*{Epk}%
}$ according to Proposition \ref{prop.K.Epk.F}. Thus, in particular, this
difference lies in $\mathcal{K}_{\operatorname*{Epk}}$. In other words,
$F_{\left[  G,J\right]  }-F_{\left[  G,K\right]  }\in\mathcal{K}%
_{\operatorname*{Epk}}$.

Now,%
\begin{align*}
\underbrace{a}_{=F_{G}}\tvi \underbrace{m}_{=F_{J}-F_{K}}  &  =F_{G}%
\tvi \left(  F_{J}-F_{K}\right)  =\underbrace{F_{G}\tvi F_{J}}_{=F_{\left[
G,J\right]  }}-\underbrace{F_{G}\tvi F_{K}}_{=F_{\left[  G,K\right]  }}\\
&  =F_{\left[  G,J\right]  }-F_{\left[  G,K\right]  }\in\mathcal{K}%
_{\operatorname*{Epk}}.
\end{align*}
This proves Claim 2.]

\begin{statement}
\textit{Claim 3:} Let $J$ and $K$ be two compositions satisfying $J\rightarrow
K$. Let $G$ be a further composition. Then, $\left[  J,G\right]
\rightarrow\left[  K,G\right]  $.
\end{statement}

[\textit{Proof of Claim 3:} This is proven in the same way as we proved Claim
1, with the only difference that $j_{\ell}$ is now the $\ell$-th entry of
$\left[  J,G\right]  $ and not the $\left(  p+\ell\right)  $-th entry (but
this is still sufficient, since $\ell>1$).]

\begin{statement}
\textit{Claim 4:} We have $\mathcal{K}_{\operatorname*{Epk}}\tvi  A\subseteq
\mathcal{K}_{\operatorname*{Epk}}$.
\end{statement}

[\textit{Proof of Claim 4:} This is proven in the same way as we proved Claim
2, with the only difference that now we need to use Claim 3 instead of Claim 1.]

Combining Claim 2 and Claim 4, we conclude that $\mathcal{K}%
_{\operatorname*{Epk}}$ is a $\tvi  $-ideal of $A=\operatorname*{QSym}$.

\begin{statement}
\textit{Claim 5:} Let $J$ and $K$ be two nonempty compositions satisfying
$J\rightarrow K$. Let $G$ be a further nonempty composition. Then, $G\odot
J\rightarrow G\odot K$.
\end{statement}

[\textit{Proof of Claim 5:} Write the composition $J$ in the form $J=\left(
j_{1},j_{2},\ldots,j_{m}\right)  $. Write the composition $G$ in the form
$G=\left(  g_{1},g_{2},\ldots,g_{p}\right)  $. Thus, $p>0$ (since the
composition $G$ is nonempty).

We have $J\rightarrow K$. In other words, there exists an $\ell\in\left\{
2,3,\ldots,m\right\}  $ such that $j_{\ell}>2$ and $K=\left(  j_{1}%
,j_{2},\ldots,j_{\ell-1},1,j_{\ell}-1,j_{\ell+1},j_{\ell+2},\ldots
,j_{m}\right)  $ (by the definition of the relation $\rightarrow$). Consider
this $\ell$. Clearly, $\ell\geq2$ (since $\ell\in\left\{  2,3,\ldots
,m\right\}  $), so that $\underbrace{p}_{>0}+\underbrace{\ell}_{\geq
2}-1>0+2-1=1$.

From $G=\left(  g_{1},g_{2},\ldots,g_{p}\right)  $ and $J=\left(  j_{1}%
,j_{2},\ldots,j_{m}\right)  $, we obtain%
\begin{equation}
G\odot J=\left(  g_{1},g_{2},\ldots,g_{p-1},g_{p}+j_{1},j_{2},j_{3}%
,\ldots,j_{m}\right)  . \label{pf.thm.Epk.dend.c5.pf.GJ=}%
\end{equation}
From $G=\left(  g_{1},g_{2},\ldots,g_{p}\right)  $ and $K=\left(  j_{1}%
,j_{2},\ldots,j_{\ell-1},1,j_{\ell}-1,j_{\ell+1},j_{\ell+2},\ldots
,j_{m}\right)  $, we obtain%
\begin{equation}
G\odot K=\left(  g_{1},g_{2},\ldots,g_{p-1},g_{p}+j_{1},j_{2},j_{3}%
,\ldots,j_{\ell-1},1,j_{\ell}-1,j_{\ell+1},j_{\ell+2},\ldots,j_{m}\right)
\label{pf.thm.Epk.dend.c5.pf.GK=}%
\end{equation}
(notice that the $g_{p}+j_{1}$ term is \textbf{not} a $g_{p}+1$ term, because
$\ell\geq2$).

From looking at (\ref{pf.thm.Epk.dend.c5.pf.GJ=}) and
(\ref{pf.thm.Epk.dend.c5.pf.GK=}), we conclude immediately that the
composition $G\odot K$ is obtained from $G\odot J$ by \textquotedblleft
splitting\textquotedblright\ the entry $j_{\ell}>2$ into two consecutive
entries $1$ and $j_{\ell}-1$, and that this entry $j_{\ell}$ was not the first
entry (indeed, this entry is the $\left(  p+\ell-1\right)  $-th entry, but
$p+\ell-1>1$). Hence, $G\odot J\rightarrow G\odot K$ (by the definition of the
relation $\rightarrow$). This proves Claim 5.]

\begin{statement}
\textit{Claim 6:} We have $\mathcal{K}_{\operatorname*{Epk}}\bel  A\subseteq
\mathcal{K}_{\operatorname*{Epk}}$.
\end{statement}

[\textit{Proof of Claim 6:} This is proven in the same way as we proved Claim
2, with the only difference that now we need to use Claim 5 instead of Claim 1
and that we need to use the formula $F_{\alpha}\bel  F_{\beta}=F_{\alpha
\odot\beta}$ instead of $F_{\alpha}\tvi  F_{\beta}=F_{\left[  \alpha
,\beta\right]  }$.]

\begin{statement}
\textit{Claim 7:} Let $J$ and $K$ be two nonempty compositions satisfying
$J\rightarrow K$. Let $G$ be a further nonempty composition. Then, $J\odot
G\rightarrow K\odot G$.
\end{statement}

[\textit{Proof of Claim 7:} Write the composition $J$ in the form $J=\left(
j_{1},j_{2},\ldots,j_{m}\right)  $. Write the composition $G$ in the form
$G=\left(  g_{1},g_{2},\ldots,g_{p}\right)  $. Thus, $p>0$ (since the
composition $G$ is nonempty).

We have $J\rightarrow K$. In other words, there exists an $\ell\in\left\{
2,3,\ldots,m\right\}  $ such that $j_{\ell}>2$ and $K=\left(  j_{1}%
,j_{2},\ldots,j_{\ell-1},1,j_{\ell}-1,j_{\ell+1},j_{\ell+2},\ldots
,j_{m}\right)  $ (by the definition of the relation $\rightarrow$). Consider
this $\ell$. Clearly, $\ell\geq2$ (since $\ell\in\left\{  2,3,\ldots
,m\right\}  $), so that $\ell>1$.

From $G=\left(  g_{1},g_{2},\ldots,g_{p}\right)  $ and $J=\left(  j_{1}%
,j_{2},\ldots,j_{m}\right)  $, we obtain%
\begin{equation}
J\odot G=\left(  j_{1},j_{2},\ldots,j_{m-1},j_{m}+g_{1},g_{2},g_{3}%
,\ldots,g_{p}\right)  . \label{pf.thm.Epk.dend.c7.pf.JG=}%
\end{equation}
Now, we distinguish between the following two cases:

\textit{Case 1:} We have $\ell=m$.

\textit{Case 2:} We have $\ell\neq m$.

Let us first consider Case 1. In this case, we have $\ell=m$. Thus,
$m=\ell\geq2>1$ and $j_{m}+g_{1}=\underbrace{j_{\ell}}_{>2}+\underbrace{g_{1}%
}_{\geq0}>2$.

From $G=\left(  g_{1},g_{2},\ldots,g_{p}\right)  $ and
\begin{align*}
K  &  =\left(  j_{1},j_{2},\ldots,j_{\ell-1},1,j_{\ell}-1,j_{\ell+1}%
,j_{\ell+2},\ldots,j_{m}\right) \\
&  =\left(  j_{1},j_{2},\ldots,j_{m-1},1,j_{m}-1\right)
\ \ \ \ \ \ \ \ \ \ \left(  \text{since }\ell=m\right)  ,
\end{align*}
we obtain%
\begin{align}
K\odot G  &  =\left(  j_{1},j_{2},\ldots,j_{m-1},1,\left(  j_{m}-1\right)
+g_{1},g_{2},g_{3},\ldots,g_{p}\right) \nonumber\\
&  =\left(  j_{1},j_{2},\ldots,j_{m-1},1,j_{m}+g_{1}-1,g_{2},g_{3}%
,\ldots,g_{p}\right)  . \label{pf.thm.Epk.dend.c7.pf.KG=c1}%
\end{align}


From looking at (\ref{pf.thm.Epk.dend.c7.pf.JG=}) and
(\ref{pf.thm.Epk.dend.c7.pf.KG=c1}), we conclude immediately that the
composition $K\odot G$ is obtained from $J\odot G$ by \textquotedblleft
splitting\textquotedblright\ the entry $j_{m}+g_{1}>2$ into two consecutive
entries $1$ and $j_{m}+g_{1}-1$, and that this entry $j_{m}+g_{1}$ was not the
first entry (indeed, this entry is the $m$-th entry, but $m>1$). Hence,
$J\odot G\rightarrow K\odot G$ (by the definition of the relation
$\rightarrow$). This proves Claim 7 in Case 1.

Let us next consider Case 2. In this case, we have $\ell\neq m$. Hence,
$\ell\in\left\{  2,3,\ldots,m-1\right\}  $ (since $\ell\in\left\{
2,3,\ldots,m\right\}  $).

From $G=\left(  g_{1},g_{2},\ldots,g_{p}\right)  $ and $K=\left(  j_{1}%
,j_{2},\ldots,j_{\ell-1},1,j_{\ell}-1,j_{\ell+1},j_{\ell+2},\ldots
,j_{m}\right)  $, we obtain%
\begin{align}
&  K\odot G\nonumber\\
&  =\left(  j_{1},j_{2},\ldots,j_{\ell-1},1,j_{\ell}-1,j_{\ell+1},j_{\ell
+2},\ldots,j_{m-1},j_{m}+g_{1},g_{2},g_{3},\ldots,g_{p}\right)
\label{pf.thm.Epk.dend.c7.pf.KG=c2}%
\end{align}
(notice that the $j_{m}+g_{1}$ term is \textbf{not} a $\left(  j_{\ell
}-1\right)  +g_{1}$ term, because $\ell\neq m$).

From looking at (\ref{pf.thm.Epk.dend.c7.pf.JG=}) and
(\ref{pf.thm.Epk.dend.c7.pf.KG=c2}), we conclude immediately that the
composition $K\odot G$ is obtained from $J\odot G$ by \textquotedblleft
splitting\textquotedblright\ the entry $j_{\ell}>2$ into two consecutive
entries $1$ and $j_{\ell}-1$, and that this entry $j_{\ell}$ was not the first
entry (indeed, this entry is the $\ell$-th entry, but $\ell>1$). Hence,
$J\odot G\rightarrow K\odot G$ (by the definition of the relation
$\rightarrow$). This proves Claim 7 in Case 2.

We have now proven Claim 7 in both Cases 1 and 2. Thus, Claim 7 always holds.]

\begin{statement}
\textit{Claim 8:} We have $A\bel  \mathcal{K}_{\operatorname*{Epk}}%
\subseteq\mathcal{K}_{\operatorname*{Epk}}$.
\end{statement}

[\textit{Proof of Claim 8:} This is proven in the same way as we proved Claim
6, with the only difference that now we need to use Claim 7 instead of Claim 5.]

Combining Claim 6 and Claim 8, we conclude that $\mathcal{K}%
_{\operatorname*{Epk}}$ is a $\bel  $-ideal of $A=\operatorname*{QSym}$.

Finally, Theorem \ref{thm.ideal-crit2} \textbf{(c)} (applied to $M=\mathcal{K}%
_{\operatorname*{Epk}}$) shows that $\mathcal{K}_{\operatorname*{Epk}}$ is a
$\left.  \prec\right.  $-ideal and a $\left.  \succeq\right.  $-ideal of
$\operatorname*{QSym}$.

Thus, altogether, we have proven that $\mathcal{K}_{\operatorname*{Epk}}$ is a
$\tvi$-ideal, a $\bel$-ideal, a $\left.  \prec\right.  $-ideal and a $\left.
\succeq\right.  $-ideal of $\operatorname*{QSym}$. This proves Theorem
\ref{thm.Epk.dend}.
\end{proof}

\begin{question}
What other descent statistics $\operatorname*{st}$ have the property that
$\mathcal{K}_{\operatorname*{st}}$ is an $\tvi$-ideal, $\bel$-ideal, $\left.
\prec\right.  $-ideal and/or $\left.  \succeq\right.  $-ideal?
\end{question}

\subsection{Dendriform shuffle-compatibility}

We have seen (in Proposition \ref{prop.K.ideal}) that the kernel
$\mathcal{K}_{\operatorname*{st}}$ of a descent statistic $\operatorname*{st}$
is an ideal of $\operatorname*{QSym}$ if and only if $\operatorname*{st}$ is
shuffle-compatible. It is natural to ask whether similar combinatorial
interpretations exist for when the kernel $\mathcal{K}_{\operatorname*{st}}$
of a descent statistic $\operatorname*{st}$ is a $\tvi$-ideal, a $\bel$-ideal,
a $\left.  \prec\right.  $-ideals or a $\left.  \succeq\right.  $-ideal. In
this section, we shall prove such interpretations.

We begin by introducing dendriform shuffles (i.e., left shuffles and right
shuffles). There is a well-known notion of dendriform shuffles of words.
Specialized to permutations, it can be defined in a simple way as follows:

\begin{definition}
If $\pi$ and $\sigma$ are two disjoint nonempty permutations, then:

\begin{itemize}
\item A \textit{left shuffle} of $\pi$ and $\sigma$ means a shuffle $\tau$ of
$\pi$ and $\sigma$ such that the first letter of $\tau$ is the first letter of
$\pi$.

\item A \textit{right shuffle} of $\pi$ and $\sigma$ means a shuffle $\tau$ of
$\pi$ and $\sigma$ such that the first letter of $\tau$ is the first letter of
$\sigma$.

\item We let $S_{\prec}\left(  \pi,\sigma\right)  $ denote the set of all left
shuffles of $\pi$ and $\sigma$.

\item We let $S_{\succ}\left(  \pi,\sigma\right)  $ denote the set of all
right shuffles of $\pi$ and $\sigma$.
\end{itemize}

Also, if $\pi$ is a nonempty word, then $\min\pi$ shall mean the smallest
letter that appears in $\pi$.
\end{definition}

We have restricted ourselves to nonempty permutations in this definition
because it is not clear what the \textquotedblleft first
letter\textquotedblright\ of an empty permutation would be (and either way,
allowing empty permutations do not change much in our analysis).

The following theorem is analogous to Theorem~\ref{thm.4.1}:

\begin{theorem}
\label{thm.dendri.4.1}Let $\pi$ be a nonempty permutation with descent
composition $J$. Let $\sigma$ be a nonempty permutation with descent
composition $K$. Assume that the permutations $\pi$ and $\sigma$ are disjoint,
and that%
\begin{equation}
\text{the first entry of }\pi\text{ is greater than the first entry of }%
\sigma\text{.} \label{eq.thm.dendri.4.1.ass}%
\end{equation}
For any composition $L$, let $c_{J,K}^{L,\prec}$ be the number of permutations
with descent composition $L$ among the left shuffles of $\pi$ and $\sigma$,
and let $c_{J,K}^{L,\succ}$ be the number of permutations with descent
composition $L$ among the right shuffles of $\pi$ and $\sigma$. Then,%
\[
F_{J}\left.  \prec\right.  F_{K}=\sum_{L}c_{J,K}^{L,\prec}F_{L}%
\]
and%
\[
F_{J}\left.  \succeq\right.  F_{K}=\sum_{L}c_{J,K}^{L,\succeq}F_{L}.
\]

\end{theorem}

Note the condition (\ref{eq.thm.dendri.4.1.ass}), which is not present in
Theorem~\ref{thm.4.1}, and which makes Theorem \ref{thm.dendri.4.1} somewhat
harder to apply.

Theorem \ref{thm.dendri.4.1} can be proven similarly to \cite[(5.2.6)]%
{HopfComb}, but in lieu of the application of \cite[Lemma 5.2.17]{HopfComb},
it requires the following fact:

\begin{proposition}
\label{prop.dendri.4.1.lem}We shall use the notations of \cite[Section
5.2]{HopfComb}. Let $P$ and $Q$ be two disjoint labelled posets, each of which
has a minimum element. Assume that $\min P>_{\mathbb{Z}}\min Q$. Consider the
disjoint union $P\sqcup Q$ of $P$ and $Q$.

\textbf{(a)} Add a further relation $\min P<\min Q$ to $P\sqcup Q$; denote the
resulting labelled poset by $P\left.  \prec\right.  Q$. Then, $F_{P}\left(
\mathbf{x}\right)  \left.  \prec\right.  F_{Q}\left(  \mathbf{x}\right)
=F_{P\left.  \prec\right.  Q}\left(  \mathbf{x}\right)  $.

\textbf{(b)} Add a further relation $\min P>\min Q$ to $P\sqcup Q$; denote the
resulting labelled poset by $P\left.  \succeq\right.  Q$. Then, $F_{P}\left(
\mathbf{x}\right)  \left.  \succeq\right.  F_{Q}\left(  \mathbf{x}\right)
=F_{P\left.  \succeq\right.  Q}\left(  \mathbf{x}\right)  $.
\end{proposition}

Also, the following simple fact is used:

\begin{lemma}
\label{lem.dendri.4.1.lem2}We shall use the notations of \cite[Section
5.2]{HopfComb}. Let $P$ and $Q$ be two disjoint posets, each of which has a
minimum element. Consider the disjoint union $P\sqcup Q$ of $P$ and $Q$.
Assume that $P$ and $Q$ are subsets of $\mathbb{P}$ (the set of positive
integers); thus, any linear extension of $P$ or of $Q$ or of $P\sqcup Q$ is a
permutation (a word with letters in $\mathbb{P}$).

\textbf{(a)} Add a further relation $\min P<\min Q$ to $P\sqcup Q$; denote the
resulting labelled poset by $P\left.  \prec\right.  Q$. Then,
\[
\mathcal{L}\left(  P\left.  \prec\right.  Q\right)  =\bigsqcup_{\pi
\in\mathcal{L}\left(  P\right)  ;\ \sigma\in\mathcal{L}\left(  Q\right)
}S_{\prec}\left(  \pi,\sigma\right)  .
\]


\textbf{(b)} Add a further relation $\min P>\min Q$ to $P\sqcup Q$; denote the
resulting labelled poset by $P\left.  \succeq\right.  Q$. Then,
\[
\mathcal{L}\left(  P\left.  \succeq\right.  Q\right)  =\bigsqcup_{\pi
\in\mathcal{L}\left(  P\right)  ;\ \sigma\in\mathcal{L}\left(  Q\right)
}S_{\succ}\left(  \pi,\sigma\right)  .
\]

\end{lemma}

We leave the details to the reader.

We can rewrite Theorem \ref{thm.dendri.4.1} as follows:\footnote{Recall that
for any permutation $\varphi$, we have let $\operatorname*{Comp}\varphi$
denote the descent composition of $\varphi$.}

\begin{corollary}
\label{cor.dendri.4.1}Let $\pi$ and $\sigma$ be two disjoint nonempty
permutations. Assume that%
\[
\text{the first entry of }\pi\text{ is greater than the first entry of }%
\sigma\text{.}%
\]
Then,%
\[
F_{\operatorname*{Comp}\pi}\left.  \prec\right.  F_{\operatorname*{Comp}%
\sigma}=\sum_{\chi\in S_{\prec}\left(  \pi,\sigma\right)  }%
F_{\operatorname*{Comp}\chi}%
\]
and%
\[
F_{\operatorname*{Comp}\pi}\left.  \succeq\right.  F_{\operatorname*{Comp}%
\sigma}=\sum_{\chi\in S_{\succ}\left(  \pi,\sigma\right)  }%
F_{\operatorname*{Comp}\chi}.
\]

\end{corollary}

Now, let us define dendriform analogues to the concept of shuffle-compatibility:

\begin{definition}
Let $\operatorname*{st}$ be a permutation statistic.

\textbf{(a)} We say that $\operatorname*{st}$ is
\textit{left-shuffle-compatible} if for any two disjoint nonempty permutations
$\pi$ and $\sigma$ having the property that%
\begin{equation}
\text{the first entry of }\pi\text{ is greater than the first entry of }%
\sigma, \label{eq.def.dendri.dsc.ass}%
\end{equation}
the multiset $\left\{  \operatorname*{st}\left(  \tau\right)  \ \mid\ \tau\in
S_{\prec}\left(  \pi,\sigma\right)  \right\}  $ depends only on
$\operatorname*{st}\left(  \pi\right)  $, $\operatorname*{st}\left(
\sigma\right)  $, $\left\vert \pi\right\vert $ and $\left\vert \sigma
\right\vert $.

\textbf{(b)} We say that $\operatorname*{st}$ is \textit{weakly
left-shuffle-compatible} if for any two disjoint nonempty permutations $\pi$
and $\sigma$ having the property that%
\begin{equation}
\text{each entry of }\pi\text{ is greater than each entry of }\sigma,
\label{eq.def.dendri.dsc.weak-ass}%
\end{equation}
the multiset $\left\{  \operatorname*{st}\left(  \tau\right)  \ \mid\ \tau\in
S_{\prec}\left(  \pi,\sigma\right)  \right\}  $ depends only on
$\operatorname*{st}\left(  \pi\right)  $, $\operatorname*{st}\left(
\sigma\right)  $, $\left\vert \pi\right\vert $ and $\left\vert \sigma
\right\vert $.

\textbf{(c)} We say that $\operatorname*{st}$ is
\textit{right-shuffle-compatible} if for any two disjoint nonempty
permutations $\pi$ and $\sigma$ having the property that%
\[
\text{the first entry of }\pi\text{ is greater than the first entry of }%
\sigma,
\]
the multiset $\left\{  \operatorname*{st}\left(  \tau\right)  \ \mid\ \tau\in
S_{\succ}\left(  \pi,\sigma\right)  \right\}  $ depends only on
$\operatorname*{st}\left(  \pi\right)  $, $\operatorname*{st}\left(
\sigma\right)  $, $\left\vert \pi\right\vert $ and $\left\vert \sigma
\right\vert $.

\textbf{(d)} We say that $\operatorname*{st}$ is \textit{weakly
right-shuffle-compatible} if for any two disjoint nonempty permutations $\pi$
and $\sigma$ having the property that%
\[
\text{each entry of }\pi\text{ is greater than each entry of }\sigma,
\]
the multiset $\left\{  \operatorname*{st}\left(  \tau\right)  \ \mid\ \tau\in
S_{\succ}\left(  \pi,\sigma\right)  \right\}  $ depends only on
$\operatorname*{st}\left(  \pi\right)  $, $\operatorname*{st}\left(
\sigma\right)  $, $\left\vert \pi\right\vert $ and $\left\vert \sigma
\right\vert $.
\end{definition}

Then, the following analogues to the first part of Proposition
\ref{prop.K.ideal} holds:

\begin{theorem}
\label{thm.dendri.K.ideal}Let $\operatorname*{st}$ be a descent statistic.
Then, the following three statements are equivalent:

\begin{itemize}
\item \textit{Statement A:} The statistic $\operatorname*{st}$ is left-shuffle-compatible.

\item \textit{Statement B:} The statistic $\operatorname*{st}$ is weakly left-shuffle-compatible.

\item \textit{Statement C:} The set $\mathcal{K}_{\operatorname*{st}}$ is an
$\left.  \prec\right.  $-ideal of $\operatorname*{QSym}$.
\end{itemize}
\end{theorem}

\begin{theorem}
\label{thm.dendri.K.ideal-R}Let $\operatorname*{st}$ be a descent statistic.
Then, the following three statements are equivalent:

\begin{itemize}
\item \textit{Statement A:} The statistic $\operatorname*{st}$ is right-shuffle-compatible.

\item \textit{Statement B:} The statistic $\operatorname*{st}$ is weakly right-shuffle-compatible.

\item \textit{Statement C:} The set $\mathcal{K}_{\operatorname*{st}}$ is an
$\left.  \succeq\right.  $-ideal of $\operatorname*{QSym}$.
\end{itemize}
\end{theorem}

Let us prove Theorem \ref{thm.dendri.K.ideal} directly, without using shuffle algebras:

\begin{proof}
[Proof of Theorem \ref{thm.dendri.K.ideal} (sketched).]The implication
A$\Longrightarrow$B is obvious.

\textit{Proof of the implication B}$\Longrightarrow$\textit{C:} Assume that
Statement B holds. Thus, the statistic $\operatorname*{st}$ is weakly left-shuffle-compatible.

Let us show that the set $\mathcal{K}_{\operatorname*{st}}$ is a $\left.
\prec\right.  $-ideal of $\operatorname*{QSym}$. Indeed, it suffices to show
that every two $\operatorname*{st}$-equivalent compositions $J$ and $K$ and
every further composition $L$ satisfy%
\begin{equation}
\left(  F_{J}-F_{K}\right)  \left.  \prec\right.  F_{L}\in\mathcal{K}%
_{\operatorname*{st}}\ \ \ \ \ \ \ \ \ \ \text{and}\ \ \ \ \ \ \ \ \ \ F_{L}%
\left.  \prec\right.  \left(  F_{J}-F_{K}\right)  \in\mathcal{K}%
_{\operatorname*{st}} \label{pf.thm.dendri.K.ideal.two-incs}%
\end{equation}
(because of the definition of $\mathcal{K}_{\operatorname*{st}}$). So let $J$
and $K$ be two $\operatorname*{st}$-equivalent compositions, and let $L$ be a
further composition. If $J=K$, then (\ref{pf.thm.dendri.K.ideal.two-incs})
follows immediately from realizing that $F_{J}-F_{K}=0$; thus, we WLOG assume
that $J\neq K$. But $\left\vert J\right\vert =\left\vert K\right\vert $ (since
$J$ and $K$ are $\operatorname*{st}$-equivalent). Hence, $\left\vert
J\right\vert =\left\vert K\right\vert >0$ (since otherwise, we would have
$\left\vert J\right\vert =\left\vert K\right\vert =0$, which would imply that
both $J$ and $K$ would be the empty composition, contradicting $J\neq K$).
Therefore, the compositions $J$ and $K$ are nonempty. If $L$ is empty, then
(\ref{pf.thm.dendri.K.ideal.two-incs}) holds for easy reasons (indeed, we have
$F_{L}=1$ in this case, and therefore (\ref{eq.dendriform.a<1}) yields
\[
\left(  F_{J}-F_{K}\right)  \left.  \prec\right.  F_{L}=\left(  F_{J}%
-F_{K}\right)  -\underbrace{\varepsilon\left(  F_{J}-F_{K}\right)
}_{\substack{=0\\\text{(since }F_{J}\text{ and }F_{K}\text{ are}%
\\\text{homogeneous of degree }\left\vert J\right\vert -\left\vert
K\right\vert >0\text{)}}}=F_{J}-F_{K}\in\mathcal{K}_{\operatorname*{st}},
\]
and similarly (\ref{eq.dendriform.1<a}) leads to $F_{L}\left.  \prec\right.
\left(  F_{J}-F_{K}\right)  \in\mathcal{K}_{\operatorname*{st}}$). Hence, we
WLOG assume that $L$ is nonempty.

Pick three disjoint permutations $\varphi$, $\psi$ and $\sigma$ having descent
compositions $J$, $K$ and $L$, respectively, and having the property that%
\[
\text{each entry of }\varphi\text{ is greater than each entry of }\sigma
\]
and%
\[
\text{each entry of }\psi\text{ is greater than each entry of }\sigma\text{.}%
\]
(Such permutations $\varphi$, $\psi$ and $\sigma$ exist, since the set
$\mathbb{P}$ is infinite.)

The permutations $\varphi$ and $\psi$ are $\operatorname*{st}$-equivalent
(since their descent compositions $J$ and $K$ are $\operatorname*{st}%
$-equivalent). In other words, $\left\vert \varphi\right\vert =\left\vert
\psi\right\vert $ and $\operatorname*{st}\left(  \varphi\right)
=\operatorname*{st}\left(  \psi\right)  $.

The statistic $\operatorname*{st}$ is weakly left-shuffle-compatible. Thus,
the multiset $\left\{  \operatorname*{st}\left(  \tau\right)  \ \mid\ \tau\in
S_{\prec}\left(  \pi,\sigma\right)  \right\}  $ (where $\pi$ is a nonempty
permutation disjoint from $\sigma$ and having the property that each entry of
$\pi$ is greater than each entry of $\sigma$) depends only on
$\operatorname*{st}\left(  \pi\right)  $ and $\left\vert \pi\right\vert $ (by
the definition of \textquotedblleft weakly
left-shuffle-compatible\textquotedblright)\footnote{Recall that $\sigma$ is
fixed here, which is why we don't have to say that it depends on
$\operatorname*{st}\left(  \sigma\right)  $ and $\left\vert \sigma\right\vert
$ as well.}. Therefore, the multisets $\left\{  \operatorname*{st}\left(
\tau\right)  \ \mid\ \tau\in S_{\prec}\left(  \varphi,\sigma\right)  \right\}
$ and $\left\{  \operatorname*{st}\left(  \tau\right)  \ \mid\ \tau\in
S_{\prec}\left(  \psi,\sigma\right)  \right\}  $ are equal (since $\left\vert
\varphi\right\vert =\left\vert \psi\right\vert $ and $\operatorname*{st}%
\left(  \varphi\right)  =\operatorname*{st}\left(  \psi\right)  $). Hence,
there exists a bijection $\alpha:S_{\prec}\left(  \varphi,\sigma\right)
\rightarrow S_{\prec}\left(  \psi,\sigma\right)  $ such that each $\chi\in
S_{\prec}\left(  \varphi,\sigma\right)  $ satisfies%
\begin{equation}
\operatorname*{st}\left(  \alpha\left(  \chi\right)  \right)
=\operatorname*{st}\left(  \chi\right)  . \label{pf.thm.dendri.K.ideal.alpha}%
\end{equation}
Consider this $\alpha$. Clearly, each $\chi\in S_{\prec}\left(  \varphi
,\sigma\right)  $ satisfies%
\[
\left(  \chi\text{ and }\alpha\left(  \chi\right)  \text{ are }%
\operatorname*{st}\text{-equivalent}\right)
\]
(because of (\ref{pf.thm.dendri.K.ideal.alpha}) and since $\left\vert
\chi\right\vert =\left\vert \varphi\right\vert +\left\vert \sigma\right\vert
=\left\vert \alpha\left(  \chi\right)  \right\vert $) and therefore%
\[
\left(  \operatorname*{Comp}\chi\text{ and }\operatorname*{Comp}\left(
\alpha\left(  \chi\right)  \right)  \text{ are }\operatorname*{st}%
\text{-equivalent}\right)
\]
(since $\operatorname*{st}$ is a descent statistic) and thus
$F_{\operatorname*{Comp}\chi}-F_{\operatorname*{Comp}\left(  \alpha\left(
\chi\right)  \right)  }\in\mathcal{K}_{\operatorname*{st}}$ (by the definition
of $\mathcal{K}_{\operatorname*{st}}$) and therefore%
\begin{equation}
F_{\operatorname*{Comp}\chi}\equiv F_{\operatorname*{Comp}\left(
\alpha\left(  \chi\right)  \right)  }\operatorname{mod}\mathcal{K}%
_{\operatorname*{st}}. \label{pf.thm.dendri.K.ideal.alphaeq}%
\end{equation}


The first claim of Corollary \ref{cor.dendri.4.1} yields%
\begin{align*}
F_{\operatorname*{Comp}\varphi}\left.  \prec\right.  F_{\operatorname*{Comp}%
\sigma}  &  =\sum_{\chi\in S_{\prec}\left(  \varphi,\sigma\right)
}F_{\operatorname*{Comp}\chi}\ \ \ \ \ \ \ \ \ \ \text{and}\\
F_{\operatorname*{Comp}\psi}\left.  \prec\right.  F_{\operatorname*{Comp}%
\sigma}  &  =\sum_{\chi\in S_{\prec}\left(  \psi,\sigma\right)  }%
F_{\operatorname*{Comp}\chi}.
\end{align*}
Hence,%
\begin{align*}
F_{\operatorname*{Comp}\varphi}\left.  \prec\right.  F_{\operatorname*{Comp}%
\sigma}  &  =\sum_{\chi\in S_{\prec}\left(  \varphi,\sigma\right)
}\underbrace{F_{\operatorname*{Comp}\chi}}_{\substack{\equiv
F_{\operatorname*{Comp}\left(  \alpha\left(  \chi\right)  \right)
}\operatorname{mod}\mathcal{K}_{\operatorname*{st}}\\\text{(by
(\ref{pf.thm.dendri.K.ideal.alphaeq}))}}}\equiv\sum_{\chi\in S_{\prec}\left(
\varphi,\sigma\right)  }F_{\operatorname*{Comp}\left(  \alpha\left(
\chi\right)  \right)  }\\
&  =\sum_{\chi\in S_{\prec}\left(  \psi,\sigma\right)  }%
F_{\operatorname*{Comp}\chi}\\
&  \ \ \ \ \ \ \ \ \ \ \left(
\begin{array}
[c]{c}%
\text{here, we have substituted }\chi\text{ for }\alpha\left(  \chi\right)
\text{ in the sum,}\\
\text{since the map }\alpha:S_{\prec}\left(  \varphi,\sigma\right)
\rightarrow S_{\prec}\left(  \psi,\sigma\right)  \text{ is a bijection}%
\end{array}
\right) \\
&  =F_{\operatorname*{Comp}\psi}\left.  \prec\right.  F_{\operatorname*{Comp}%
\sigma}\operatorname{mod}\mathcal{K}_{\operatorname*{st}}.
\end{align*}
Since $\operatorname*{Comp}\varphi=J$, $\operatorname*{Comp}\psi=K$ and
$\operatorname*{Comp}\sigma=L$ (by the definition of $\varphi$, $\psi$ and
$\sigma$), this rewrites as $F_{J}\left.  \prec\right.  F_{L}\equiv
F_{K}\left.  \prec\right.  F_{L}\operatorname{mod}\mathcal{K}%
_{\operatorname*{st}}$. In other words, $F_{J}\left.  \prec\right.
F_{L}-F_{K}\left.  \prec\right.  F_{L}\in\mathcal{K}_{\operatorname*{st}}$. In
other words, $\left(  F_{J}-F_{K}\right)  \left.  \prec\right.  F_{L}%
\in\mathcal{K}_{\operatorname*{st}}$. This proves the first claim of
(\ref{pf.thm.dendri.K.ideal.two-incs}). The second is proven similarly.
Altogether, we thus conclude that $\mathcal{K}_{\operatorname*{st}}$ is a
$\left.  \prec\right.  $-ideal of $\operatorname*{QSym}$. In other words,
Statement C holds. This proves the implication B$\Longrightarrow$C.

\textit{Proof of the implication C}$\Longrightarrow$\textit{A:} Assume that
Statement C holds. Thus, the set $\mathcal{K}_{\operatorname*{st}}$ is an
$\left.  \prec\right.  $-ideal of $\operatorname*{QSym}$.

Let $X$ be the codomain of the map $\operatorname*{st}$. Let $\mathbb{Q}%
\left[  X\right]  $ be the free $\mathbb{Q}$-vector space with basis $\left(
\left[  x\right]  \right)  _{x\in X}$. Then, we can define a $\mathbb{Q}%
$-linear map $\mathbf{st}:\operatorname*{QSym}\rightarrow\mathbb{Q}\left[
X\right]  ,\ F_{J}\mapsto\left[  \operatorname*{st}J\right]  $. This map
$\mathbf{st}$ sends each of the generators of $\mathcal{K}_{\operatorname*{st}%
}$ to $0$ (by the definition of $\mathcal{K}_{\operatorname*{st}}$), and
therefore sends the whole $\mathcal{K}_{\operatorname*{st}}$ to $0$. In other
words, $\mathbf{st}\left(  \mathcal{K}_{\operatorname*{st}}\right)  =0$.

Now, consider any two disjoint nonempty permutations $\pi$ and $\sigma$ having
the property that%
\[
\text{the first entry of }\pi\text{ is greater than the first entry of }%
\sigma.
\]
Also, consider two further disjoint nonempty permutations $\pi^{\prime}$ and
$\sigma^{\prime}$ having the property that
\[
\text{the first entry of }\pi^{\prime}\text{ is greater than the first entry
of }\sigma^{\prime}%
\]
and satisfying $\operatorname*{st}\left(  \pi\right)  =\operatorname*{st}%
\left(  \pi^{\prime}\right)  $, $\operatorname*{st}\left(  \sigma\right)
=\operatorname*{st}\left(  \sigma^{\prime}\right)  $, $\left\vert
\pi\right\vert =\left\vert \pi^{\prime}\right\vert $ and $\left\vert
\sigma\right\vert =\left\vert \sigma^{\prime}\right\vert $. We shall show that
$\left\{  \operatorname*{st}\left(  \tau\right)  \ \mid\ \tau\in S_{\prec
}\left(  \pi,\sigma\right)  \right\}  =\left\{  \operatorname*{st}\left(
\tau\right)  \ \mid\ \tau\in S_{\prec}\left(  \pi^{\prime},\sigma^{\prime
}\right)  \right\}  $ as multisets. This will show that the multiset $\left\{
\operatorname*{st}\left(  \tau\right)  \ \mid\ \tau\in S_{\prec}\left(
\pi,\sigma\right)  \right\}  $ depends only on $\operatorname*{st}\left(
\pi\right)  $, $\operatorname*{st}\left(  \sigma\right)  $, $\left\vert
\pi\right\vert $ and $\left\vert \sigma\right\vert $.

From $\operatorname*{st}\left(  \pi\right)  =\operatorname*{st}\left(
\pi^{\prime}\right)  $ and $\left\vert \pi\right\vert =\left\vert \pi^{\prime
}\right\vert $, we conclude that $\pi$ and $\pi^{\prime}$ are
$\operatorname*{st}$-equivalent. In other words, $\operatorname*{Comp}\pi$ and
$\operatorname*{Comp}\left(  \pi^{\prime}\right)  $ are $\operatorname*{st}%
$-equivalent. Hence, $F_{\operatorname*{Comp}\pi}-F_{\operatorname*{Comp}%
\left(  \pi^{\prime}\right)  }\in\mathcal{K}_{\operatorname*{st}}$ (by the
definition of $\mathcal{K}_{\operatorname*{st}}$), so that
$F_{\operatorname*{Comp}\pi}\equiv F_{\operatorname*{Comp}\left(  \pi^{\prime
}\right)  }\operatorname{mod}\mathcal{K}_{\operatorname*{st}}$. Similarly,
$F_{\operatorname*{Comp}\sigma}\equiv F_{\operatorname*{Comp}\left(
\sigma^{\prime}\right)  }\operatorname{mod}\mathcal{K}_{\operatorname*{st}}$.
These two congruences, combined, yield $F_{\operatorname*{Comp}\pi}\left.
\prec\right.  F_{\operatorname*{Comp}\sigma}\equiv F_{\operatorname*{Comp}%
\left(  \pi^{\prime}\right)  }\left.  \prec\right.  F_{\operatorname*{Comp}%
\left(  \sigma^{\prime}\right)  }\operatorname{mod}\mathcal{K}%
_{\operatorname*{st}}$. (Indeed, we can conclude $a\left.  \prec\right.
c\equiv b\left.  \prec\right.  d\operatorname{mod}\mathcal{K}%
_{\operatorname*{st}}$ whenever we have $a\equiv b\operatorname{mod}%
\mathcal{K}_{\operatorname*{st}}$ and $c\equiv d\operatorname{mod}%
\mathcal{K}_{\operatorname*{st}}$; this is because we know that $\mathcal{K}%
_{\operatorname*{st}}$ is a $\left.  \prec\right.  $-ideal of
$\operatorname*{QSym}$.)

From $F_{\operatorname*{Comp}\pi}\left.  \prec\right.  F_{\operatorname*{Comp}%
\sigma}\equiv F_{\operatorname*{Comp}\left(  \pi^{\prime}\right)  }\left.
\prec\right.  F_{\operatorname*{Comp}\left(  \sigma^{\prime}\right)
}\operatorname{mod}\mathcal{K}_{\operatorname*{st}}$, we obtain%
\begin{equation}
\mathbf{st}\left(  F_{\operatorname*{Comp}\pi}\left.  \prec\right.
F_{\operatorname*{Comp}\sigma}\right)  =\mathbf{st}\left(
F_{\operatorname*{Comp}\left(  \pi^{\prime}\right)  }\left.  \prec\right.
F_{\operatorname*{Comp}\left(  \sigma^{\prime}\right)  }\right)
\label{pf.thm.dendri.K.ideal.steq}%
\end{equation}
(since $\mathbf{st}\left(  \mathcal{K}_{\operatorname*{st}}\right)  =0$).

The first claim of Corollary \ref{cor.dendri.4.1} yields%
\[
F_{\operatorname*{Comp}\pi}\left.  \prec\right.  F_{\operatorname*{Comp}%
\sigma}=\sum_{\chi\in S_{\prec}\left(  \pi,\sigma\right)  }%
F_{\operatorname*{Comp}\chi}.
\]
Applying the map $\mathbf{st}$ to both sides of this equality, we find%
\begin{align*}
\mathbf{st}\left(  F_{\operatorname*{Comp}\pi}\left.  \prec\right.
F_{\operatorname*{Comp}\sigma}\right)   &  =\mathbf{st}\left(  \sum_{\chi\in
S_{\prec}\left(  \pi,\sigma\right)  }F_{\operatorname*{Comp}\chi}\right) \\
&  =\sum_{\chi\in S_{\prec}\left(  \pi,\sigma\right)  }\underbrace{\mathbf{st}%
\left(  F_{\operatorname*{Comp}\chi}\right)  }_{=\left[  \operatorname*{st}%
\left(  \operatorname*{Comp}\chi\right)  \right]  =\left[  \operatorname*{st}%
\chi\right]  }=\sum_{\chi\in S_{\prec}\left(  \pi,\sigma\right)  }\left[
\operatorname*{st}\chi\right]  .
\end{align*}
Similarly,%
\[
\mathbf{st}\left(  F_{\operatorname*{Comp}\left(  \pi^{\prime}\right)
}\left.  \prec\right.  F_{\operatorname*{Comp}\left(  \sigma^{\prime}\right)
}\right)  =\sum_{\chi\in S_{\prec}\left(  \pi^{\prime},\sigma^{\prime}\right)
}\left[  \operatorname*{st}\chi\right]  .
\]
But the left-hand sides of the last two equalities are equal (because of
(\ref{pf.thm.dendri.K.ideal.steq})); therefore, the right-hand sides must be
equal as well. In other words,
\[
\sum_{\chi\in S_{\prec}\left(  \pi,\sigma\right)  }\left[  \operatorname*{st}%
\chi\right]  =\sum_{\chi\in S_{\prec}\left(  \pi^{\prime},\sigma^{\prime
}\right)  }\left[  \operatorname*{st}\chi\right]  .
\]
This shows exactly that $\left\{  \operatorname*{st}\left(  \chi\right)
\ \mid\ \chi\in S_{\prec}\left(  \pi,\sigma\right)  \right\}  =\left\{
\operatorname*{st}\left(  \chi\right)  \ \mid\ \chi\in S_{\prec}\left(
\pi^{\prime},\sigma^{\prime}\right)  \right\}  $ as multisets. In other words,
$\left\{  \operatorname*{st}\left(  \tau\right)  \ \mid\ \tau\in S_{\prec
}\left(  \pi,\sigma\right)  \right\}  =\left\{  \operatorname*{st}\left(
\tau\right)  \ \mid\ \tau\in S_{\prec}\left(  \pi^{\prime},\sigma^{\prime
}\right)  \right\}  $ as multisets. Thus, we have proven that the multiset
$\left\{  \operatorname*{st}\left(  \tau\right)  \ \mid\ \tau\in S_{\prec
}\left(  \pi,\sigma\right)  \right\}  $ depends only on $\operatorname*{st}%
\left(  \pi\right)  $, $\operatorname*{st}\left(  \sigma\right)  $,
$\left\vert \pi\right\vert $ and $\left\vert \sigma\right\vert $. Hence, the
statistic $\operatorname*{st}$ is left-shuffle-compatible. In other words,
Statement A holds. This proves the implication C$\Longrightarrow$A.

Now that we have proven all three implications A$\Longrightarrow$B,
B$\Longrightarrow$C and C$\Longrightarrow$A, the proof of Theorem
\ref{thm.dendri.K.ideal} is complete.
\end{proof}

\begin{proof}
[Proof of Theorem \ref{thm.dendri.K.ideal-R}.]The proof of Theorem
\ref{thm.dendri.K.ideal-R} is analogous to the above proof of Theorem
\ref{thm.dendri.K.ideal}.
\end{proof}

As a consequence of the above two theorems, we can see that any descent
statistic that is weakly left-shuffle-compatible and weakly
right-shuffle-compatible must automatically be
shuffle-compatible\footnote{\textit{Proof.} Let $\operatorname*{st}$ be a
descent statistic that is weakly left-shuffle-compatible and weakly
right-shuffle-compatible. We must prove that $\operatorname*{st}$ is
shuffle-compatible.
\par
The implication B$\Longrightarrow$C in Theorem \ref{thm.dendri.K.ideal} shows
that the set $\mathcal{K}_{\operatorname*{st}}$ is an $\left.  \prec\right.
$-ideal of $\operatorname*{QSym}$. Similarly, the set $\mathcal{K}%
_{\operatorname*{st}}$ is an $\left.  \succeq\right.  $-ideal of
$\operatorname*{QSym}$. Hence, Proposition \ref{prop.ideal-crit3} (applied to
$M=\mathcal{K}_{\operatorname*{st}}$) yields that $\mathcal{K}%
_{\operatorname*{st}}$ is an ideal of $\operatorname*{QSym}$. By Proposition
\ref{prop.K.ideal}, this shows that $\operatorname*{st}$ is
shuffle-compatible.}. Note that this is only true for descent statistics! As
far as arbitrary permutation statistics are concerned, this is false; for
example, the number of inversions is weakly left-shuffle-compatible and weakly
right-shuffle-compatible but not shuffle-compatible.

On the other hand, every permutation statistic that is left-shuffle-compatible
and right-shuffle-compatible must automatically be shuffle-compatible (whether
or not it is a descent statistic). This follows from a careful look at the
definitions of \textquotedblleft left-shuffle-compatible\textquotedblright%
\ and \textquotedblleft right-shuffle-compatible\textquotedblright\ and the
observation that $S_{\prec}\left(  \pi,\sigma\right)  =S_{\succ}\left(
\sigma,\pi\right)  $ and $S_{\succ}\left(  \pi,\sigma\right)  =S_{\prec
}\left(  \sigma,\pi\right)  $ for any two disjoint permutations $\pi$ and
$\sigma$.

\begin{corollary}
\label{cor.dendri.Epk}The descent statistic $\operatorname*{Epk}$ is
left-shuffle-compatible and right-shuffle-compatible.
\end{corollary}

\begin{proof}
[Proof of Corollary \ref{cor.dendri.Epk}.]To prove that $\operatorname*{Epk}$
is left-shuffle-compatible, combine Theorem \ref{thm.dendri.K.ideal} with
Theorem \ref{thm.Epk.dend}. Similarly for right-shuffle-compatibility.
\end{proof}

Using Theorem \ref{thm.dendri.4.1}, we can try to state an analogue of Theorem
\ref{thm.4.3} \textbf{(a)}. Let us first define the notion of dendriform algebras:

\begin{definition}
\textbf{(a)} A \textit{dendriform algebra} over a field $\mathbf{k}$ means a
$\mathbf{k}$-algebra $A$ equipped with two further $\mathbf{k}$-bilinear
binary operations $\left.  \prec\right.  $ and $\left.  \succeq\right.  $
(these are operations, not relations, despite the symbols) from $A\times A$ to
$A$ that satisfy the four rules%
\begin{align*}
a\left.  \prec\right.  b+a\left.  \succeq\right.  b  &  =ab;\\
\left(  a\left.  \prec\right.  b\right)  \left.  \prec\right.  c  &  =a\left.
\prec\right.  \left(  bc\right)  ;\\
\left(  a\left.  \succeq\right.  b\right)  \left.  \prec\right.  c  &
=a\left.  \succeq\right.  \left(  b\left.  \prec\right.  c\right)  ;\\
a\left.  \succeq\right.  \left(  b\left.  \succeq\right.  c\right)   &
=\left(  ab\right)  \left.  \succeq\right.  c
\end{align*}
for all $a,b,c\in A$. (Depending on the situation, it is useful to also impose
a few axioms that relate the unity $1$ of the $\mathbf{k}$-algebra $A$ with
the operations $\left.  \prec\right.  $ and $\left.  \succeq\right.  $. For
example, we could require $1\left.  \prec\right.  a=a$ for each $a\in A$. For
what we are going to do in the following, it does not matter whether we make
this requirement.)

\textbf{(b)} If $A$ and $B$ are two dendriform algebras over $\mathbf{k}$,
then a \textit{dendriform algebra homomorphism} from $A$ to $B$ means a
$\mathbf{k}$-algebra homomorphism $\phi:A\rightarrow B$ preserving the
operations $\left.  \prec\right.  $ and $\left.  \succeq\right.  $ (that is,
satisfying $\phi\left(  a\left.  \prec\right.  b\right)  =\phi\left(
a\right)  \left.  \prec\right.  \phi\left(  b\right)  $ and $\phi\left(
a\left.  \succeq\right.  b\right)  =\phi\left(  a\right)  \left.
\succeq\right.  \phi\left(  b\right)  $ for all $a,b\in A$). (Some authors
only require it to be a $\mathbf{k}$-linear map instead of being a
$\mathbf{k}$-algebra homomorphism; this boils down to the question whether
$\phi\left(  1\right)  $ must be $1$ or not. This does not make a difference
for us here.)
\end{definition}

Of course, $\operatorname*{QSym}$ (with its two operations $\left.
\prec\right.  $ and $\left.  \succeq\right.  $) thus becomes a dendriform
algebra over $\mathbb{Q}$.

Notice that if $A$ and $B$ are two dendriform algebras over $\mathbf{k}$, then
the kernel of any dendriform algebra homomorphism $A\rightarrow B$ is an
$\left.  \prec\right.  $-ideal and a $\left.  \succeq\right.  $-ideal of $A$.
Conversely, if $A$ is a dendriform algebra over $\mathbf{k}$, and $I$ is
simultaneously an $\left.  \prec\right.  $-ideal and a $\left.  \succeq
\right.  $-ideal of $A$, then $A/I$ canonically becomes a dendriform algebra,
and the canonical projection $A\rightarrow A/I$ becomes a dendriform algebra homomorphism.

Therefore, Theorem \ref{thm.dendri.K.ideal} (and the $\mathcal{A}%
_{\operatorname*{st}}\cong\operatorname*{QSym}/\mathcal{K}_{\operatorname*{st}%
}$ isomorphism from Proposition \ref{prop.K.ideal}) yields the following:

\begin{corollary}
\label{cor.dendri.quotient-dendri}If a descent statistic $\operatorname*{st}$
is left-shuffle-compatible and right-shuffle-compatible, then its shuffle
algebra $\mathcal{A}_{\operatorname*{st}}$ canonically becomes a dendriform algebra.
\end{corollary}

We furthermore have the following analogue of Theorem~\ref{thm.4.3}
\textbf{(a)}, which easily follows from Theorem \ref{thm.dendri.K.ideal}:

\begin{theorem}
\label{thm.dendri.4.3}Let $\operatorname*{st}$ be a descent statistic.

\textbf{(a)} The descent statistic $\operatorname*{st}$ is
left-shuffle-compatible and right-shuffle-compatible if and only if there
exists a homomorphism $\phi_{\operatorname*{st}}:\operatorname*{QSym}%
\rightarrow A$ of dendriform algebras, where $A$ is a dendriform algebra with
basis $\left(  u_{\alpha}\right)  $ indexed by $\operatorname*{st}%
$-equivalence classes $\alpha$ of compositions, such that $\phi
_{\operatorname*{st}}\left(  F_{L}\right)  =u_{\alpha}$ whenever $L\in\alpha$.

\textbf{(b)} In this case, the $\mathbb{Q}$-linear map $\mathcal{A}%
_{\operatorname*{st}}\rightarrow A$ given by%
\[
\left[  \pi\right]  _{\operatorname*{st}}\mapsto u_{\alpha}=\phi
_{\operatorname*{st}}\left(  F_{\operatorname*{Comp}\left(  \pi\right)
}\right)  \ \ \ \ \ \ \ \ \ \ \text{where }\operatorname*{Comp}\left(
\pi\right)  =\alpha
\]
is an isomorphism of dendriform algebras.
\end{theorem}

\begin{question}
Can the $\mathbb{Q}$-algebra $\operatorname*{Pow}\mathcal{N}$ from Definition
\ref{def.GammaZ} be endowed with two binary operations $\left.  \prec\right.
$ and $\left.  \succeq\right.  $ that make it into a dendriform algebra? Can
we then find an analogue of Proposition \ref{prop.prod1} along the following lines?

Let $\left(  P,\gamma\right)  $, $\left(  Q,\delta\right)  $ and $\left(
P\sqcup Q,\varepsilon\right)  $ be as in Proposition \ref{prop.prod1}. Assume
that each of the posets $P$ and $Q$ has a minimum element; denote these
elements by $\min P$ and $\min Q$, respectively. Define two posets $P\left.
\prec\right.  Q$ and $P\left.  \succeq\right.  Q$ as in Proposition
\ref{prop.dendri.4.1.lem}. Then, we hope to have%
\begin{align*}
\Gamma_{\mathcal{Z}}\left(  P,\gamma\right)  \left.  \prec\right.
\Gamma_{\mathcal{Z}}\left(  Q,\delta\right)   &  =\Gamma_{\mathcal{Z}}\left(
P\left.  \prec\right.  Q,\varepsilon\right)  \ \ \ \ \ \ \ \ \ \ \text{and}\\
\Gamma_{\mathcal{Z}}\left(  P,\gamma\right)  \left.  \succeq\right.
\Gamma_{\mathcal{Z}}\left(  Q,\delta\right)   &  =\Gamma_{\mathcal{Z}}\left(
P\left.  \succ\right.  Q,\varepsilon\right)  .
\end{align*}


Ideally, this would be a generalization of Proposition
\ref{prop.dendri.4.1.lem}.
\end{question}

We have so far studied the combinatorial significance of when the kernel
$\mathcal{K}_{\operatorname*{st}}$ of a statistic $\operatorname*{st}$ is a
$\left.  \prec\right.  $-ideal or a $\left.  \succeq\right.  $-ideal of
$\operatorname*{QSym}$. What about $\bel$-ideals and $\tvi$-ideals? It turns
out that the answer to this question is easily given (on the level of
compositions) by the following (easily verified) proposition:

\begin{proposition}
\label{prop.bel-tvi-comp}Let $\operatorname*{st}$ be a descent statistic.

\textbf{(a)} The set $\mathcal{K}_{\operatorname*{st}}$ is a left $\bel$-ideal
of $\operatorname*{QSym}$ if and only if $\operatorname*{st}$ has the
following property: If $J$ and $K$ are two $\operatorname*{st}$-equivalent
nonempty compositions, and if $G$ is any nonempty composition, then $G\odot J$
and $G\odot K$ are $\operatorname*{st}$-equivalent.

\textbf{(b)} The set $\mathcal{K}_{\operatorname*{st}}$ is a right
$\bel$-ideal of $\operatorname*{QSym}$ if and only if $\operatorname*{st}$ has
the following property: If $J$ and $K$ are two $\operatorname*{st}$-equivalent
nonempty compositions, and if $G$ is any nonempty composition, then $J\odot G$
and $K\odot G$ are $\operatorname*{st}$-equivalent.

\textbf{(c)} The set $\mathcal{K}_{\operatorname*{st}}$ is a left $\tvi$-ideal
of $\operatorname*{QSym}$ if and only if $\operatorname*{st}$ has the
following property: If $J$ and $K$ are two $\operatorname*{st}$-equivalent
nonempty compositions, and if $G$ is any nonempty composition, then $\left[
G,J\right]  $ and $\left[  G,K\right]  $ are $\operatorname*{st}$-equivalent.

\textbf{(d)} The set $\mathcal{K}_{\operatorname*{st}}$ is a right
$\tvi$-ideal of $\operatorname*{QSym}$ if and only if $\operatorname*{st}$ has
the following property: If $J$ and $K$ are two $\operatorname*{st}$-equivalent
nonempty compositions, and if $G$ is any nonempty composition, then $\left[
J,G\right]  $ and $\left[  K,G\right]  $ are $\operatorname*{st}$-equivalent.
\end{proposition}

\begin{noncompile}
\textbf{[From here on, everything is scratch work and speculation!]}

In preparation for things to come, we shall restate Theorem \ref{thm.beldend}
and Theorem \ref{thm.tvidend'} using a slight variation on the
comultiplication map $\Delta$:

\begin{theorem}
\label{thm.beldend.Del'}Let $S$ denote the antipode of the Hopf algebra
$\operatorname*{QSym}$. Let us use the Sweedler-like notation $\sum_{\left(
b\right)  }b_{\left[  1\right]  }\otimes b_{\left[  2\right]  }$ for
$\Delta\left(  b\right)  -1\otimes b$, where $b$ is any element of
$\operatorname*{QSym}$. Then,%
\[
\sum_{\left(  b\right)  }\left(  S\left(  b_{\left[  1\right]  }\right)
\bel
a\right)  b_{\left[  2\right]  }=-a\mathfrak{\left.  \succeq\right.  }b
\]
for any $a\in\mathbf{k}\left[  \left[  x_{1},x_{2},x_{3},\ldots\right]
\right]  $ and $b\in\operatorname*{QSym}$.
\end{theorem}

\begin{theorem}
\label{thm.tvidend'.Del'}Let $S$ denote the antipode of the Hopf algebra
$\operatorname*{QSym}$. Let us use the Sweedler-like notation $\sum_{\left(
b\right)  }b_{\left[  1\right]  }\otimes b_{\left[  2\right]  }$ for
$\Delta\left(  b\right)  -1\otimes b$, where $b$ is any element of
$\operatorname*{QSym}$. Then,%
\[
\sum_{\left(  b\right)  }\left(  S\left(  b_{\left[  1\right]  }\right)
\tvi
a\right)  b_{\left[  2\right]  }=-b\left.  \prec\right.  a
\]
for any $a\in\mathbf{k}\left[  \left[  x_{1},x_{2},x_{3},\ldots\right]
\right]  $ and $b\in\operatorname*{QSym}$.
\end{theorem}

\begin{proof}
[Proof of Theorem \ref{thm.beldend.Del'}.]Let us use Sweedler's notation, too.
From $\sum_{\left(  b\right)  }b_{\left[  1\right]  }\otimes b_{\left[
2\right]  }=\Delta\left(  b\right)  -1\otimes b=\sum_{\left(  b\right)
}b_{\left(  1\right)  }\otimes b_{\left(  2\right)  }-1\otimes b$, we have%
\begin{align*}
\sum_{\left(  b\right)  }\left(  S\left(  b_{\left[  1\right]  }\right)
\bel a\right)  b_{\left[  2\right]  }  &  =\underbrace{\sum_{\left(  b\right)
}\left(  S\left(  b_{\left(  1\right)  }\right)  \bel a\right)  b_{\left(
2\right)  }}_{\substack{=a\left.  \prec\right.  b\\\text{(by Theorem
\ref{thm.beldend})}}}-\underbrace{\left(  1\bel a\right)  }_{=a}b\\
&  =a\left.  \prec\right.  b-ab=-a\left.  \succeq\right.  b
\end{align*}
(since $a\left.  \prec\right.  b+a\left.  \succeq\right.  b=ab$). This proves
Theorem \ref{thm.beldend.Del'}.
\end{proof}

\begin{proof}
[Proof of Theorem \ref{thm.tvidend'.Del'}.]Analogous.
\end{proof}

Here is an old stub of a theorem that I don't know how to correct:

\begin{theorem}
\label{thm.ideal-crit1}Let $M$ be a $\mathbf{k}$-submodule of
$\operatorname*{QSym}$. Assume that $M$ is a left $\tvi$-ideal and a right
$\bel$-ideal of $\operatorname*{QSym}$.

I wanted to claim that $M$ is an ideal of $\operatorname*{QSym}$. But this is
not always correct. Maybe adding the condition $S\left(  M\right)  \subseteq
M$ would help?
\end{theorem}

\begin{proof}
[Proof of Theorem \ref{thm.ideal-crit1}.]Set $A=\operatorname*{QSym}$. We have
$A\tvi M\subseteq M$ (since $M$ is a left $\tvi$-ideal) and $M\bel A\subseteq
M$ (since $M$ is a right $\bel$-ideal).

Recall that $A=\operatorname*{QSym}$ is a graded $\mathbf{k}$-algebra. For
each $n\in\mathbb{N}$, let $A_{n}$ be its $n$-th graded component.

We now claim the following:

\textit{Claim 1:} We have $A_{n}M\subseteq M$

...
\end{proof}
\end{noncompile}

\subsection{$\left(  \operatorname*{Epk},\operatorname*{des}\right)  $ aka
$\left(  \operatorname*{Lpk},\operatorname*{val},\operatorname*{des}\right)  $
(speculations)}

Let us finish with a speculative remark regarding the statistics
$\operatorname*{des}$ and $\operatorname*{val}$ and the compound statistics
$\left(  \operatorname*{Epk},\operatorname*{des}\right)  $ and $\left(
\operatorname*{Lpk},\operatorname*{val},\operatorname*{des}\right)  $
introduced in \cite{part1}.

I suspect the arguments used to prove Theorem \ref{thm.Epk.sh-co} can also be
tweaked to prove the shuffle-compatibility of the descent statistic $\left(
\operatorname*{Epk},\operatorname*{des}\right)  $ (and thus also of the
equivalent descent statistic $\left(  \operatorname*{Lpk},\operatorname*{val}%
,\operatorname*{des}\right)  $). The main change should be to replace
$x_{\left\vert f\left(  p\right)  \right\vert }$ (wherever it appears) by%
\[%
\begin{cases}
x_{\left\vert f\left(  p\right)  \right\vert }, & \text{if }f\left(  p\right)
=\left(  h,+\right)  \text{ for some }h\in\mathcal{N};\\
x_{\left\vert f\left(  p\right)  \right\vert }t, & \text{if }f\left(
p\right)  =\left(  h,-\right)  \text{ for some }h\in\mathcal{N}%
\end{cases}
,
\]
where $t$ is some new indeterminate. I am not saying this will definitely
work, but it sounds plausible.

\begin{thebibliography}{99999999}                                                                                         %


\bibitem[GesZhu17]{part1}\href{http://arxiv.org/abs/1706.00750v1}{Ira M.
Gessel, Yan Zhuang, \textit{Shuffle-compatible permutation statistics},
arXiv:1706.00750v1}.

\bibitem[Grinbe16]{dimcr}Darij Grinberg, \textit{Dual immaculate creation
operators and a dendriform algebra structure on the quasisymmetric functions},
version 6, \href{https://arxiv.org/abs/1410.0079v6}{arXiv:1410.0079v6}.
(Version 5 has been published in:
\href{https://cms.math.ca/10.4153/CJM-2016-018-8?abfmt=ltx}{Canad. J. Math.
\textbf{69} (2017), 21--53}.)

\bibitem[GriRei17]{HopfComb}Darij Grinberg, Victor Reiner, \textit{Hopf
algebras in Combinatorics}, version of 27 July 2017. \newline%
\url{http://www.cip.ifi.lmu.de/~grinberg/algebra/HopfComb-sols.pdf} .

\bibitem[HsiPet10]{HsiPet10}Samuel K. Hsiao, T. Kyle Petersen, \textit{Colored
Posets and Colored Quasisymmetric Functions}, Ann. Comb. 14 (2010), pp.
251--289,\newline\url{https://doi.org/10.1007/s00026-010-0059-0} . See
\href{http://www.arxiv.org/abs/math/0610984v1}{\texttt{arXiv:math/0610984v1}}
for a preprint.

\bibitem[Peters05]{Peters05}T. Kyle Petersen, \textit{Enriched }$\mathit{P}%
$\textit{-partitions and peak algebras}, Advances in Mathematics 209 (2007),
pp. 561--610,\newline\url{https://doi.org/10.1016/j.aim.2006.05.016} . See
\texttt{\href{https://arxiv.org/abs/math/0508041v1}{arXiv:math/0508041v1}} for
a preprint.

\bibitem[SageMath]{SageMath}\href{http://www.sagemath.org}{The Sage
Developers, \textit{SageMath, the Sage Mathematics Software System (Version
8.0)}, 2017.}

\bibitem[Stanle72]{Stanle72}Richard P. Stanley, \textit{Ordered Structures and
Partitions}, Memoirs of the American Mathematical Society, No. 119, American
Mathematical Society, Providence, R.I., 1972. \newline\url{http://www-math.mit.edu/~rstan/pubs/pubfiles/9.pdf}

\bibitem[Stembr97]{Stembr97}%
\href{http://www.ams.org/journals/tran/1997-349-02/S0002-9947-97-01804-7/}{John
R. Stembridge, \textit{Enriched P-partitions}, Trans. Amer. Math. Soc.
\textbf{349} (1997), no. 2, pp. 763--788}.
\end{thebibliography}


\end{document}